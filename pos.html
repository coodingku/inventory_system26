<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>POS System - Kasir Mandiri</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; background: #f0f2f5; }
        .sidebar { width: 300px; background: white; padding: 20px; height: 100vh; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .main { flex: 1; padding: 20px; }
        .cart-table { width: 100%; background: white; border-collapse: collapse; border-radius: 8px; overflow: hidden; }
        .cart-table th, .cart-table td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
        .total-section { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: right; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-pay { background: #27ae60; color: white; padding: 15px; width: 100%; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>ðŸ”‘ Identitas Kasir</h3>
    <input type="text" id="nik-kasir" placeholder="Masukkan NIK Staff...">
    <div id="info-staff" style="margin-bottom: 20px; color: #666; font-size: 14px;"></div>
    
    <hr>
    <h3>ðŸ›’ Input Barang</h3>
    <input type="text" id="kode-barang" placeholder="Scan / Ketik Kode Barang..." onkeypress="handleKey(event)">
    <p style="font-size: 12px; color: #888;">Tekan Enter untuk tambah ke keranjang</p>
</div>

<div class="main">
    <h2>Keranjang Belanja</h2>
    <table class="cart-table">
        <thead>
            <tr>
                <th>Barang</th>
                <th>Harga</th>
                <th>Qty</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody id="cart-items">
            </tbody>
    </table>

    <div class="total-section">
        <span style="font-size: 18px;">Total Bayar:</span>
        <h1 id="grand-total">Rp 0</h1>
        <button class="btn-pay" onclick="prosesBayar()">ðŸ’µ PROSES BAYAR</button>
    </div>
</div>

<script>
    const SB_URL = 'MASUKKAN_URL_SUPABASE_ANDA';
    const SB_KEY = 'MASUKKAN_ANON_KEY_ANDA';
    const supabase = window.supabase.createClient(SB_URL, SB_KEY);

    let keranjang = [];

    // 1. Fungsi Validasi NIK Otomatis
    document.getElementById('nik-kasir').addEventListener('change', async (e) => {
        const { data, error } = await supabase
            .from('staff')
            .select('nama, divisi')
            .eq('nik', e.target.value)
            .single();
        
        if (data) {
            document.getElementById('info-staff').innerHTML = `Kasir: <b>${data.nama}</b> (${data.divisi})`;
        } else {
            alert("NIK Staff tidak ditemukan!");
            e.target.value = '';
        }
    });

    // 2. Tambah Barang ke Keranjang
    async function handleKey(e) {
        if (e.key === 'Enter') {
            const kode = e.target.value;
            const { data, error } = await supabase
                .from('inventory')
                .select('*')
                .eq('kode_barang', kode)
                .single();

            if (data) {
                if (data.stok_sekarang <= 0) return alert("Stok Habis!");
                
                const index = keranjang.findIndex(item => item.id === data.id);
                if (index > -1) {
                    keranjang[index].qty++;
                } else {
                    keranjang.push({ ...data, qty: 1 });
                }
                e.target.value = '';
                updateTampilan();
            } else {
                alert("Barang tidak terdaftar!");
            }
        }
    }

    function updateTampilan() {
        const tbody = document.getElementById('cart-items');
        tbody.innerHTML = '';
        let total = 0;

        keranjang.forEach(item => {
            let subtotal = item.harga_jual * item.qty;
            total += subtotal;
            tbody.innerHTML += `
                <tr>
                    <td>${item.nama_barang}</td>
                    <td>Rp ${item.harga_jual.toLocaleString()}</td>
                    <td>${item.qty}</td>
                    <td>Rp ${subtotal.toLocaleString()}</td>
                </tr>
            `;
        });
        document.getElementById('grand-total').innerText = `Rp ${total.toLocaleString()}`;
    }

    // 3. Proses Bayar & Potong Stok
    async function prosesBayar() {
        if (keranjang.length === 0) return alert("Keranjang kosong!");
        const nik = document.getElementById('nik-kasir').value;
        if (!nik) return alert("Masukkan NIK Kasir dulu!");

        for (const item of keranjang) {
            const { error } = await supabase
                .from('inventory')
                .update({ stok_sekarang: item.stok_sekarang - item.qty })
                .eq('id', item.id);
        }

        alert("Pembayaran Berhasil! Stok telah diperbarui.");
        keranjang = [];
        updateTampilan();
    }
</script>
</body>
</html>
