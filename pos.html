<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>POS System | Kasir Profesional</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; background: var(--bg); color: #333; }
        
        /* Sidebar Nav */
        nav { width: 220px; background: var(--primary); color: white; min-height: 100vh; padding: 20px; position: fixed; }
        nav h2 { font-size: 1.2rem; margin-bottom: 30px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        nav a { color: #bdc3c7; text-decoration: none; display: block; padding: 12px; border-radius: 5px; margin-bottom: 5px; transition: 0.3s; }
        nav a:hover { background: #34495e; color: white; }
        nav a.active { background: var(--accent); color: white; }

        /* Main Content */
        main { flex: 1; margin-left: 260px; padding: 30px; display: grid; grid-template-columns: 1fr 400px; gap: 25px; }
        
        /* Area Produk */
        .product-area { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .search-box { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; font-size: 16px; outline: none; transition: 0.3s; }
        .search-box:focus { border-color: var(--accent); }
        .grid-produk { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .item-card { border: 1px solid #eee; padding: 15px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; background: #fff; }
        .item-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--accent); }
        .item-card strong { display: block; margin-bottom: 5px; font-size: 14px; }
        .item-card span { color: var(--success); font-weight: bold; }
        .item-card small { color: #888; display: block; margin-top: 5px; }

        /* Area Billing */
        .billing-area { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: fit-content; position: sticky; top: 30px; }
        .cart-list { min-height: 200px; max-height: 400px; overflow-y: auto; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 0; font-size: 14px; }
        .qty-btn { background: #eee; border: none; padding: 2px 8px; cursor: pointer; border-radius: 4px; }
        
        /* Kalkulasi */
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 10px; color: #666; font-size: 14px; }
        .grand-total { border-top: 2px solid #eee; padding-top: 15px; margin-top: 15px; font-size: 24px; font-weight: bold; display: flex; justify-content: space-between; }
        
        .method-selector { margin: 20px 0; }
        select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd; }
        .btn-pay { width: 100%; padding: 18px; background: var(--success); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-pay:hover { background: #219150; }

        /* Struk - Hidden on Screen */
        #receipt-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { display: block; position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <nav>
        <h2>Kantin POS</h2>
        <a href="index.html">üìä Dashboard</a>
        <a href="produk.html">üì¶ Produk</a>
        <a href="penyesuaian.html">üîÑ Stok In/Out</a>
        <a href="pos.html" class="active">üõí Kasir</a>
        <a href="pengaturan-biaya.html">‚öôÔ∏è Pengaturan</a>
    </nav>

    <main>
        <section class="product-area">
            <input type="text" id="search" class="search-box" placeholder="Cari nama barang..." onkeyup="filterProduk()">
            <div id="daftar-produk" class="grid-produk">
                </div>
        </section>

        <section class="billing-area">
            <h3>Keranjang Belanja</h3>
            <div id="cart-list" class="cart-list">
                <p style="text-align:center; color:#999; margin-top:50px;">Belum ada barang.</p>
            </div>

            <div class="calc-area">
                <div class="calc-row"><span>Subtotal</span><span id="subtotal">Rp 0</span></div>
                <div class="calc-row"><span>Diskon (<span id="txt-diskon">0</span>%)</span><span id="val-diskon">Rp 0</span></div>
                <div class="calc-row"><span>Pajak PPN (<span id="txt-pajak">0</span>%)</span><span id="val-pajak">Rp 0</span></div>
                
                <div class="method-selector">
                    <label style="font-size:12px; font-weight:bold;">Metode Pembayaran:</label>
                    <select id="payment-method">
                        <option value="Tunai">Tunai</option>
                        <option value="Transfer QRIS">Transfer / QRIS</option>
                        <option value="Debit">Kartu Debit</option>
                    </select>
                </div>

                <div class="grand-total">
                    <span>Total</span>
                    <span id="grand-total">Rp 0</span>
                </div>
            </div>

            <button class="btn-pay" onclick="prosesKePembayaran()">LANJUT BAYAR</button>
        </section>
    </main>

    <div id="receipt-area">
        <div style="text-align:center; font-family:monospace; width:300px; margin:auto; padding:20px; border:1px solid #eee;">
            <h3>STRUK BELANJA</h3>
            <p id="r-tgl"></p>
            <hr>
            <div id="r-items" style="text-align:left;"></div>
            <hr>
            <div id="r-calc"></div>
            <p>Terima Kasih Atas Kunjungan Anda</p>
        </div>
    </div>

    <script>
        const SB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
        const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

        let keranjang = [];
        let dataProduk = [];

        async function init() {
            // Load Config Admin
            const pjk = localStorage.getItem('global_pajak') || 0;
            const dsk = localStorage.getItem('global_diskon') || 0;
            document.getElementById('txt-pajak').innerText = pjk;
            document.getElementById('txt-diskon').innerText = dsk;

            // Load Produk
            const { data } = await supabaseClient.from('produk').select('*').order('nama_barang');
            dataProduk = data;
            tampilkanProduk(data);
        }

        function tampilkanProduk(list) {
            const container = document.getElementById('daftar-produk');
            container.innerHTML = '';
            list.forEach(p => {
                container.innerHTML += `
                    <div class="item-card" onclick="masukKeranjang('${p.id}')">
                        <strong>${p.nama_barang}</strong>
                        <span>Rp ${p.harga_jual.toLocaleString()}</span>
                        <small>Stok: ${p.stok_sekarang}</small>
                    </div>`;
            });
        }

        function filterProduk() {
            const keyword = document.getElementById('search').value.toLowerCase();
            const hasil = dataProduk.filter(p => p.nama_barang.toLowerCase().includes(keyword));
            tampilkanProduk(hasil);
        }

        function masukKeranjang(id) {
            const produk = dataProduk.find(p => p.id === id);
            const ada = keranjang.find(k => k.id === id);
            
            if (ada) {
                if (ada.qty < produk.stok_sekarang) ada.qty++;
                else alert("Stok tidak mencukupi!");
            } else {
                if (produk.stok_sekarang > 0) keranjang.push({...produk, qty: 1});
                else alert("Barang Habis!");
            }
            renderKeranjang();
        }

        function renderKeranjang() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            let subtotal = 0;

            keranjang.forEach((item, index) => {
                const totalBarang = item.harga_jual * item.qty;
                subtotal += totalBarang;
                list.innerHTML += `
                    <div class="cart-item">
                        <div>
                            <b>${item.nama_barang}</b><br>
                            <button class="qty-btn" onclick="ubahQty(${index}, -1)">-</button>
                            <span>${item.qty}</span>
                            <button class="qty-btn" onclick="ubahQty(${index}, 1)">+</button>
                        </div>
                        <span>Rp ${totalBarang.toLocaleString()}</span>
                    </div>`;
            });

            // Hitung Diskon & Pajak
            const pjkPersen = parseFloat(localStorage.getItem('global_pajak')) || 0;
            const dskPersen = parseFloat(localStorage.getItem('global_diskon')) || 0;

            const nDiskon = subtotal * (dskPersen / 100);
            const setelahDiskon = subtotal - nDiskon;
            const nPajak = setelahDiskon * (pjkPersen / 100);
            const totalAkhir = setelahDiskon + nPajak;

            document.getElementById('subtotal').innerText = "Rp " + subtotal.toLocaleString();
            document.getElementById('val-diskon').innerText = "- Rp " + nDiskon.toLocaleString();
            document.getElementById('val-pajak').innerText = "Rp " + nPajak.toLocaleString();
            document.getElementById('grand-total').innerText = "Rp " + Math.round(totalAkhir).toLocaleString();
            
            // Simpan ke session untuk struk & payment
            sessionStorage.setItem('temp_subtotal', subtotal);
            sessionStorage.setItem('temp_total', Math.round(totalAkhir));
            sessionStorage.setItem('temp_pajak', nPajak);
            sessionStorage.setItem('temp_diskon', nDiskon);
            sessionStorage.setItem('temp_cart', JSON.stringify(keranjang));
        }

        function ubahQty(idx, n) {
            keranjang[idx].qty += n;
            if (keranjang[idx].qty <= 0) keranjang.splice(idx, 1);
            renderKeranjang();
        }

        function prosesKePembayaran() {
            if (keranjang.length === 0) return alert("Pilih barang dulu!");
            
            // Simpan metode pembayaran
            sessionStorage.setItem('temp_method', document.getElementById('payment-method').value);
            
            // Lanjut ke payment.html
            window.location.href = "payment.html";
        }

        window.onload = init;
    </script>
</body>
</html>
