<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Global Health Check & Balance</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 40px; color: #333; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        .status-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .stat-card { padding: 20px; border-radius: 10px; color: white; text-align: center; }
        .bg-blue { background: #3498db; }
        .bg-green { background: var(--success); }
        .bg-red { background: var(--danger); }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 16px; margin-top: 10px; transition: 0.3s; }
        .btn-check { background: var(--primary); }
        .btn-fix { background: var(--success); display: none; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.4); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .selisih-text { font-size: 24px; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>

<div class="card">
    <h2>ü©∫ Global Health Check & Neraca</h2>
    <p>Gunakan ini untuk mendeteksi selisih <b>Rp 1.571.000</b> dan menyeimbangkan laporan secara otomatis.</p>

    <button class="btn btn-check" id="btn-scan" onclick="checkHealth()">üîç Jalankan Diagnosa Keuangan</button>

    <div id="result-area" style="display:none;">
        <div class="status-box">
            <div class="stat-card bg-blue">
                <small>TOTAL AKTIVA (Harta)</small>
                <div id="txt-aktiva" class="selisih-text">Rp 0</div>
            </div>
            <div class="stat-card bg-green">
                <small>TOTAL PASIVA (Modal + Hutang)</small>
                <div id="txt-pasiva" class="selisih-text">Rp 0</div>
            </div>
        </div>

        <div id="warning-box" class="stat-card bg-red" style="margin-bottom: 20px;">
            <div id="txt-selisih">Ditemukan Selisih: Rp 0</div>
            <small>Status: Neraca Tidak Seimbang</small>
        </div>

        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; font-size: 14px;">
            <b>Analisis Sistem:</b> Selisih ini biasanya terjadi karena saldo awal kas/stok tidak sama dengan modal awal yang diinput. Klik tombol di bawah untuk membuat jurnal penyesuaian otomatis ke akun <b>Modal (3101)</b>.
        </div>

        <button class="btn btn-fix" id="btn-fix" onclick="fixBalance()">üî• SEIMBANGKAN NERACA SEKARANG (AUTO-FIX)</button>
    </div>
</div>

<script>
    let globalSelisih = 0;

    async function checkHealth() {
        const btn = document.getElementById('btn-scan');
        btn.innerText = "‚è≥ Sedang Menghitung...";
        
        try {
            const { data: akun } = await db.from('akun').select('*');
            const { data: jurnal } = await db.from('jurnal_umum').select('*');

            let totalAktiva = 0;
            let totalPasiva = 0;
            let totalPendapatan = 0;
            let totalBeban = 0;

            // 1. Hitung Saldo Tiap Akun dari Jurnal
            akun.forEach(a => {
                const mutasi = jurnal.filter(j => String(j.kode_akun) === String(a.kode_akun));
                const d = mutasi.reduce((acc, curr) => acc + (Number(curr.debit) || 0), 0);
                const k = mutasi.reduce((acc, curr) => acc + (Number(curr.kredit) || 0), 0);
                
                let saldo = (a.posisi_normal === 'Debit') ? (d - k) : (k - d);
                let kode = String(a.kode_akun);

                if (kode.startsWith('1')) totalAktiva += saldo;
                else if (kode.startsWith('2')) totalPasiva += saldo;
                else if (kode.startsWith('3')) totalPasiva += saldo;
                else if (kode.startsWith('4')) totalPendapatan += saldo;
                else if (kode.startsWith('5') || kode.startsWith('6')) totalBeban += saldo;
            });

            // 2. Tambahkan Laba ke Pasiva
            const labaBerjalan = totalPendapatan - totalBeban;
            const finalPasiva = totalPasiva + labaBerjalan;

            globalSelisih = totalAktiva - finalPasiva;

            document.getElementById('txt-aktiva').innerText = "Rp " + totalAktiva.toLocaleString();
            document.getElementById('txt-pasiva').innerText = "Rp " + finalPasiva.toLocaleString();
            document.getElementById('txt-selisih').innerText = "Selisih: Rp " + Math.abs(globalSelisih).toLocaleString();

            const warnBox = document.getElementById('warning-box');
            const fixBtn = document.getElementById('btn-fix');

            if (Math.abs(globalSelisih) < 1) {
                warnBox.className = "stat-card bg-green";
                warnBox.innerHTML = "‚úÖ NERACA SUDAH SEIMBANG";
                fixBtn.style.display = "none";
            } else {
                warnBox.className = "stat-card bg-red";
                fixBtn.style.display = "block";
            }

            document.getElementById('result-area').style.display = 'block';
            btn.innerText = "üîç Scan Ulang";

        } catch (err) { alert(err.message); }
    }

    async function fixBalance() {
        if (!confirm(`Sistem akan memasukkan jurnal koreksi sebesar Rp ${Math.abs(globalSelisih).toLocaleString()} agar Neraca Allberto langsung seimbang. Lanjutkan?`)) return;

        try {
            const tgl = new Date().toISOString();
            const noBukti = "FIX-BAL-" + Date.now().toString().slice(-4);
            
            // Logika: Jika Aktiva < Pasiva, maka Aktiva (Kas) harus ditambah (Debet)
            // Atau jika Pasiva > Aktiva, maka Modal harus dikurangi atau sebaliknya.
            // Kita gunakan akun Modal (3101) sebagai penyeimbang paling aman.
            
            const batch = [
                {
                    tanggal: tgl, no_bukti: noBukti, kode_akun: '3101', 
                    keterangan: "Penyesuaian Keseimbangan Neraca Otomatis",
                    debit: globalSelisih < 0 ? 0 : globalSelisih,
                    kredit: globalSelisih < 0 ? Math.abs(globalSelisih) : 0
                }
            ];

            const { error } = await db.from('jurnal_umum').insert(batch);
            if (error) throw error;

            alert("‚úÖ BERHASIL! Neraca Allberto sekarang sudah seimbang. Silakan cek Laporan PDF kembali.");
            location.reload();
        } catch (err) { alert(err.message); }
    }
</script>
</body>
</html>
