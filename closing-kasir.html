<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Closing Kasir</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --bg: #f4f7f6; --white: #ffffff; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; display: flex; justify-content: center; }
        .closing-card { background: white; width: 400px; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .input-fisik { width: 100%; padding: 15px; font-size: 20px; border: 2px solid #ddd; border-radius: 10px; text-align: center; margin: 20px 0; }
        .btn-closing { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="closing-card">
    <h2 style="text-align: center; margin-top: 0;">Laporan Closing Shift</h2>
    <div id="shift-info">
        <div class="info-row"><span>Kasir</span><b id="kasir-nama">-</b></div>
        <div class="info-row"><span>Jam Buka</span><span id="jam-buka">-</span></div>
        <div class="info-row"><span>Saldo Awal</span><b id="saldo-awal">Rp 0</b></div>
        <div class="info-row"><span>Total Penjualan</span><b id="total-jual" style="color:var(--success)">Rp 0</b></div>
        <hr>
        <div class="info-row" style="font-size: 18px;"><span>Ekspektasi Kas</span><b id="ekspektasi">Rp 0</b></div>
    </div>

    <label style="display:block; margin-top:20px; font-weight:bold; text-align:center;">Uang Fisik di Laci (Cash)</label>
    <input type="number" id="uang-fisik" class="input-fisik" placeholder="Masukkan jumlah uang...">

    <div class="info-row" id="selisih-row" style="display:none; color: red;">
        <span>Selisih</span><b id="selisih">Rp 0</b>
    </div>

    <button class="btn-closing" onclick="prosesClosing()">TUTUP SHIFT & CETAK</button>
</div>

<script>
    const SB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    const supabase = window.supabase.createClient(SB_URL, SB_KEY);

    let dataShift = {};

    async function initClosing() {
        const shiftId = localStorage.getItem('shift_id');
        if(!shiftId) return alert("Tidak ada shift aktif!");

        // 1. Ambil data log kasir (saldo awal)
        const { data: log } = await supabase.from('kasir_log').select('*').eq('id', shiftId).single();
        dataShift = log;

        // 2. Ambil total penjualan tunai selama shift ini
        const { data: sales } = await supabase.from('penjualan')
            .select('grand_total')
            .eq('shift_id', shiftId)
            .eq('metode_pembayaran', 'Tunai');
        
        const totalSales = sales.reduce((acc, curr) => acc + parseFloat(curr.grand_total), 0);
        const ekspektasi = parseFloat(log.saldo_awal) + totalSales;

        document.getElementById('kasir-nama').innerText = log.kasir_nama;
        document.getElementById('jam-buka').innerText = new Date(log.created_at).toLocaleString();
        document.getElementById('saldo-awal').innerText = "Rp " + parseFloat(log.saldo_awal).toLocaleString();
        document.getElementById('total-jual').innerText = "Rp " + totalSales.toLocaleString();
        document.getElementById('ekspektasi').innerText = "Rp " + ekspektasi.toLocaleString();
    }

    async function prosesClosing() {
        const uangFisik = parseFloat(document.getElementById('uang-fisik').value);
        if(isNaN(uangFisik)) return alert("Masukkan uang fisik!");

        const ekspektasi = parseFloat(document.getElementById('ekspektasi').innerText.replace(/\D/g,''));
        const selisih = uangFisik - ekspektasi;

        const { error } = await supabase.from('kasir_log').update({
            saldo_akhir: uangFisik,
            total_penjualan: ekspektasi - dataShift.saldo_awal,
            selisih: selisih,
            status: 'Tutup',
            jam_tutup: new Date().toISOString()
        }).eq('id', dataShift.id);

        if(!error) {
            alert("Shift berhasil ditutup!");
            // Panggil fungsi cetak struk closing di sini jika perlu
            localStorage.removeItem('shift_id');
            window.location.href = "index.html";
        }
    }

    window.onload = initClosing;
</script>
</body>
</html>
