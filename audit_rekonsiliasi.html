<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Jurnal Penjualan | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e91e63; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        nav { width: 250px; background: var(--primary); color: white; height: 100vh; padding: 20px; position: fixed; }
        main { flex: 1; margin-left: 250px; padding: 40px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-fix { background: var(--accent); color: white; }
        .btn-check { background: var(--primary); color: white; margin-bottom: 20px; }
        .status-missing { color: var(--danger); font-weight: bold; background: #fee2e2; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>

<nav>
    <h2>Finex Pos</h2>
    <a href="dashboard.html" style="color:white; text-decoration:none;">‚¨Ö Kembali ke Dashboard</a>
</nav>

<main>
    <h1>üîß Rekonsiliasi & Fix Jurnal</h1>
    <p>File ini mendeteksi transaksi penjualan yang <b>belum tercatat</b> di Jurnal Umum.</p>

    <div class="card">
        <button class="btn btn-check" onclick="jalankanAudit()">üîç Mulai Audit Transaksi</button>
        
        <div id="summary-audit" style="margin-bottom: 20px; font-weight: bold; display: none;">
            Ditemukan <span id="count-missing" style="color:var(--danger)">0</span> transaksi yang tidak sinkron.
            <button id="btn-fix-all" class="btn btn-fix" style="display:none;" onclick="fixSemuaJurnal()">üî• FIX SEMUA JURNAL SEKARANG</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>No. Faktur</th>
                    <th>Tanggal</th>
                    <th>Metode</th>
                    <th>Total Harga</th>
                    <th>Status Jurnal</th>
                </tr>
            </thead>
            <tbody id="list-audit">
                <tr><td colspan="5" align="center">Klik tombol audit untuk memulai...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<script>
    let transaksiHilang = [];

    async function jalankanAudit() {
        const tbody = document.getElementById('list-audit');
        tbody.innerHTML = '<tr><td colspan="5" align="center">‚è≥ Membandingkan data Penjualan vs Jurnal...</td></tr>';
        transaksiHilang = [];

        try {
            // 1. Ambil data penjualan (Bulan Februari 2026)
            const { data: penjualan, error: errP } = await db.from('penjualan')
                .select('*')
                .gte('created_at', '2026-02-01T00:00:00Z')
                .lte('created_at', '2026-02-28T23:59:59Z');

            // 2. Ambil semua no_bukti di Jurnal Umum
            const { data: jurnal, error: errJ } = await db.from('jurnal_umum')
                .select('no_bukti');

            if (errP || errJ) throw (errP || errJ);

            const setJurnal = new Set(jurnal.map(j => j.no_bukti));

            // 3. Filter transaksi yang ada di penjualan tapi GAK ADA di jurnal
            transaksiHilang = penjualan.filter(p => !setJurnal.has(p.no_faktur));

            renderTable();
        } catch (e) {
            alert("Audit Gagal: " + e.message);
        }
    }

    function renderTable() {
        const tbody = document.getElementById('list-audit');
        const summary = document.getElementById('summary-audit');
        const btnFix = document.getElementById('btn-fix-all');
        
        summary.style.display = 'block';
        document.getElementById('count-missing').innerText = transaksiHilang.length;

        if (transaksiHilang.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" align="center" style="color:green; font-weight:bold;">‚úÖ Semua transaksi sudah sinkron dengan Jurnal!</td></tr>';
            btnFix.style.display = 'none';
            return;
        }

        btnFix.style.display = 'inline-block';
        tbody.innerHTML = transaksiHilang.map(p => {
            const nominal = p.total || p.total_harga || p.grand_total || 0;
            return `
                <tr>
                    <td>${p.no_faktur}</td>
                    <td>${new Date(p.created_at).toLocaleDateString('id-ID')}</td>
                    <td>${p.metode_pembayaran}</td>
                    <td>Rp ${parseFloat(nominal).toLocaleString()}</td>
                    <td><span class="status-missing">TIDAK ADA DI JURNAL</span></td>
                </tr>
            `;
        }).join('');
    }

    async function fixSemuaJurnal() {
        if (!confirm(`Apakah Anda yakin ingin memasukkan ${transaksiHilang.length} transaksi ini ke Jurnal Umum secara otomatis?`)) return;

        const btn = document.getElementById('btn-fix-all');
        btn.disabled = true;
        btn.innerText = "‚è≥ Memproses...";

        try {
            let dataJurnalBaru = [];

            for (const p of transaksiHilang) {
                const nominal = parseFloat(p.total || p.total_harga || p.grand_total || 0);
                const tgl = p.created_at;
                const faktur = p.no_faktur;
                const metode = (p.metode_pembayaran || "").toUpperCase();
                
                // Tentukan akun aset (1101 Tunai, 1102 Selain Tunai)
                const akunAset = (metode === 'TUNAI') ? '1101' : '1102';

                // Baris 1: Debit Kas/Bank (Aset bertambah)
                dataJurnalBaru.push({
                    tanggal: tgl, no_bukti: faktur, kode_akun: akunAset,
                    keterangan: `Penjualan: ${metode} (${faktur})`, debit: nominal, kredit: 0
                });

                // Baris 2: Kredit Pendapatan (Akun 4101 - Pendapatan Penjualan)
                dataJurnalBaru.push({
                    tanggal: tgl, no_bukti: faktur, kode_akun: '4101',
                    keterangan: `Pendapatan Penjualan (${faktur})`, debit: 0, kredit: nominal
                });
            }

            // Batch insert ke jurnal_umum
            const { error } = await db.from('jurnal_umum').insert(dataJurnalBaru);
            if (error) throw error;

            alert("‚úÖ BERHASIL! Selisih Rp 873.000 (atau nominal lainnya) telah diperbaiki di Jurnal Umum.");
            location.reload();

        } catch (e) {
            alert("Gagal Memperbaiki: " + e.message);
            btn.disabled = false;
            btn.innerText = "üî• FIX SEMUA JURNAL SEKARANG";
        }
    }
</script>
</body>
</html>
