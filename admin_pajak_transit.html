<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transit Bill Pajak | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #e91e63; --bg: #f4f7f6; --success: #27ae60; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { color: var(--primary); margin: 0 0 10px 0; text-align: center; font-size: 22px; }
        .divider { border: 0; border-top: 2px solid #eee; margin-bottom: 20px; }
        .filter-section { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .grid-date { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { display: block; font-size: 11px; font-weight: bold; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; outline: none; }
        .info-omzet { background: #fff; border: 2px solid #eee; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; text-align: center; }
        .val-omzet { font-size: 20px; font-weight: 800; color: var(--primary); display: block; margin-bottom: 15px; }
        .tax-input-box { display: flex; align-items: center; gap: 10px; justify-content: center; background: #fff5f7; padding: 10px; border-radius: 8px; border: 1px dashed var(--accent); }
        .val-tax { font-size: 24px; font-weight: 900; color: var(--accent); display: block; margin-top: 10px; }
        .btn { border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.3s; }
        .btn-check { background: var(--primary); color: white; margin-bottom: 10px; }
        .btn-generate { background: var(--accent); color: white; margin-top: 20px; display: none; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .loading { font-size: 12px; color: var(--warning); font-style: italic; display: none; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="card">
    <h2>Pajak Transit</h2>
    <p style="text-align: center; font-size: 13px; color: #7f8c8d; margin-bottom: 20px;">Sesuaikan Saldo Pendapatan ke Akun Pajak</p>
    <hr class="divider">

    <div class="filter-section">
        <label>Sumber Akun Pendapatan (Dari)</label>
        <select id="select-akun-pendapatan" style="margin-bottom: 15px; font-weight: bold;"></select>

        <label>Filter Periode Omzet</label>
        <div class="grid-date">
            <div>
                <label style="font-size: 9px;">Dari Tanggal</label>
                <input type="date" id="date-from">
            </div>
            <div>
                <label style="font-size: 9px;">Sampai Tanggal</label>
                <input type="date" id="date-to">
            </div>
        </div>
        <button class="btn btn-check" id="btn-hitung" onclick="fetchOmzet()">HITUNG OMZET üîç</button>
        <div id="loader" class="loading">Menganalisa Jurnal Umum...</div>
    </div>

    <div id="result-area" class="info-omzet">
        <label>Total Kredit Akun Terpilih</label>
        <span id="display-omzet" class="val-omzet">Rp 0</span>

        <div class="tax-input-box">
            <div style="flex: 1;">
                <label>Persen (%)</label>
                <input type="number" id="tax-percent" value="12" oninput="calculateTax()">
            </div>
            <div style="flex: 2;">
                <label>Pajak Terhitung</label>
                <span id="display-tax" class="val-tax">Rp 0</span>
            </div>
        </div>

        <div style="margin-top: 20px; text-align: left;">
            <label>Pindahkan Ke Akun (Ke/Hutang Pajak)</label>
            <select id="select-akun-pajak" style="margin-bottom: 15px; font-weight: bold;"></select>
            
            <label>Keterangan Jurnal</label>
            <input type="text" id="keterangan" placeholder="Penyesuaian Pajak Bulanan">
        </div>

        <button class="btn btn-generate" id="btn-save" onclick="generateJurnalPajak()">
            EKSEKUSI JURNAL PENYESUAIAN ‚ö°
        </button>
    </div>
</div>

<script>
    let dataOmzet = 0;
    let taxValue = 0;

    window.onload = async () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-from').value = today;
        document.getElementById('date-to').value = today;
        await loadDinamisAkun();
    };

    async function loadDinamisAkun() {
        try {
            // Ambil Akun Pendapatan (Kepala 4)
            const { data: pendapatan } = await db.from('akun').select('kode_akun, nama_akun').ilike('kode_akun', '4%').order('kode_akun');
            const selPen = document.getElementById('select-akun-pendapatan');
            pendapatan.forEach(a => {
                selPen.innerHTML += `<option value="${a.kode_akun}">${a.kode_akun} - ${a.nama_akun}</option>`;
            });

            // Ambil Akun Kewajiban/Pajak (Kepala 2)
            const { data: pajak } = await db.from('akun').select('kode_akun, nama_akun').ilike('kode_akun', '2%').order('kode_akun');
            const selPajak = document.getElementById('select-akun-pajak');
            pajak.forEach(a => {
                // Utamakan pilih akun yang ada kata 'pajak'
                const isTax = a.nama_akun.toLowerCase().includes('pajak');
                selPajak.innerHTML += `<option value="${a.kode_akun}" ${isTax ? 'selected' : ''}>${a.kode_akun} - ${a.nama_akun}</option>`;
            });
        } catch (e) { console.error("Gagal load akun", e); }
    }

    async function fetchOmzet() {
        const from = document.getElementById('date-from').value;
        const to = document.getElementById('date-to').value;
        const akunTerpilih = document.getElementById('select-akun-pendapatan').value;
        const loader = document.getElementById('loader');
        
        if (!from || !to) return alert("Pilih tanggal!");

        loader.style.display = 'block';
        document.getElementById('result-area').style.display = 'none';
        
        try {
            const { data, error } = await db.from('jurnal_umum')
                .select('kredit, debit')
                .eq('kode_akun', akunTerpilih) 
                .gte('tanggal', `${from}T00:00:00`)
                .lte('tanggal', `${to}T23:59:59`);

            if (error) throw error;

            // Hitung Omzet Net (Kredit - Debit)
            dataOmzet = data.reduce((sum, item) => sum + (parseFloat(item.kredit || 0) - parseFloat(item.debit || 0)), 0);
            
            document.getElementById('display-omzet').innerText = "Rp " + Math.round(dataOmzet).toLocaleString('id-ID');
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('btn-save').style.display = 'block';
            
            calculateTax();
        } catch (e) {
            alert("Gagal: " + e.message);
        } finally {
            loader.style.display = 'none';
        }
    }

    function calculateTax() {
        const percent = parseFloat(document.getElementById('tax-percent').value || 0) / 100;
        taxValue = Math.round(dataOmzet * percent);
        document.getElementById('display-tax').innerText = "Rp " + taxValue.toLocaleString('id-ID');
    }

    async function generateJurnalPajak() {
        if (taxValue <= 0) return alert("Nilai pajak harus lebih besar dari 0!");

        const akunPendapatan = document.getElementById('select-akun-pendapatan').value;
        const akunPajak = document.getElementById('select-akun-pajak').value;
        const ket = document.getElementById('keterangan').value || `Pajak Transit Omzet ${document.getElementById('date-from').value}`;
        const btnSave = document.getElementById('btn-save');

        const konfirmasi = confirm(`EKSEKUSI JURNAL PENYESUAIAN:\n--------------------------\nDebit (Potong Pendapatan): ${akunPendapatan}\nKredit (Masuk Pajak): ${akunPajak}\nNominal: Rp ${taxValue.toLocaleString()}\n\nApakah data sudah benar?`);
        if (!konfirmasi) return;

        btnSave.disabled = true;
        btnSave.innerText = "‚è≥ Sedang Memproses...";

        try {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
            const noBukti = `TAX-${dateStr}-${Math.floor(1000 + Math.random() * 9000)}`;
            const tglJurnal = now.toISOString();

            // Insert Jurnal Sepasang (Debit Pendapatan, Kredit Pajak)
            const { error } = await db.from('jurnal_umum').insert([
                { tanggal: tglJurnal, no_bukti: noBukti, kode_akun: akunPendapatan, keterangan: ket, debit: taxValue, kredit: 0 },
                { tanggal: tglJurnal, no_bukti: noBukti, kode_akun: akunPajak, keterangan: ket, debit: 0, kredit: taxValue }
            ]);

            if (error) throw error;
            
            alert("‚úÖ BERHASIL!\nJurnal Pajak Transit telah dibuat.\n\nSilakan cek Laporan Neraca untuk memastikan saldo sudah berpindah.");
            location.reload();
        } catch (e) { 
            alert("Error: " + e.message); 
            btnSave.disabled = false;
            btnSave.innerText = "EKSEKUSI JURNAL PENYESUAIAN ‚ö°";
        }
    }
</script>
</body>
</html>
