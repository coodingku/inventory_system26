<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transit Bill Pajak | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e91e63; --bg: #f4f7f6; --success: #27ae60; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { color: var(--primary); margin: 0 0 10px 0; text-align: center; font-size: 22px; }
        .divider { border: 0; border-top: 2px solid #eee; margin-bottom: 20px; }
        
        .filter-section { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #e0e0e0; margin-bottom: 20px; }
        .grid-date { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        label { display: block; font-size: 11px; font-weight: bold; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 5px rgba(233, 30, 99, 0.2); }

        .info-omzet { background: #fff; border: 2px solid #eee; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; text-align: center; }
        .val-omzet { font-size: 20px; font-weight: 800; color: var(--primary); display: block; margin-bottom: 15px; }
        
        .tax-input-box { display: flex; align-items: center; gap: 10px; justify-content: center; background: #fff5f7; padding: 10px; border-radius: 8px; border: 1px dashed var(--accent); }
        .val-tax { font-size: 24px; font-weight: 900; color: var(--accent); display: block; margin-top: 10px; }

        .btn { border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.3s; }
        .btn-check { background: var(--primary); color: white; margin-bottom: 10px; }
        .btn-check:hover { background: #1a252f; }
        .btn-generate { background: var(--accent); color: white; display: none; }
        .btn-generate:hover { background: #c2185b; transform: translateY(-2px); }
        
        .loading { font-size: 12px; color: var(--warning); font-style: italic; display: none; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="card">
    <h2>Pajak Transit</h2>
    <p style="text-align: center; font-size: 13px; color: #7f8c8d; margin-bottom: 20px;">Memindahkan Pendapatan (4101) ke Hutang Pajak (2102)</p>
    <hr class="divider">

    <div class="filter-section">
        <label>Filter Periode Penjualan</label>
        <div class="grid-date">
            <div>
                <label style="font-size: 9px;">Dari Tanggal</label>
                <input type="date" id="date-from">
            </div>
            <div>
                <label style="font-size: 9px;">Sampai Tanggal</label>
                <input type="date" id="date-to">
            </div>
        </div>
        <button class="btn btn-check" onclick="fetchOmzet()">CEK TOTAL OMZET üîç</button>
        <div id="loader" class="loading">Sedang mengambil data dari database...</div>
    </div>

    <div id="result-area" class="info-omzet">
        <label>Total Omzet (Kredit 4101)</label>
        <span id="display-omzet" class="val-omzet">Rp 0</span>

        <div class="tax-input-box">
            <div style="flex: 1;">
                <label>Pajak (%)</label>
                <input type="number" id="tax-percent" value="11" oninput="calculateTax()">
            </div>
            <div style="flex: 2;">
                <label>PPN Terhitung</label>
                <span id="display-tax" class="val-tax">Rp 0</span>
            </div>
        </div>

        <div style="margin-top: 20px; text-align: left;">
            <label>Keterangan Jurnal</label>
            <input type="text" id="keterangan" placeholder="Contoh: Penyesuaian Pajak Januari">
        </div>

        <button class="btn btn-generate" id="btn-save" onclick="generateJurnalPajak()" style="margin-top: 20px;">
            GENERATE JURNAL PAJAK ‚ö°
        </button>
    </div>
</div>

<script>
    // Konfigurasi Database
    const URL_DB = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const KEY_DB = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    const db = window.supabase.createClient(URL_DB, KEY_DB);

    let dataOmzet = 0;
    let taxValue = 0;

    // Set Default Tanggal Hari Ini
    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-from').value = today;
        document.getElementById('date-to').value = today;
    };

    async function fetchOmzet() {
        const from = document.getElementById('date-from').value;
        const to = document.getElementById('date-to').value;
        const loader = document.getElementById('loader');
        
        if (!from || !to) return alert("Pilih rentang tanggal!");

        loader.style.display = 'block';
        document.getElementById('result-area').style.display = 'none';
        
        try {
            // Kita gunakan filter yang lebih fleksibel untuk kode_akun (Teks/Angka)
            // Dan menyertakan rentang waktu penuh dalam satu hari
            const { data, error } = await db.from('jurnal_umum')
                .select('kredit')
                .eq('kode_akun', '4101') 
                .gte('tanggal', `${from}T00:00:00`)
                .lte('tanggal', `${to}T23:59:59`);

            if (error) throw error;

            // Jika data kosong, coba cari sekali lagi dengan paksaan tipe data angka
            let finalData = data;
            if (data.length === 0) {
                const { data: dataAlt } = await db.from('jurnal_umum')
                    .select('kredit')
                    .eq('kode_akun', 4101) 
                    .gte('tanggal', `${from}T00:00:00`)
                    .lte('tanggal', `${to}T23:59:59`);
                finalData = dataAlt || [];
            }

            dataOmzet = finalData.reduce((sum, item) => sum + parseFloat(item.kredit || 0), 0);
            
            document.getElementById('display-omzet').innerText = "Rp " + dataOmzet.toLocaleString('id-ID');
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('btn-save').style.display = 'block';
            
            calculateTax();

            if (dataOmzet === 0) {
                alert("Peringatan: Omzet ditemukan Rp 0. Pastikan sudah ada transaksi dengan kode akun 4101 di periode ini.");
            }

        } catch (e) {
            console.error(e);
            alert("Gagal memuat data: " + e.message);
        } finally {
            loader.style.display = 'none';
        }
    }

    function calculateTax() {
        const percent = parseFloat(document.getElementById('tax-percent').value || 0) / 100;
        // Rumus sederhana: Total Kredit 4101 x Persen
        taxValue = Math.round(dataOmzet * percent);
        document.getElementById('display-tax').innerText = "Rp " + taxValue.toLocaleString('id-ID');
    }

    async function generateJurnalPajak() {
        if (taxValue <= 0) return alert("Nilai pajak tidak boleh 0!");

        const from = document.getElementById('date-from').value;
        const to = document.getElementById('date-to').value;
        const ket = document.getElementById('keterangan').value || `Transit PPN ${from} s/d ${to}`;

        const konfirmasi = confirm(`Konfirmasi Transit Pajak:\n--------------------------\nOmzet Terdeteksi: Rp ${dataOmzet.toLocaleString()}\nPajak (${document.getElementById('tax-percent').value}%): Rp ${taxValue.toLocaleString()}\n\nSaldo 4101 akan dikurangi (Debit).\nSaldo 2102 akan bertambah (Kredit).\n\nLanjutkan?`);
        
        if (!konfirmasi) return;

        try {
            const noBukti = `TAX-ADJ-${Date.now().toString().slice(-6)}`;
            const tglJurnal = new Date().toISOString(); // Mencatat di waktu sekarang

            // Membuat Double Entry: Debit 4101 (Kurangi Omzet), Kredit 2102 (Tambah Hutang)
            const { error } = await db.from('jurnal_umum').insert([
                { 
                    tanggal: tglJurnal, 
                    no_bukti: noBukti, 
                    kode_akun: '4101', 
                    keterangan: ket, 
                    debit: taxValue, 
                    kredit: 0 
                },
                { 
                    tanggal: tglJurnal, 
                    no_bukti: noBukti, 
                    kode_akun: '2102', 
                    keterangan: ket, 
                    debit: 0, 
                    kredit: taxValue 
                }
            ]);

            if (error) throw error;

            alert("‚úÖ Sukses! Jurnal Pajak telah berhasil digenerate.");
            location.reload(); // Refresh halaman

        } catch (e) {
            console.error(e);
            alert("Gagal menyimpan jurnal: " + e.message);
        }
    }
</script>
</body>
</html>
