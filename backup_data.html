<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup Full DB - Finex Pos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“¦</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-transparent flex items-center justify-center min-h-screen p-6">

    <div class="max-w-md w-full bg-white rounded-[2.5rem] p-8 shadow-xl text-center space-y-6 border border-slate-100">
        <div class="bg-indigo-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto">
            <i data-lucide="database-zap" class="text-indigo-600 w-10 h-10"></i>
        </div>
        
        <div>
            <h2 class="text-2xl font-black text-slate-900">Backup Full DB</h2>
            <p class="text-slate-500 text-sm mt-2 font-medium">Cadangkan struktur dan seluruh isi data sistem <b>Finex Pos</b> Anda.</p>
        </div>

        <div id="status-container" class="hidden">
            <div class="w-full bg-slate-100 rounded-full h-2 mb-2">
                <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-center">Menyiapkan...</p>
        </div>

        <div class="space-y-3">
            <button id="btn-backup" onclick="generateFullBackup()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all flex items-center justify-center gap-3 active:scale-95">
                <i data-lucide="download" class="w-5 h-5"></i>
                Unduh Struktur & Data
            </button>
            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Mencakup 21 Tabel & Data Riil</p>
        </div>
        
        <div class="text-left bg-slate-50 p-4 rounded-2xl border border-slate-100">
            <p class="text-[9px] font-black text-slate-400 uppercase mb-2 leading-relaxed">Status Koneksi: <span id="conn-status" class="text-amber-500 font-bold">Mengecek Sesi...</span></p>
            <p class="text-[9px] text-slate-400 leading-relaxed">File hasil cadangan akan berformat <b>.sql</b> yang bisa digunakan untuk <i>Restore</i> database kapan saja.</p>
        </div>
    </div>

    <script>
        // 1. KONFIGURASI SUPABASE
        const SUPABASE_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
        const SESSION_KEY = sessionStorage.getItem('FINE_POS_MASTER_KEY');
        const connStatus = document.getElementById('conn-status');

        if (!SESSION_KEY) {
            connStatus.innerText = "TIDAK ADA AKSES";
            connStatus.className = "text-red-500 font-bold";
            alert("Sesi API Key tidak ditemukan. Silakan login kembali.");
            window.parent.location.href = 'login_backup.html';
        } else {
            connStatus.innerText = "TERHUBUNG (READY)";
            connStatus.className = "text-emerald-500 font-bold";
        }

        const dbClient = supabase.createClient(SUPABASE_URL, SESSION_KEY);

        const tableList = [
            'users', 'kategori', 'gudang', 'produk', 'inventory', 
            'riwayat_stok', 'riwayat_restock', 'penjualan', 
            'penjualan_detail', 'transaksi', 'detail_transaksi', 
            'pembelian', 'pengeluaran', 'kategori_akun', 'akun', 
            'jurnal', 'jurnal_umum', 'employee_staff', 'presensi', 
            'kasir_log', 'pengaturan_toko'
        ];

        async function generateFullBackup() {
            const btn = document.getElementById('btn-backup');
            const statusContainer = document.getElementById('status-container');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');

            statusContainer.classList.remove('hidden');
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            let sqlContent = `-- BACKUP FULL DATABASE - FINEX POS\n`;
            sqlContent += `-- Dihasilkan pada: ${new Date().toLocaleString('id-ID')}\n`;
            sqlContent += `-- Project ID: uojhjskgugghwxtdsfvm\n\n`;
            sqlContent += `SET check_function_bodies = false;\n\n`;

            try {
                // PART 1: STRUKTUR TABEL (DDL)
                const ddlScripts = [
                    `CREATE TABLE IF NOT EXISTS users (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), username text UNIQUE, password text, role text, nama_lengkap text, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS kategori (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), nama_kategori text, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS gudang (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), nama_gudang text, lokasi text, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS produk (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), kode_barang text UNIQUE, nama_barang text, kategori_id uuid REFERENCES kategori(id), gudang_id uuid REFERENCES gudang(id), harga_beli int4, harga_jual int4, stok_sekarang int4, stok_gudang int4, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS inventory (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), kode_barang text, nama_barang text, kategori text, stok_minimal int4, stok_sekarang int4, harga_beli int4, harga_jual int4, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS riwayat_stok (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), id_produk uuid, tipe text, jumlah int4, keterangan text, admin_nama text, stok_akhir int4, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS riwayat_restock (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), produk_id uuid, nama_produk text, jumlah int4, role text, catatan text, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS penjualan (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), no_invoice text UNIQUE, tanggal timestamptz DEFAULT now(), subtotal numeric, diskon_global numeric, pajak_ppn numeric, grand_total numeric, metode_pembayaran text, kasir_id uuid, bayar numeric, kembali numeric, items jsonb, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS penjualan_detail (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), penjualan_id uuid REFERENCES penjualan(id) ON DELETE CASCADE, produk_id uuid, nama_barang text, harga_satuan numeric, qty int4, subtotal_item numeric, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS transaksi (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), no_struk text, nik_staff text, total_bayar int4, metode_bayar text, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS detail_transaksi (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), transaksi_id uuid REFERENCES transaksi(id) ON DELETE CASCADE, kode_barang text, nama_barang text, jumlah int4, harga_satuan int4, subtotal int4);`,
                    `CREATE TABLE IF NOT EXISTS pembelian (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), produk_id uuid, qty int4, harga_beli numeric, supplier text, total_harga numeric, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS pengeluaran (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), tanggal timestamptz DEFAULT now(), kategori text, keterangan text, jumlah numeric, kasir_id uuid);`,
                    `CREATE TABLE IF NOT EXISTS kategori_akun (nama_kategori text PRIMARY KEY, keterangan text, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS akun (kode_akun text PRIMARY KEY, nama_akun text, kategori text REFERENCES kategori_akun(nama_kategori), posisi_normal text, saldo numeric DEFAULT 0);`,
                    `CREATE TABLE IF NOT EXISTS jurnal (id int8 PRIMARY KEY, keterangan text, kode_akun text, debet numeric, kredit numeric, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS jurnal_umum (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), tanggal timestamptz, no_bukti text, kode_akun text, keterangan text, debit numeric, kredit numeric, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS employee_staff (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), nama_staff text, jabatan text, face_descriptor text, created_at timestamptz DEFAULT now());`,
                    `CREATE TABLE IF NOT EXISTS presensi (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), nama_staff text, waktu_masuk timestamptz, waktu_pulang timestamptz, status text, tanggal date DEFAULT CURRENT_DATE, foto_masuk text, lokasi_masuk text);`,
                    `CREATE TABLE IF NOT EXISTS kasir_log (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), tanggal date, waktu_buka timestamptz, waktu_tutup timestamptz, saldo_awal numeric, total_tunai_sistem numeric, total_tunai_fisik numeric, selisih numeric, status text, kasir_nama text, saldo_akhir numeric, waktu_closing timestamptz);`,
                    `CREATE TABLE IF NOT EXISTS pengaturan_toko (id int4 PRIMARY KEY, nama_toko text, latitude numeric, longitude numeric, radius_meter int4);`,
                    `CREATE TABLE IF NOT EXISTS ppn (id int4 PRIMARY KEY, nilai numeric, updated_at timestamptz DEFAULT now());`
                ];

                sqlContent += `-- [ PART 1: STRUCTURE ]\n` + ddlScripts.join('\n') + `\n\n`;

                // PART 2: DATA RECORDS (FETCH REAL DATA)
                sqlContent += `-- [ PART 2: DATA RECORDS ]\n`;

                for (let i = 0; i < tableList.length; i++) {
                    const tableName = tableList[i];
                    statusText.innerText = `Fetching: ${tableName}...`;
                    const percent = Math.round(((i + 1) / tableList.length) * 100);
                    progressBar.style.width = `${percent}%`;

                    const { data, error } = await dbClient.from(tableName).select('*');
                    
                    if (!error && data && data.length > 0) {
                        sqlContent += `-- Data Tabel: ${tableName}\n`;
                        data.forEach(row => {
                            const keys = Object.keys(row).join(', ');
                            const values = Object.values(row).map(val => {
                                if (val === null) return 'NULL';
                                if (typeof val === 'string') return `'${val.replace(/'/g, "''")}'`;
                                if (typeof val === 'object') return `'${JSON.stringify(val)}'`;
                                return val;
                            }).join(', ');
                            
                            sqlContent += `INSERT INTO ${tableName} (${keys}) VALUES (${values}) ON CONFLICT DO NOTHING;\n`;
                        });
                        sqlContent += `\n`;
                    }
                }

                // DOWNLOAD FILE
                const blob = new Blob([sqlContent], { type: 'text/sql' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `Full_Backup_FinexPos_${new Date().toISOString().slice(0,10)}.sql`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                statusText.innerText = "Selesai!";
                alert("Backup Struktur & Data Berhasil Diunduh.");

            } catch (err) {
                console.error(err);
                alert("Gagal melakukan backup. Cek koneksi atau konsol.");
            } finally {
                setTimeout(() => {
                    statusContainer.classList.add('hidden');
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }, 1000);
            }
        }

        lucide.createIcons();
    </script>
</body>
</html>
