<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Face ID & Geofencing BeautyBloom</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e91e63; --success: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .absen-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 480px; text-align: center; }
        #video-container { width: 100%; height: 320px; background: #000; border-radius: 15px; overflow: hidden; margin: 15px 0; position: relative; border: 4px solid #eee; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .geo-status { padding: 12px; border-radius: 8px; font-size: 13px; font-weight: bold; margin-bottom: 15px; transition: 0.3s; }
        .btn-scan { background: var(--accent); color: white; padding: 18px; width: 100%; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3); }
        .btn-disabled { background: #ccc !important; cursor: not-allowed; box-shadow: none !important; }
        #overlay-msg { position: absolute; bottom: 0; left: 0; width: 100%; color: white; background: rgba(0,0,0,0.6); font-size: 12px; padding: 8px 0; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="absen-card">
    <h2 style="margin:0; color: var(--primary);">Finex Face ID</h2>
    <div style="color: var(--accent); font-weight: bold; margin-bottom: 15px; font-size: 14px;">BeautyBloom Beauty Center</div>
    
    <div id="geo-status" class="geo-status" style="background:#eee;">üìç Mendeteksi Lokasi...</div>

    <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
        <div id="overlay-msg">Inisialisasi AI & Kamera...</div>
    </div>

    <div id="status-scan" style="font-weight: bold; margin-bottom: 20px; color: #555; min-height: 24px;">
        <div class="loader"></div> Menyiapkan data staff...
    </div>

    <button id="btn-action" class="btn-scan btn-disabled" onclick="mulaiVerifikasi()" disabled>
        MULAI SCAN WAJAH
    </button>
</div>

<script>
    const URL_DB = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const KEY_DB = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    const FinexDB = window.supabase.createClient(URL_DB, KEY_DB);

    let labeledDescriptors = [];
    let configToko = null;
    let userLoc = { lat: 0, lon: 0 };
    let isInside = false;

    async function init() {
        try {
            // 1. Muat Model AI
            const MODEL_URL = 'https://raw.githubusercontent.com/vladmandic/face-api/master/model';
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);

            // 2. Ambil Data employee_staff
            const { data: staffData, error: errStaff } = await FinexDB.from('employee_staff').select('*');
            if (errStaff) throw errStaff;

            labeledDescriptors = staffData.filter(s => s.face_descriptor).map(s => {
                const desc = new Float32Array(JSON.parse(s.face_descriptor));
                return new faceapi.LabeledFaceDescriptors(s.nama_staff, [desc]);
            });

            // 3. Ambil Config Lokasi
            const { data: locData } = await FinexDB.from('pengaturan_toko').select('*').eq('id', 1).single();
            configToko = locData || { latitude: 0, longitude: 0, radius_meter: 100 };

            document.getElementById('status-scan').innerText = "Sistem Siap. Silakan berdiri di depan kamera.";
            document.getElementById('overlay-msg').innerText = "Kamera Aktif ‚Ä¢ AI Standby";
            startCamera();
            trackLocation();
        } catch (e) {
            console.error(e);
            document.getElementById('status-scan').innerHTML = "<span style='color:red;'>Gagal inisialisasi sistem. Periksa koneksi internet.</span>";
        }
    }

    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
            .then(stream => {
                document.getElementById('video').srcObject = stream;
            })
            .catch(err => {
                alert("Gagal mengakses kamera: " + err.message);
            });
    }

    function trackLocation() {
        if (!navigator.geolocation) {
            document.getElementById('geo-status').innerText = "Geolocation tidak didukung browser ini.";
            return;
        }

        navigator.geolocation.watchPosition(pos => {
            userLoc.lat = pos.coords.latitude;
            userLoc.lon = pos.coords.longitude;
            
            if (!configToko) return;

            const R = 6371e3; // Radius bumi dalam meter
            const phi1 = userLoc.lat * Math.PI/180;
            const phi2 = configToko.latitude * Math.PI/180;
            const dPhi = (configToko.latitude - userLoc.lat) * Math.PI/180;
            const dLambda = (configToko.longitude - userLoc.lon) * Math.PI/180;

            const a = Math.sin(dPhi/2) * Math.sin(dPhi/2) +
                      Math.cos(phi1) * Math.cos(phi2) *
                      Math.sin(dLambda/2) * Math.sin(dLambda/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const dist = R * c;

            const statusBox = document.getElementById('geo-status');
            const btn = document.getElementById('btn-action');

            if (dist <= configToko.radius_meter) {
                statusBox.innerHTML = `‚úÖ Area BeautyBloom Terdeteksi (${Math.round(dist)}m)`;
                statusBox.style.background = "#e8f5e9";
                statusBox.style.color = "#2e7d32";
                btn.disabled = false;
                btn.classList.remove('btn-disabled');
                isInside = true;
            } else {
                statusBox.innerHTML = `‚ùå Diluar Radius BeautyBloom! Jarak: ${Math.round(dist)}m`;
                statusBox.style.background = "#ffebee";
                statusBox.style.color = "#c62828";
                btn.disabled = true;
                btn.classList.add('btn-disabled');
                isInside = false;
            }
        }, err => {
            document.getElementById('geo-status').innerText = "Izin lokasi diperlukan untuk absen.";
        }, { enableHighAccuracy: true });
    }

    async function mulaiVerifikasi() {
        if (!isInside) return alert("Anda harus berada di area BeautyBloom!");
        if (labeledDescriptors.length === 0) return alert("Data wajah staff belum tersedia.");
        
        const video = document.getElementById('video');
        const status = document.getElementById('status-scan');
        const btn = document.getElementById('btn-action');
        
        btn.disabled = true;
        status.innerHTML = `<div class="loader"></div> ‚è≥ Memindai Wajah...`;

        // Deteksi wajah dengan descriptor
        const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();

        if (detection) {
            const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.55);
            const match = faceMatcher.findBestMatch(detection.descriptor);

            if (match.label !== 'unknown') {
                status.innerText = "‚úÖ Wajah Dikenali: " + match.label;
                status.style.color = "var(--success)";
                await simpanAbsensi(match.label);
            } else {
                status.innerText = "‚ùå Wajah Tidak Dikenal!";
                status.style.color = "var(--danger)";
                setTimeout(() => {
                    status.innerText = "Sistem Siap. Silakan coba lagi.";
                    status.style.color = "#555";
                    btn.disabled = false;
                }, 3000);
            }
        } else {
            status.innerText = "‚ö†Ô∏è Wajah tidak terlihat jelas.";
            status.style.color = "orange";
            setTimeout(() => {
                status.innerText = "Sistem Siap. Silakan coba lagi.";
                status.style.color = "#555";
                btn.disabled = false;
            }, 2000);
        }
    }

    async function simpanAbsensi(nama) {
        const now = new Date();
        const tglStr = now.toISOString().split('T')[0];
        
        // Cek status absen hari ini (mencari yang statusnya 'Aktif')
        const { data: aktif, error: errCek } = await FinexDB
            .from('presensi')
            .select('*')
            .eq('nama_staff', nama)
            .eq('tanggal', tglStr)
            .eq('status', 'Aktif')
            .maybeSingle();

        if (aktif) {
            // PROSES ABSEN PULANG
            const waktuMasuk = new Date(aktif.waktu_masuk);
            const diffMs = now - waktuMasuk;
            const diffHrs = diffMs / 3600000;

            if (diffHrs < 8) {
                const sisa = (8 - diffHrs).toFixed(1);
                alert(`‚ö†Ô∏è Maaf ${nama}, Anda belum bisa absen pulang.\n\nMinimal kerja adalah 8 jam. Kurang ${sisa} jam lagi.`);
                location.reload();
                return;
            }

            const { error: errUpdate } = await FinexDB
                .from('presensi')
                .update({ 
                    waktu_pulang: now.toISOString(), 
                    status: 'Selesai' 
                })
                .eq('id', aktif.id);

            if (!errUpdate) {
                alert(`‚úÖ Terimakasih ${nama}!\nAbsen PULANG berhasil dicatat.\nTotal kerja: ${diffHrs.toFixed(1)} jam.`);
            } else {
                alert("Gagal mencatat pulang: " + errUpdate.message);
            }
        } else {
            // PROSES ABSEN MASUK
            // Cek apakah hari ini sudah pernah absen selesai (mencegah absen berkali-kali)
            const { data: sudahSelesai } = await FinexDB
                .from('presensi')
                .select('*')
                .eq('nama_staff', nama)
                .eq('tanggal', tglStr)
                .eq('status', 'Selesai')
                .maybeSingle();
            
            if (sudahSelesai) {
                alert(`Info: ${nama}, Anda sudah menyelesaikan shift hari ini.`);
                location.reload();
                return;
            }

            const { error: errInsert } = await FinexDB.from('presensi').insert([{ 
                nama_staff: nama, 
                tanggal: tglStr,
                waktu_masuk: now.toISOString(),
                lokasi_masuk: `${userLoc.lat},${userLoc.lon}`, 
                status: 'Aktif' 
            }]);

            if (!errInsert) {
                alert(`‚úÖ Selamat Bekerja ${nama}!\nAbsen MASUK berhasil dicatat pada ${now.toLocaleTimeString()}.`);
            } else {
                alert("Gagal mencatat masuk: " + errInsert.message);
            }
        }
        location.reload();
    }

    window.onload = init;
</script>
</body>
</html>
