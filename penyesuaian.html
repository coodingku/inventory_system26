<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Penyesuaian Stok</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --danger: #e74c3c; --success: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; background: var(--bg); }
        
        nav { width: 220px; background: var(--primary); color: white; min-height: 100vh; padding: 20px; position: fixed; }
        nav a { color: #bdc3c7; text-decoration: none; display: block; padding: 12px; border-radius: 5px; margin-bottom: 5px; }
        nav a.active { background: var(--accent); color: white; }

        main { flex: 1; margin-left: 260px; padding: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, select, textarea { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        .btn-submit { padding: 15px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-top: 15px; transition: 0.3s; }
        .btn-in { background: var(--success); }
        .btn-out { background: var(--danger); }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-in { background: #eafaf1; color: #2ecc71; }
        .badge-out { background: #fdedec; color: #e74c3c; }
    </style>
</head>
<body>

<nav>
    <h2>Finex Pos</h2>
    <div id="admin-menu">
        <a href="index.html" class="active">üìä Dashboard</a>
        
        <hr style="border: 0.5px solid #555; margin: 10px 0;">
        <div style="font-size: 10px; color: #888; margin-left: 12px; margin-bottom: 5px;">MASTER DATA</div>
        
        <a href="produk.html">üì¶ Produk</a>
        <a href="kategori.html">üìÅ Kategori</a>
        <a href="gudang.html">üè† Gudang</a>
        <a href="metode-pembayaran.html">üí≥ Metode Bayar</a>
        
        <hr style="border: 0.5px solid #555; margin: 10px 0;">
        <div style="font-size: 10px; color: #888; margin-left: 12px; margin-bottom: 5px;">OPERASIONAL</div>
        
        <a href="penyesuaian.html">üîÑ Stok In/Out</a>
        <a href="manajemen-user.html">üë• Manajemen User</a>
        <a href="pengaturan-biaya.html">‚öôÔ∏è Pengaturan</a>
    </div>
    
    <hr style="border: 0.5px solid #555; margin: 10px 0;">
    <a href="pos.html" style="background: #27ae60; color: white;">üõí Masuk Kasir</a>
    <div class="logout-btn" onclick="logout()" style="color:#e74c3c; cursor:pointer; padding: 12px;">üö™ Keluar</div>
</nav>
    <main>
        <h1>Penyesuaian Stok (Stok In/Out)</h1>

        <div class="card">
            <h3>Input Mutasi Stok</h3>
            <div class="form-grid">
                <div>
                    <label>Pilih Produk</label>
                    <select id="select-produk"></select>
                </div>
                <div>
                    <label>Jumlah</label>
                    <input type="number" id="input-jumlah" placeholder="0">
                </div>
                <div>
                    <label>Tipe Transaksi</label>
                    <select id="select-tipe">
                        <option value="IN">Stok Masuk (Barang Baru/Retur)</option>
                        <option value="OUT">Stok Keluar (Rusak/Hilang/Expired)</option>
                    </select>
                </div>
            </div>
            <div style="margin-top:15px;">
                <label>Keterangan / Alasan</label>
                <textarea id="input-keterangan" rows="2" placeholder="Contoh: Barang datang dari supplier A"></textarea>
            </div>
            <button class="btn-submit btn-in" id="btn-proses" onclick="prosesMutasi()">Proses Penyesuaian</button>
        </div>

        <div class="card">
            <h3>Riwayat Mutasi Terakhir</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Produk</th>
                        <th>Tipe</th>
                        <th>Jumlah</th>
                        <th>Keterangan</th>
                        <th>Oleh</th>
                    </tr>
                </thead>
                <tbody id="tabel-riwayat">
                    </tbody>
            </table>
        </div>
    </main>

    <script>
        // 1. LETAKKAN DI SINI (PALING ATAS)
        const userRole = localStorage.getItem('user_role');
        const userPath = window.location.pathname;

        if (!userRole) {
            window.location.href = "login.html";
        }

        // Proteksi halaman admin dari kasir
        const adminPages = ['index.html', 'pengaturan-biaya.html', 'metode-pembayaran.html', 'manajemen-user.html', 'produk.html'];
        const isAdminPage = adminPages.some(page => userPath.includes(page));

        if (userRole === 'kasir' && isAdminPage) {
            alert("Akses Ditolak! Anda bukan Admin.");
            window.location.href = "pos.html";
        }
        
        const SB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
        const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

        async function init() {
            // Load Produk ke Dropdown
            const { data: produk } = await supabaseClient.from('produk').select('id, nama_barang, stok_sekarang');
            const select = document.getElementById('select-produk');
            produk.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.nama_barang} (Stok: ${p.stok_sekarang})</option>`;
            });

            muatRiwayat();
        }

        async function muatRiwayat() {
            const { data } = await supabaseClient
                .from('riwayat_stok')
                .select('*, produk(nama_barang)')
                .order('created_at', { ascending: false })
                .limit(10);
            
            const tbody = document.getElementById('tabel-riwayat');
            tbody.innerHTML = '';
            data.forEach(r => {
                const tgl = new Date(r.created_at).toLocaleString('id-ID');
                const badge = r.tipe === 'IN' ? 'badge-in' : 'badge-out';
                tbody.innerHTML += `
                    <tr>
                        <td>${tgl}</td>
                        <td><b>${r.produk.nama_barang}</b></td>
                        <td><span class="badge ${badge}">${r.tipe}</span></td>
                        <td>${r.jumlah}</td>
                        <td>${r.keterangan || '-'}</td>
                        <td>${r.admin_nama}</td>
                    </tr>`;
            });
        }

        async function prosesMutasi() {
            const produkId = document.getElementById('select-produk').value;
            const jumlah = parseInt(document.getElementById('input-jumlah').value);
            const tipe = document.getElementById('select-tipe').value;
            const ket = document.getElementById('input-keterangan').value;
            const admin = localStorage.getItem('user_name') || 'System';

            if (!jumlah || jumlah <= 0) return alert("Jumlah harus lebih dari 0");

            // 1. Ambil stok sekarang
            const { data: p } = await supabaseClient.from('produk').select('stok_sekarang').eq('id', produkId).single();
            
            // 2. Hitung stok baru
            let stokBaru = (tipe === 'IN') ? p.stok_sekarang + jumlah : p.stok_sekarang - jumlah;
            if (stokBaru < 0) return alert("Gagal! Stok tidak cukup untuk dikurangi.");

            // 3. Update tabel produk
            await supabaseClient.from('produk').update({ stok_sekarang: stokBaru }).eq('id', produkId);

            // 4. Catat di riwayat_stok
            await supabaseClient.from('riwayat_stok').insert([{
                produk_id: produkId,
                tipe: tipe,
                jumlah: jumlah,
                keterangan: ket,
                admin_nama: admin
            }]);

            alert("Stok Berhasil Diperbarui!");
            location.reload();
        }

        window.onload = init;
    </script>
</body>
</html>
