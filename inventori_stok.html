<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventori & Aset | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="supabase-init.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #e91e63; --bg: #f4f7f6; --white: #ffffff; --success: #27ae60; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        /* Sidebar Navigation */
        nav { width: 250px; background: var(--primary); color: white; padding: 20px; height: 100vh; position: fixed; box-sizing: border-box; display: flex; flex-direction: column; z-index: 100; }
        nav h2 { color: var(--accent); text-align: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        nav a { color: #bdc3c7; text-decoration: none; padding: 12px; border-radius: 8px; margin-bottom: 5px; display: block; font-size: 14px; transition: 0.3s; }
        nav a:hover, nav a.active { background: var(--accent); color: white; }

        main { flex: 1; margin-left: 250px; padding: 40px; box-sizing: border-box; }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .grid-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 5px solid var(--accent); }
        .stat-card small { color: #666; font-size: 12px; font-weight: bold; }
        .stat-card h2 { margin: 5px 0 0 0; color: var(--primary); font-size: 24px; }

        .card-table { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-size: 13px; border-bottom: 2px solid #eee; color: #666; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }
        
        .low-stock { background: #fffafa; }
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .badge-ok { background: #e8f5e9; color: #2e7d32; }
        .badge-low { background: #ffebee; color: #c62828; }

        .btn-update { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-update:hover { background: var(--accent); }
        .btn-refresh { background: white; border: 1px solid #ddd; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .user-info { margin-top: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 12px; color: #ddd; }
    </style>
</head>
<body>

<nav>
    <h2 id="store-name-display">Finex Pos</h2>
    <a href="dashboard.html">ðŸ“Š Dashboard</a>
    <a href="produk.html">ðŸ“¦ Produk</a>
    <a href="pembelian.html">ðŸ“¥ Pembelian (PO)</a>
    <a href="laporan-pembelian.html">ðŸ“‘ Laporan Pembelian</a>
    <a href="inventori_stok.html" class="active">ðŸ“¦ Inventori Stok</a>
    <hr style="border: 0.5px solid #555; margin: 10px 0;">
    <a href="pos.html" style="background: var(--success); color: white; text-align: center;">ðŸ›’ Kasir</a>

    <div class="user-info">
        <small>USER:</small> <b id="display-user-nav">...</b>
    </div>
    <a href="#" onclick="logout()" style="color:var(--danger); font-size: 12px; padding: 10px; text-align: center;">ðŸšª Keluar</a>
</nav>

<main>
    <div class="header-box">
        <h1>Manajemen Stok & Valuasi Aset</h1>
        <button class="btn-refresh" onclick="loadInventory()">ðŸ”„ Refresh Data</button>
    </div>

    <div class="grid-stats">
        <div class="stat-card">
            <small>Total Item Produk</small>
            <h2 id="total-items">0</h2>
        </div>
        <div class="stat-card" style="border-left-color: var(--success);">
            <small>Total Nilai Aset (Harga Beli)</small>
            <h2 id="total-asset-value">Rp 0</h2>
        </div>
        <div class="stat-card" style="border-left-color: var(--warning);">
            <small>Item Stok Menipis (< 10)</small>
            <h2 id="total-low-stock">0</h2>
        </div>
    </div>

    <div class="card-table">
        <h3>Daftar Produk & Valuasi Stok</h3>
        <table>
            <thead>
                <tr>
                    <th>Nama Barang</th>
                    <th>Harga Beli</th>
                    <th>Stok</th>
                    <th>Satuan</th>
                    <th>Nilai Aset</th>
                    <th>Status</th>
                    <th style="text-align: center;">Aksi</th>
                </tr>
            </thead>
            <tbody id="inventory-body">
                </tbody>
        </table>
    </div>
</main>

<script>
    // Variabel 'db' disediakan secara dinamis oleh supabase-init.js

    window.onload = loadInventory;

    async function loadInventory() {
        // Menggunakan 'db' pelanggan
        const { data: produk, error } = await db.from('produk').select('*').order('nama_barang');

        if (error) return alert("Gagal muat stok: " + error.message);

        let html = '';
        let totalAsset = 0;
        let lowStockCount = 0;

        produk.forEach(p => {
            const hrgBeli = p.harga_beli || 0;
            const nilaiAset = (p.stok_sekarang || 0) * hrgBeli;
            totalAsset += nilaiAset;

            const isLow = p.stok_sekarang < 10;
            if (isLow) lowStockCount++;

            html += `
                <tr class="${isLow ? 'low-stock' : ''}">
                    <td><strong>${p.nama_barang}</strong></td>
                    <td>Rp ${hrgBeli.toLocaleString('id-ID')}</td>
                    <td>${p.stok_sekarang}</td>
                    <td>pcs</td>
                    <td><strong>Rp ${nilaiAset.toLocaleString('id-ID')}</strong></td>
                    <td>
                        <span class="badge ${isLow ? 'badge-low' : 'badge-ok'}">
                            ${isLow ? 'Stok Rendah' : 'Tersedia'}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn-update" onclick="updateStok('${p.id}', '${p.nama_barang}', ${p.stok_sekarang})">âž• Stock Adjustment</button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('inventory-body').innerHTML = html || '<tr><td colspan="7" style="text-align:center;">Tidak ada data produk.</td></tr>';
        document.getElementById('total-items').innerText = produk.length;
        document.getElementById('total-asset-value').innerText = "Rp " + totalAsset.toLocaleString('id-ID');
        document.getElementById('total-low-stock').innerText = lowStockCount;
    }

    async function updateStok(id, nama, stokSkrg) {
        const tambah = prompt(`Penyesuaian stok untuk ${nama}.\nMasukkan jumlah (gunakan angka negatif untuk mengurangi, misal: -5):`, "0");
        if (tambah === null || tambah === "" || isNaN(tambah)) return;

        const penyesuaian = parseInt(tambah);
        const totalBaru = parseInt(stokSkrg) + penyesuaian;

        if (totalBaru < 0) return alert("Stok tidak boleh kurang dari 0!");

        const { error } = await db.from('produk').update({ stok_sekarang: totalBaru }).eq('id', id);

        if (!error) {
            alert("Berhasil melakukan penyesuaian stok!");
            loadInventory();
        } else {
            alert("Gagal update: " + error.message);
        }
    }

    function logout() {
        if(confirm("Keluar dari sistem?")) {
            sessionStorage.clear();
            localStorage.clear();
            window.location.replace('login.html');
        }
    }
</script>
</body>
</html>
