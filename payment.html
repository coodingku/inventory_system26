<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Pembayaran & Struk</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .pay-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 18px; box-sizing: border-box; margin-top: 10px; }
        .btn-finish { width: 100%; padding: 15px; background: var(--success); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        
        /* Styling Struk (Print-Friendly) */
        #receipt-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 100; }
        .receipt-paper { background: white; width: 300px; padding: 20px; font-family: 'Courier New', Courier, monospace; font-size: 12px; color: #000; }
        .receipt-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
        .receipt-line { display: flex; justify-content: space-between; margin-bottom: 5px; }
        
        @media print {
            body * { visibility: hidden; }
            #receipt-modal, #receipt-modal * { visibility: visible; }
            #receipt-modal { position: absolute; left: 0; top: 0; background: white; }
            .btn-print-action { display: none; }
        }
    </style>
</head>
<body>

    <div class="pay-card">
        <h2>Pembayaran</h2>
        <p id="display-method" style="font-weight: bold; color: var(--success);"></p>
        <div style="font-size: 14px; color: #7f8c8d;">Total Tagihan</div>
        <div style="font-size: 32px; font-weight: 900;" id="total-tagihan">Rp 0</div>

        <div id="cash-area">
            <input type="number" id="input-bayar" placeholder="Masukkan Uang Tunai" onkeyup="hitungKembalian()">
            <div id="kembalian-box" style="margin-top:15px; display:none;">
                <small>Kembalian</small>
                <div id="val-kembalian" style="font-size: 20px; font-weight: bold; color: #2980b9;">Rp 0</div>
            </div>
        </div>

        <button class="btn-finish" id="btn-proses" onclick="prosesTransaksi()">SELESAIKAN</button>
    </div>

    <div id="receipt-modal">
        <div class="receipt-paper" id="printable-receipt">
            <div class="receipt-header">
                <h3 style="margin:0">FINEX POS</h3>
                <p style="margin:5px 0">Jl. Raya Kantin No. 01</p>
                <small id="rcp-inv"></small>
            </div>
            <div id="rcp-items" style="border-bottom: 1px dashed #000; padding-bottom: 10px;"></div>
            <div style="margin-top:10px">
                <div class="receipt-line"><span>Total</span><span id="rcp-total"></span></div>
                <div class="receipt-line"><span>Bayar</span><span id="rcp-bayar"></span></div>
                <div class="receipt-line"><span>Kembali</span><span id="rcp-kembali"></span></div>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <p>Terima Kasih Atas Kunjungan Anda</p>
                <div class="btn-print-action">
                    <button onclick="window.print()" style="padding:5px 10px;">Cetak Struk</button>
                    <button onclick="window.location.href='pos.html'" style="padding:5px 10px;">Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
        const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

        const cart = JSON.parse(sessionStorage.getItem('pay_cart') || '[]');
        const total = parseInt(sessionStorage.getItem('pay_total') || '0');
        const metode = sessionStorage.getItem('pay_method') || 'Tunai';

        document.getElementById('total-tagihan').innerText = "Rp " + total.toLocaleString();
        document.getElementById('display-method').innerText = "Metode: " + metode;
        if(metode !== 'Tunai') document.getElementById('cash-area').style.display = 'none';

        function hitungKembalian() {
            const bayar = parseInt(document.getElementById('input-bayar').value || 0);
            const kembalian = bayar - total;
            document.getElementById('kembalian-box').style.display = bayar > 0 ? 'block' : 'none';
            document.getElementById('val-kembalian').innerText = "Rp " + (kembalian < 0 ? 0 : kembalian).toLocaleString();
        }

        async function prosesTransaksi() {
            const bayar = parseInt(document.getElementById('input-bayar').value || total);
            if (metode === 'Tunai' && bayar < total) return alert("Uang tidak cukup!");

            try {
                const noInv = "INV-" + Date.now();
                // 1. Simpan Penjualan
                const { data: sales } = await supabaseClient.from('penjualan').insert([{
                    no_invoice: noInv, grand_total: total, metode_pembayaran: metode, subtotal: total
                }]).select().single();

                // 2. Simpan Detail & Update Stok
                let itemHtml = '';
                for (const item of cart) {
                    await supabaseClient.from('penjualan_detail').insert([{
                        penjualan_id: sales.id, produk_id: item.id, nama_barang: item.nama_barang,
                        harga_satuan: item.harga_jual, qty: item.qty, subtotal_item: (item.harga_jual * item.qty)
                    }]);
                    
                    const { data: p } = await supabaseClient.from('produk').select('stok_sekarang').eq('id', item.id).single();
                    await supabaseClient.from('produk').update({ stok_sekarang: p.stok_sekarang - item.qty }).eq('id', item.id);
                    
                    itemHtml += `<div class="receipt-line"><span>${item.nama_barang} x${item.qty}</span><span>${(item.harga_jual * item.qty).toLocaleString()}</span></div>`;
                }

                // Tampilkan Struk
                document.getElementById('rcp-inv').innerText = noInv;
                document.getElementById('rcp-items').innerHTML = itemHtml;
                document.getElementById('rcp-total').innerText = total.toLocaleString();
                document.getElementById('rcp-bayar').innerText = bayar.toLocaleString();
                document.getElementById('rcp-kembali').innerText = (bayar - total).toLocaleString();
                document.getElementById('receipt-modal').style.display = 'flex';

            } catch (err) { alert(err.message); }
        }
    </script>
</body>
</html>
