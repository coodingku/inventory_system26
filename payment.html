<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finex Pos | Pembayaran & Struk</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        
        /* Area Pembayaran */
        .pay-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .total-amount { font-size: 36px; font-weight: 900; color: var(--primary); margin: 10px 0 20px 0; }
        input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 12px; font-size: 20px; box-sizing: border-box; margin-top: 10px; outline: none; }
        .btn-finish { width: 100%; padding: 15px; background: var(--success); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        /* Modal Struk */
        #receipt-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 1000; }
        .receipt-paper { background: white; width: 320px; padding: 25px; font-family: 'Courier New', monospace; color: #000; text-align: left; }
        .receipt-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 15px; }
        .receipt-line { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }
        .receipt-total-section { border-top: 1px dashed #000; margin-top: 10px; padding-top: 10px; }
        
        .btn-group-receipt { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
        .btn-print { background: #34495e; color: white; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; }
        .btn-done { background: var(--success); color: white; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            #receipt-modal { position: absolute; top: 0; background: white; display: flex !important; }
            .receipt-paper { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

    <div class="pay-card no-print">
        <h2 style="margin:0">Pembayaran</h2>
        <p id="display-method" style="color: var(--success); font-weight: bold; margin-top: 5px;"></p>
        
        <div style="margin-top: 20px; color: #7f8c8d; font-size: 14px;">Total Tagihan</div>
        <div class="total-amount" id="total-tagihan">Rp 0</div>

        <div id="cash-area">
            <input type="number" id="input-bayar" placeholder="Masukkan Uang Tunai" onkeyup="hitungKembalian()">
            <div id="kembalian-box" style="margin-top:20px; display:none; background:#f9f9f9; padding:15px; border-radius:10px;">
                <span style="font-size:13px; color:#666;">Kembalian</span>
                <div id="val-kembalian" style="font-size: 24px; font-weight: bold; color: #2980b9;">Rp 0</div>
            </div>
        </div>

        <button class="btn-finish" id="btn-proses" onclick="prosesTransaksi()">SELESAIKAN TRANSAKSI</button>
        <button onclick="window.history.back()" style="background:none; border:none; color:#999; margin-top:15px; cursor:pointer;">Batal</button>
    </div>

    <div id="receipt-modal">
        <div class="receipt-paper">
            <div class="receipt-header">
                <h2 style="margin:0">FINEX POS</h2>
                <p style="margin:5px 0">Kantin Sekolah</p>
                <small id="rcp-inv"></small><br>
                <small id="rcp-date"></small>
            </div>
            
            <div id="rcp-items" style="margin-bottom:10px;"></div>
            
            <div class="receipt-total-section">
                <div class="receipt-line"><span>Subtotal</span><span id="rcp-subtotal"></span></div>
                <div class="receipt-line" id="row-rcp-diskon" style="display:none; color:red;">
                    <span>Diskon</span><span id="rcp-diskon"></span>
                </div>
                <div class="receipt-line" id="row-rcp-pajak" style="display:none;">
                    <span>Pajak (PPN)</span><span id="rcp-pajak"></span>
                </div>
                <div class="receipt-line" style="font-weight:bold; font-size:16px; border-top:1px solid #eee; margin-top:5px; padding-top:5px;">
                    <span>TOTAL</span><span id="rcp-grand-total"></span>
                </div>
            </div>

            <div style="margin-top:10px; border-top: 1px dashed #000; padding-top:10px;">
                <div class="receipt-line"><span>Metode</span><span id="rcp-metode"></span></div>
                <div class="receipt-line"><span>Bayar</span><span id="rcp-bayar"></span></div>
                <div class="receipt-line"><span>Kembali</span><span id="rcp-kembali"></span></div>
            </div>

            <div style="text-align:center; margin-top:25px; font-size:10px;">
                <p>Terima Kasih Atas Kunjungan Anda</p>
            </div>

            <div class="btn-group-receipt no-print">
                <button class="btn-print" onclick="window.print()">Cetak Struk</button>
                <button class="btn-done" onclick="window.location.href='pos.html'">Selesai</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
        const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

        // Menangkap data dari sessionStorage (Pastikan di pos.html data ini sudah di-set)
        const cart = JSON.parse(sessionStorage.getItem('pay_cart') || '[]');
        const grandTotal = parseInt(sessionStorage.getItem('pay_total') || '0');
        const payMethod = sessionStorage.getItem('pay_method') || 'Tunai';
        
        // Data diskon & pajak yang sering terlewat
        const subtotalKotor = parseInt(sessionStorage.getItem('pay_subtotal') || grandTotal);
        const diskonBill = parseInt(sessionStorage.getItem('pay_diskon_global') || '0');
        const pajakNominal = parseInt(sessionStorage.getItem('pay_pajak') || '0');

        document.getElementById('total-tagihan').innerText = "Rp " + grandTotal.toLocaleString();
        document.getElementById('display-method').innerText = "Metode: " + payMethod;

        if (payMethod !== 'Tunai') {
            document.getElementById('cash-area').style.display = 'none';
        }

        function hitungKembalian() {
            const bayar = parseInt(document.getElementById('input-bayar').value || 0);
            const kembalian = bayar - grandTotal;
            document.getElementById('kembalian-box').style.display = bayar > 0 ? 'block' : 'none';
            document.getElementById('val-kembalian').innerText = "Rp " + (kembalian < 0 ? 0 : kembalian).toLocaleString();
        }

        async function prosesTransaksi() {
            const btn = document.getElementById('btn-proses');
            const bayarManual = parseInt(document.getElementById('input-bayar').value || grandTotal);
            
            if (payMethod === 'Tunai' && bayarManual < grandTotal) return alert("Uang tidak cukup!");

            btn.disabled = true;
            btn.innerText = "Menyimpan...";

            try {
                const noInv = "INV-" + Date.now();
                
                // 1. Simpan ke tabel Penjualan
                const { data: sale, error: errSale } = await supabaseClient.from('penjualan').insert([{
                    no_invoice: noInv,
                    subtotal: subtotalKotor,
                    diskon_global: diskonBill,
                    pajak_ppn: pajakNominal,
                    grand_total: grandTotal,
                    metode_pembayaran: payMethod
                }]).select().single();

                if (errSale) throw errSale;

                // 2. Loop Detail & Potong Stok
                let itemRows = '';
                for (const item of cart) {
                    await supabaseClient.from('penjualan_detail').insert([{
                        penjualan_id: sale.id,
                        produk_id: item.id,
                        nama_barang: item.nama_barang,
                        harga_satuan: item.harga_jual,
                        qty: item.qty,
                        subtotal_item: (item.harga_jual * item.qty)
                    }]);

                    const { data: p } = await supabaseClient.from('produk').select('stok_sekarang').eq('id', item.id).single();
                    await supabaseClient.from('produk').update({ stok_sekarang: p.stok_sekarang - item.qty }).eq('id', item.id);

                    itemRows += `<div class="receipt-line">
                        <span>${item.nama_barang} (x${item.qty})</span>
                        <span>${(item.harga_jual * item.qty).toLocaleString()}</span>
                    </div>`;
                }

                // 3. Tampilkan Struk
                tampilkanStruk(noInv, itemRows, bayarManual);

            } catch (err) {
                alert("Gagal memproses transaksi: " + err.message);
                btn.disabled = false;
                btn.innerText = "SELESAIKAN TRANSAKSI";
            }
        }

        function tampilkanStruk(inv, items, bayar) {
            document.getElementById('rcp-inv').innerText = inv;
            document.getElementById('rcp-date').innerText = new Date().toLocaleString('id-ID');
            document.getElementById('rcp-items').innerHTML = items;
            
            // Subtotal Kotor
            document.getElementById('rcp-subtotal').innerText = subtotalKotor.toLocaleString();
            
            // Tampilkan Diskon jika ada
            if(diskonBill > 0) {
                document.getElementById('row-rcp-diskon').style.display = 'flex';
                document.getElementById('rcp-diskon').innerText = "-" + diskonBill.toLocaleString();
            }
            
            // Tampilkan Pajak jika ada
            if(pajakNominal > 0) {
                document.getElementById('row-rcp-pajak').style.display = 'flex';
                document.getElementById('rcp-pajak').innerText = pajakNominal.toLocaleString();
            }

            document.getElementById('rcp-grand-total').innerText = grandTotal.toLocaleString();
            document.getElementById('rcp-metode').innerText = payMethod;
            document.getElementById('rcp-bayar').innerText = bayar.toLocaleString();
            document.getElementById('rcp-kembali').innerText = (bayar - grandTotal).toLocaleString();

            document.getElementById('receipt-modal').style.display = 'flex';
        }
            // Fungsi Kirim Data ke Printer Bluetooth
async function cetakStrukBluetooth(dataTransaksi) {
    try {
        // 1. Request perangkat bluetooth
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }], // Service printer thermal umum
            optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');

        // 2. Format Struk (ESC/POS)
        let struk = "\x1B\x61\x01"; // Align Center
        struk += "FINEX POS - KANTIN\n";
        struk += "--------------------------------\n";
        struk += "\x1B\x61\x00"; // Align Left
        struk += `No: ${dataTransaksi.no_nota}\n`;
        struk += `Kasir: ${localStorage.getItem('user_name')}\n`;
        struk += `Tgl: ${new Date().toLocaleString()}\n`;
        struk += "--------------------------------\n";

        dataTransaksi.items.forEach(item => {
            struk += `${item.nama_barang}\n`;
            struk += `${item.qty} x ${item.harga.toLocaleString()} = ${item.subtotal.toLocaleString()}\n`;
        });

        struk += "--------------------------------\n";
        struk += `TOTAL: Rp ${dataTransaksi.total.toLocaleString()}\n`;
        struk += `BAYAR: Rp ${dataTransaksi.bayar.toLocaleString()}\n`;
        struk += `KEMBALI: Rp ${dataTransaksi.kembali.toLocaleString()}\n`;
        struk += "--------------------------------\n";
        struk += "\x1B\x61\x01"; // Center
        struk += "Terima Kasih!\n\n\n\n"; // Beri ruang potong kertas

        // 3. Kirim ke Printer
        const encoder = new TextEncoder();
        const data = encoder.encode(struk);
        await characteristic.writeValue(data);
        
        alert("Struk berhasil dicetak!");
    } catch (error) {
        console.error("Printer Error: ", error);
        alert("Gagal cetak struk: Pastikan Bluetooth aktif & pilih printer yang benar.");
    }
}
        
    </script>
</body>
</html>
