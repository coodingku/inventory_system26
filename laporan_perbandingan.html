<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Perbandingan | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="supabase-init.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        nav { width: 240px; background: var(--primary); color: white; padding: 20px; height: 100vh; position: fixed; box-sizing: border-box; z-index: 100; }
        nav h2 { color: var(--accent); text-align: center; margin-bottom: 30px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        nav a { color: #bdc3c7; text-decoration: none; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: block; font-size: 14px; transition: 0.3s; }
        nav a:hover { background: rgba(255,255,255,0.1); color: white; }
        nav a.active { background: var(--accent); color: white; }

        main { flex: 1; margin-left: 240px; padding: 40px; box-sizing: border-box; width: calc(100% - 240px); }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .filter-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; gap: 20px; align-items: center; margin-bottom: 25px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; background: #fff; cursor: pointer; min-width: 150px; }

        .grid-compare { display: grid; grid-template-columns: 1.5fr 1fr; gap: 25px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card h3 { margin-top: 0; color: var(--primary); font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .stat-box { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f9f9f9; }
        .stat-label { font-size: 14px; color: #666; }
        .stat-value { font-weight: bold; font-size: 16px; }
        
        .trend-up { color: var(--success); font-weight: bold; }
        .trend-down { color: var(--danger); font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-size: 13px; color: #333; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }
        .row-highlight { background: #f0f7ff; font-weight: bold; }

        .user-info { margin-top: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 12px; color: #ddd; }

        @media print { nav, .filter-card, .user-info { display: none !important; } main { margin-left: 0; } }
    </style>
</head>
<body>

<nav>
    <h2 id="store-name-display">Finex Pos</h2>
    <a href="dashboard.html">üìä Dashboard</a>
    <a href="pos.html">üõí Kasir</a>
    <a href="laporan_perbandingan.html" class="active">üìà Bandingkan Bulan</a>
    <a href="laba_rugi.html">üí∞ Laba Rugi</a>
    <a href="audit_rekonsiliasi.html">üîç Audit Jurnal</a>

    <div class="user-info" style="margin-top: 20px;">
        <small>ADMIN:</small> <b id="display-user-nav">...</b>
    </div>
    <a href="#" onclick="logout()" style="color:var(--danger); font-size: 12px; padding: 10px; display: block; text-decoration: none;">üö™ Keluar</a>
</nav>

<main>
    <div class="header-section">
        <h1>Laporan Perbandingan Performa</h1>
        <button onclick="window.print()" style="padding:10px 15px; border-radius:8px; border:1px solid #ddd; cursor:pointer; background:white;">üñ®Ô∏è Cetak</button>
    </div>

    <div class="filter-card">
        <div class="filter-group">
            <label>PILIH BULAN:</label>
            <select id="selectMonth" onchange="loadComparison()"></select>
        </div>
        <div class="filter-group">
            <label>TAHUN:</label>
            <select id="selectYear" onchange="loadComparison()">
                <option value="2026" selected>2026</option>
                <option value="2027">2027</option>
            </select>
        </div>
        <div style="flex:1; text-align: right; font-size: 12px; color: #666; font-style: italic;">
            Data dibandingkan secara otomatis dengan satu bulan sebelumnya.
        </div>
    </div>

    <div class="grid-compare">
        <div class="card">
            <h3>Visualisasi Tren</h3>
            <div style="height: 300px;">
                <canvas id="chartCompare"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>Ringkasan Pertumbuhan</h3>
            <div id="summary-content">
                <p>Menganalisis data...</p>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Detail Perbandingan Angka</h3>
        <table>
            <thead>
                <tr>
                    <th>Kategori Keuangan</th>
                    <th id="label-prev">Bulan Sebelumnya</th>
                    <th id="label-curr">Bulan Terpilih</th>
                    <th>Pertumbuhan (%)</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="4" style="text-align:center;">Memuat data jurnal...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<script>
    // Variabel 'db' disediakan secara dinamis oleh supabase-init.js
    const bulanNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    let myChart = null;

    window.onload = () => {
        const monthSel = document.getElementById('selectMonth');
        const currentMonth = new Date().getMonth(); 
        
        bulanNames.forEach((name, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = name;
            if (i === currentMonth) opt.selected = true;
            monthSel.appendChild(opt);
        });

        loadComparison();
    };

    async function loadComparison() {
        const currM = parseInt(document.getElementById('selectMonth').value);
        const year = parseInt(document.getElementById('selectYear').value);
        
        const prevM = currM === 0 ? 11 : currM - 1;
        const prevYear = currM === 0 ? year - 1 : year;

        // Penentuan rentang tanggal dinamis
        const startDate = `${prevYear}-${(prevM + 1).toString().padStart(2, '0')}-01T00:00:00`;
        const lastDayCurr = new Date(year, currM + 1, 0).getDate();
        const endDate = `${year}-${(currM + 1).toString().padStart(2, '0')}-${lastDayCurr}T23:59:59`;

        try {
            // Menggunakan 'db' pelanggan aktif
            const { data: jurnal, error } = await db.from('jurnal_umum')
                .select('*')
                .gte('tanggal', startDate)
                .lte('tanggal', endDate);

            if (error) throw error;

            let stats = {
                prev: { sales: 0, expense: 0 },
                curr: { sales: 0, expense: 0 }
            };

            jurnal.forEach(j => {
                const d = new Date(j.tanggal);
                const m = d.getMonth();
                const y = d.getFullYear();

                if (m === currM && y === year) {
                    if (j.kode_akun.startsWith('4')) stats.curr.sales += parseFloat(j.kredit || 0);
                    if (j.kode_akun.startsWith('5') || j.kode_akun.startsWith('6')) stats.curr.expense += parseFloat(j.debit || 0);
                } else if (m === prevM && y === prevYear) {
                    if (j.kode_akun.startsWith('4')) stats.prev.sales += parseFloat(j.kredit || 0);
                    if (j.kode_akun.startsWith('5') || j.kode_akun.startsWith('6')) stats.prev.expense += parseFloat(j.debit || 0);
                }
            });

            const pProfit = stats.prev.sales - stats.prev.expense;
            const cProfit = stats.curr.sales - stats.curr.expense;

            const getGrowth = (oldVal, newVal) => {
                if (oldVal === 0) return newVal > 0 ? 100 : 0;
                return ((newVal - oldVal) / oldVal * 100).toFixed(1);
            };

            const gSales = getGrowth(stats.prev.sales, stats.curr.sales);
            const gProfit = getGrowth(pProfit, cProfit);

            document.getElementById('label-prev').innerText = bulanNames[prevM] + ' ' + prevYear;
            document.getElementById('label-curr').innerText = bulanNames[currM] + ' ' + year;

            document.getElementById('table-body').innerHTML = `
                <tr>
                    <td>Total Pendapatan (Omzet)</td>
                    <td>Rp ${stats.prev.sales.toLocaleString('id-ID')}</td>
                    <td>Rp ${stats.curr.sales.toLocaleString('id-ID')}</td>
                    <td class="${gSales >= 0 ? 'trend-up' : 'trend-down'}">${gSales > 0 ? '+' : ''}${gSales}%</td>
                </tr>
                <tr>
                    <td>Total Beban Pengeluaran</td>
                    <td>Rp ${stats.prev.expense.toLocaleString('id-ID')}</td>
                    <td>Rp ${stats.curr.expense.toLocaleString('id-ID')}</td>
                    <td>-</td>
                </tr>
                <tr class="row-highlight">
                    <td>Laba Bersih (Net Profit)</td>
                    <td>Rp ${pProfit.toLocaleString('id-ID')}</td>
                    <td>Rp ${cProfit.toLocaleString('id-ID')}</td>
                    <td class="${gProfit >= 0 ? 'trend-up' : 'trend-down'}">${gProfit > 0 ? '+' : ''}${gProfit}%</td>
                </tr>
            `;

            renderSummaryAndChart(stats, pProfit, cProfit, prevM, currM);
        } catch (e) {
            console.error(e);
            document.getElementById('table-body').innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Gagal memuat data.</td></tr>`;
        }
    }

    function renderSummaryAndChart(stats, pProfit, cProfit, prevM, currM) {
        const statusProfit = cProfit >= pProfit ? 
            `<span class="trend-up">MENINGKAT üìà</span>` : 
            `<span class="trend-down">MENURUN üìâ</span>`;
        
        document.getElementById('summary-content').innerHTML = `
            <div class="stat-box"><span class="stat-label">Performa Laba:</span> <span class="stat-value">${statusProfit}</span></div>
            <div class="stat-box"><span class="stat-label">Selisih Nominal:</span> <span class="stat-value">Rp ${(cProfit - pProfit).toLocaleString('id-ID')}</span></div>
            <div class="stat-box"><span class="stat-label">Efisiensi Biaya:</span> <span class="stat-value">${stats.curr.expense < stats.prev.expense ? 'Lebih Hemat' : 'Meningkat'}</span></div>
        `;

        if (myChart) myChart.destroy();
        const ctx = document.getElementById('chartCompare').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [bulanNames[prevM], bulanNames[currM]],
                datasets: [
                    { label: 'Pendapatan', data: [stats.prev.sales, stats.curr.sales], backgroundColor: '#3498db' },
                    { label: 'Laba Bersih', data: [pProfit, cProfit], backgroundColor: '#2ecc71' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function logout() {
        if(confirm("Keluar dari sistem?")) {
            sessionStorage.clear();
            localStorage.clear();
            window.location.replace('login.html');
        }
    }
</script>
</body>
</html>
