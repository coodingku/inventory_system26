<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perbandingan Bulanan | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        nav { width: 240px; background: var(--primary); color: white; padding: 20px; height: 100vh; position: fixed; }
        nav h2 { color: var(--accent); text-align: center; margin-bottom: 30px; }
        nav a { color: #bdc3c7; text-decoration: none; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: block; font-size: 14px; }
        nav a:hover { background: rgba(255,255,255,0.1); color: white; }

        main { flex: 1; margin-left: 240px; padding: 40px; }
        .grid-compare { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .stat-box { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .stat-label { font-size: 14px; color: #666; }
        .stat-value { font-weight: bold; font-size: 16px; }
        
        .trend-up { color: #27ae60; font-size: 12px; font-weight: bold; }
        .trend-down { color: #e74c3c; font-size: 12px; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; }
        th { background: #f8f9fa; padding: 12px; text-align: left; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
    </style>
</head>
<body>

<nav>
    <h2>Finex Pos</h2>
    <a href="dashboard.html">üìä Dashboard</a>
    <a href="laporan_perbandingan.html" style="background:var(--accent); color:white;">üìà Bandingkan Bulan</a>
    <a href="laba_rugi.html">üí∞ Laba Rugi</a>
    <a href="audit_rekonsiliasi.html">üîç Audit Jurnal</a>
</nav>

<main>
    <h1>Perbandingan Performa Bisnis</h1>
    <p>Analisis pertumbuhan <strong>Januari 2026</strong> vs <strong>Februari 2026</strong></p>

    <div class="grid-compare">
        <div class="card">
            <canvas id="chartCompare"></canvas>
        </div>
        <div class="card">
            <h3>Ikhtisar Pertumbuhan</h3>
            <div id="summary-list">
                <p>Sedang menghitung data...</p>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Detail Angka (Rekonsiliasi Bulanan)</h3>
        <table>
            <thead>
                <tr>
                    <th>Keterangan</th>
                    <th>Januari 2026</th>
                    <th>Februari 2026</th>
                    <th>Pertumbuhan (%)</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</main>

<script>
    const URL_DB = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const KEY_DB = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    const FinexDB = window.supabase.createClient(URL_DB, KEY_DB);

    window.onload = loadComparison;

    async function loadComparison() {
        // Ambil semua jurnal dari awal tahun sampai sekarang
        const { data: jurnal } = await FinexDB.from('jurnal_umum')
            .select('*')
            .gte('tanggal', '2026-01-01T00:00:00')
            .lte('tanggal', '2026-02-28T23:59:59');

        let data = {
            jan: { sales: 0, expense: 0 },
            feb: { sales: 0, expense: 0 }
        };

        jurnal.forEach(j => {
            const bulan = new Date(j.tanggal).getMonth(); // 0 = Jan, 1 = Feb
            const nilai = parseFloat(j.debit || 0) + parseFloat(j.kredit || 0);

            if (bulan === 0) { // JANUARI
                if (j.kode_akun.startsWith('4')) data.jan.sales += parseFloat(j.kredit || 0);
                if (j.kode_akun.startsWith('5') || j.kode_akun.startsWith('6')) data.jan.expense += parseFloat(j.debit || 0);
            } else if (bulan === 1) { // FEBRUARI
                if (j.kode_akun.startsWith('4')) data.feb.sales += parseFloat(j.kredit || 0);
                if (j.kode_akun.startsWith('5') || j.kode_akun.startsWith('6')) data.feb.expense += parseFloat(j.debit || 0);
            }
        });

        const profitJan = data.jan.sales - data.jan.expense;
        const profitFeb = data.feb.sales - data.feb.expense;
        
        // Hitung persentase kenaikan
        const calcGrowth = (oldVal, newVal) => {
            if (oldVal === 0) return 0;
            return ((newVal - oldVal) / oldVal) * 100;
        };

        const growthSales = calcGrowth(data.jan.sales, data.feb.sales);
        const growthProfit = calcGrowth(profitJan, profitFeb);

        // Update Tabel
        document.getElementById('table-body').innerHTML = `
            <tr>
                <td>Total Pendapatan (Sales)</td>
                <td>Rp ${data.jan.sales.toLocaleString()}</td>
                <td>Rp ${data.feb.sales.toLocaleString()}</td>
                <td class="${growthSales >= 0 ? 'trend-up' : 'trend-down'}">${growthSales.toFixed(1)}%</td>
            </tr>
            <tr>
                <td>Total Beban/Biaya</td>
                <td>Rp ${data.jan.expense.toLocaleString()}</td>
                <td>Rp ${data.feb.expense.toLocaleString()}</td>
                <td>-</td>
            </tr>
            <tr style="font-weight:bold; background:#f0f7ff;">
                <td>Laba Bersih (Net Profit)</td>
                <td>Rp ${profitJan.toLocaleString()}</td>
                <td>Rp ${profitFeb.toLocaleString()}</td>
                <td class="${growthProfit >= 0 ? 'trend-up' : 'trend-down'}">${growthProfit.toFixed(1)}%</td>
            </tr>
        `;

        // Update Ringkasan
        document.getElementById('summary-list').innerHTML = `
            <div class="stat-box"><span class="stat-label">Status Profit:</span> <span class="stat-value" style="color:${profitFeb >= profitJan ? 'green' : 'red'}">${profitFeb >= profitJan ? 'Meningkat' : 'Menurun'}</span></div>
            <div class="stat-box"><span class="stat-label">Selisih Laba:</span> <span class="stat-value">Rp ${(profitFeb - profitJan).toLocaleString()}</span></div>
        `;

        // Render Chart
        new Chart(document.getElementById('chartCompare'), {
            type: 'bar',
            data: {
                labels: ['Januari', 'Februari'],
                datasets: [
                    { label: 'Pendapatan', data: [data.jan.sales, data.feb.sales], backgroundColor: '#3498db' },
                    { label: 'Laba Bersih', data: [profitJan, profitFeb], backgroundColor: '#2ecc71' }
                ]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
    }
</script>
</body>
</html>
