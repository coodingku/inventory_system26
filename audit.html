<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Audit Terpisah</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        .grid-btn { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-scan { background: var(--primary); width: 100%; }
        .btn-hpp { background: var(--danger); }
        .btn-beban { background: var(--warning); }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 11px; }
        .bg-hpp { background: var(--danger); }
        .bg-beban { background: var(--warning); }
        .loading-text { text-align: center; padding: 20px; color: var(--warning); font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>üéØ Audit Keuangan Terpisah</h2>
    <p>Gunakan halaman ini untuk mensinkronkan data HPP atau Beban secara massal tanpa merusak jurnal pendapatan.</p>
    
    <button class="btn btn-scan" id="btn-scan" onclick="runAudit()">üîç 1. Scan Data Database</button>
    
    <div id="result-area" style="display:none;">
        <div class="grid-btn">
            <button class="btn btn-hpp" onclick="fixHPPOnly()">üî• Update HPP Saja (5101 dll)</button>
            <button class="btn btn-beban" onclick="fixBebanOnly()">‚ö° Update Beban Saja (6xxx)</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>Tipe</th>
                    <th>Keterangan</th>
                    <th>Nominal</th>
                    <th>Sumber Dana</th>
                </tr>
            </thead>
            <tbody id="list-data"></tbody>
        </table>
    </div>
</div>

<script>
    let entriesHPP = [];
    let entriesBeban = [];

    async function runAudit() {
        const list = document.getElementById('list-data');
        const btnScan = document.getElementById('btn-scan');
        
        btnScan.innerText = "‚è≥ Sedang Men-scan...";
        btnScan.disabled = true;
        
        entriesHPP = [];
        entriesBeban = [];
        let html = '';

        try {
            // 1. SCAN HPP (Dinamis per Produk)
            const { data: sales } = await db.from('penjualan').select('id, no_invoice, created_at');
            for (let s of sales) {
                const { data: details } = await db.from('penjualan_detail').select('qty, produk_id').eq('penjualan_id', s.id);
                if (details) {
                    for (let d of details) {
                        const { data: prod } = await db.from('produk')
                            .select('harga_beli, akun_hpp, akun_persediaan')
                            .eq('id', d.produk_id).single();

                        if (prod && prod.akun_hpp && prod.akun_persediaan) {
                            let valHPP = Math.round(parseFloat(prod.harga_beli || 0) * d.qty);
                            if (valHPP > 0) {
                                html += `<tr><td>${new Date(s.created_at).toLocaleDateString()}</td><td><span class="badge bg-hpp">HPP</span></td><td>${s.no_invoice}</td><td>Rp ${valHPP.toLocaleString()}</td><td>Akun: ${prod.akun_persediaan}</td></tr>`;
                                
                                entriesHPP.push({ 
                                    date: s.created_at, 
                                    ref: s.no_invoice, 
                                    val: valHPP, 
                                    target: String(prod.akun_hpp), 
                                    source: String(prod.akun_persediaan) 
                                });
                            }
                        }
                    }
                }
            }

            // 2. SCAN BEBAN (Dinamis dari Pengeluaran)
            const { data: expenses } = await db.from('pengeluaran').select('*');
            if (expenses) {
                for (let e of expenses) {
                    // Cek tabel metode_pembayaran hanya jika e.metode ada nilainya
                    let sumberAkun = '1101'; // Default
                    if (e.metode) {
                        const { data: mtd } = await db.from('metode_pembayaran')
                            .select('kode_akun')
                            .eq('nama_metode', e.metode)
                            .maybeSingle();
                        if (mtd) sumberAkun = mtd.kode_akun;
                    }

                    let nominal = parseFloat(e.jumlah || 0);
                    let targetAkun = e.kode_akun_beban || '6101'; // Fallback ke beban umum

                    html += `<tr><td>${new Date(e.tanggal).toLocaleDateString()}</td><td><span class="badge bg-beban">BEBAN</span></td><td>${e.keterangan}</td><td>Rp ${nominal.toLocaleString()}</td><td>Akun: ${sumberAkun}</td></tr>`;
                    
                    entriesBeban.push({ 
                        date: e.tanggal, 
                        ref: 'EXP-' + e.id, 
                        val: nominal, 
                        target: String(targetAkun), 
                        source: String(sumberAkun) 
                    });
                }
            }

            list.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">Tidak ada data ditemukan.</td></tr>';
            document.getElementById('result-area').style.display = 'block';
        } catch (err) { 
            alert("Audit Error: " + err.message); 
        } finally {
            btnScan.innerText = "üîç 1. Scan Data Database";
            btnScan.disabled = false;
        }
    }

    // Fungsi Trigger untuk HPP
    function fixHPPOnly() {
        if (confirm("Sinkronisasi ulang semua HPP? Jurnal HPP lama akan dihapus dan diganti yang baru.")) {
            syncProcess(entriesHPP);
        }
    }

    // Fungsi Trigger untuk Beban
    function fixBebanOnly() {
        if (confirm("Sinkronisasi ulang semua Beban? Jurnal Pengeluaran lama akan dihapus dan diganti yang baru.")) {
            syncProcess(entriesBeban);
        }
    }

    // Fungsi Core Sinkronisasi (Dinamis)
  async function syncProcess(dataArray) {
        if (dataArray.length === 0) return alert("Tidak ada data untuk disinkronkan.");
        
        try {
            // 1. Ambil DAFTAR AKUN VALID dari database pelanggan
            const { data: currentAccounts, error: errAcc } = await db.from('akun').select('kode_akun');
            if (errAcc) throw new Error("Gagal memvalidasi daftar akun: " + errAcc.message);
            
            // Buat Set agar pencarian cepat
            const validAccountSet = new Set(currentAccounts.map(a => String(a.kode_akun)));

            const refs = dataArray.map(x => x.ref);
            const akunTerkait = [...new Set([...dataArray.map(x => String(x.target)), ...dataArray.map(x => String(x.source))])];

            // 2. Bersihkan Jurnal Lama
            if (refs.length > 0) {
                await db.from('jurnal_umum').delete()
                    .in('no_bukti', refs)
                    .in('kode_akun', akunTerkait);
            }

            // 3. Susun Batch Jurnal Baru dengan PROTEKSI
            let batch = [];
            let akunBermasalah = new Set();

            for (let item of dataArray) {
                const target = String(item.target);
                const source = String(item.source);

                // CEK: Apakah akun ada di database?
                if (!validAccountSet.has(target)) { akunBermasalah.add(target); continue; }
                if (!validAccountSet.has(source)) { akunBermasalah.add(source); continue; }

                if (item.val > 0) {
                    batch.push({ 
                        tanggal: item.date, no_bukti: item.ref, kode_akun: target, 
                        keterangan: 'Audit Auto: ' + item.ref, debit: Math.round(item.val), kredit: 0 
                    });
                    batch.push({ 
                        tanggal: item.date, no_bukti: item.ref, kode_akun: source, 
                        keterangan: 'Audit Penyeimbang', debit: 0, kredit: Math.round(item.val) 
                    });
                }
            }

            // 4. Masukkan ke Database
            if (batch.length > 0) {
                const { error } = await db.from('jurnal_umum').insert(batch);
                if (error) throw error;
                
                let pesan = "‚úÖ Sinkronisasi Berhasil!";
                if (akunBermasalah.size > 0) {
                    pesan += `\n\n‚ö†Ô∏è Peringatan: Beberapa baris dilewati karena Kode Akun berikut belum dibuat di Daftar Akun: ${Array.from(akunBermasalah).join(', ')}`;
                }
                alert(pesan);
                runAudit(); 
            } else {
                alert("‚ùå Gagal: Tidak ada data yang bisa dimasukkan. Pastikan kode akun (seperti " + Array.from(akunBermasalah).join(', ') + ") sudah didaftarkan di halaman Manajemen Akun.");
            }
        } catch (err) { 
            alert("Gagal Sync: " + err.message); 
            console.error(err);
        }
    }
</script>
</body>
</html>
