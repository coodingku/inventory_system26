<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Audit Beban & HPP</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>
    <style>
        :root { --primary: #2c3e50; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 900px; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-scan { background: var(--primary); width: 100%; margin-bottom: 10px; }
        .btn-fix { background: var(--success); width: 100%; margin-top: 20px; font-size: 16px; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 11px; }
        .bg-hpp { background: var(--danger); }
        .bg-beban { background: var(--warning); }
    </style>
</head>
<body>

<div class="card">
    <h2>üéØ Sinkronisasi Beban & HPP</h2>
    <p>Gunakan ini untuk memulihkan angka <b>Beban Operasional</b> dan <b>HPP</b> di laporan PDF.</p>
    
    <button class="btn btn-scan" id="btn-scan" onclick="runAudit()">üîç Scan Beban & HPP</button>
    
    <div id="result-area" style="display:none;">
        <table>
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>Kategori</th>
                    <th>Keterangan</th>
                    <th>Nominal</th>
                    <th>Akun</th>
                </tr>
            </thead>
            <tbody id="list-data"></tbody>
        </table>

        <button class="btn btn-fix" id="btn-fix" onclick="fixData()">üî• Sinkronkan ke Jurnal Umum</button>
    </div>
</div>

<script>
    let finalizedEntries = [];

    async function runAudit() {
        const list = document.getElementById('list-data');
        finalizedEntries = [];
        let html = '';

        try {
            // 1. SCAN HPP DARI PRODUK TERJUAL
            const { data: sales } = await db.from('penjualan').select('id, no_invoice, created_at');
            for (let s of sales) {
                let totalHPP = 0;
                const { data: details } = await db.from('penjualan_detail').select('qty, produk_id').eq('penjualan_id', s.id);
                if (details) {
                    for (let d of details) {
                        const { data: prod } = await db.from('produk').select('harga_beli').eq('id', d.produk_id).single();
                        if (prod) totalHPP += (parseFloat(prod.harga_beli || 0) * d.qty);
                    }
                }
                if (totalHPP > 0) {
                    html += `<tr><td>${new Date(s.created_at).toLocaleDateString()}</td><td><span class="badge bg-hpp">HPP</span></td><td>HPP: ${s.no_invoice}</td><td>Rp ${totalHPP.toLocaleString()}</td><td>5101</td></tr>`;
                    finalizedEntries.push({ type: 'HPP', date: s.created_at, ref: s.no_invoice, val: totalHPP, target: '5101', source: '1103' });
                }
            }

            // 2. SCAN BEBAN DARI TABEL PENGELUARAN (Kolom: jumlah)
            const { data: expenses } = await db.from('pengeluaran').select('*');
            if (expenses) {
                for (let e of expenses) {
                    let nominal = parseFloat(e.jumlah || 0);
                    let targetAkun = (e.kategori === 'Gaji') ? '6103' : '6101';
                    html += `<tr><td>${new Date(e.tanggal).toLocaleDateString()}</td><td><span class="badge bg-beban">BEBAN</span></td><td>${e.keterangan}</td><td>Rp ${nominal.toLocaleString()}</td><td>${targetAkun}</td></tr>`;
                    finalizedEntries.push({ type: 'BEBAN', date: e.tanggal, ref: 'EXP-' + e.id, val: nominal, target: targetAkun, source: '1101' });
                }
            }

            list.innerHTML = html;
            document.getElementById('result-area').style.display = 'block';
        } catch (err) { alert(err.message); }
    }

    async function fixData() {
        const btn = document.getElementById('btn-fix');
        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            // Hapus jurnal lama akun terkait (5101, 1103, 6101, 6103)
            await db.from('jurnal_umum').delete().in('kode_akun', ['5101', '1103', '6101', '6103']);

            let batch = [];
            for (let item of finalizedEntries) {
                // Debit
                batch.push({ tanggal: item.date, no_bukti: item.ref, kode_akun: item.target, keterangan: item.ref, debit: item.val, kredit: 0 });
                // Kredit
                batch.push({ tanggal: item.date, no_bukti: item.ref, kode_akun: item.source, keterangan: 'Penyeimbang ' + item.ref, debit: 0, kredit: item.val });
            }

            if (batch.length > 0) {
                const { error } = await db.from('jurnal_umum').insert(batch);
                if (error) throw error;
            }

            alert("‚úÖ Beban & HPP Berhasil Disinkronkan!");
            location.reload();
        } catch (err) { alert(err.message); btn.disabled = false; }
    }
</script>
</body>
</html>
