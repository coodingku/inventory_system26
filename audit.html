<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Rekonsiliasi HPP Akurat</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e91e63; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 1100px; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-audit { background: var(--primary); }
        .btn-fix { background: var(--success); width: 100%; margin-top: 20px; font-size: 16px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .loading { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>üéØ Rekonsiliasi Jurnal & HPP Akurat</h2>
    <p>Data HPP dihitung berdasarkan <b>Harga Beli</b> asli di database produk.</p>
    
    <button class="btn btn-audit" id="btn-scan" onclick="runAuditAkurat()">üîç 1. Scan & Hitung HPP Akurat</button>
    
    <div id="result-area" style="display:none; margin-top: 20px;">
        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c8e6c9;">
            ‚úÖ Scan Selesai: <b id="count">0</b> Transaksi ditemukan.
        </div>

        <table>
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>No. Invoice</th>
                    <th>Total Jual (Kas/Bank)</th>
                    <th>Total Modal (HPP -> 1103)</th>
                    <th>Estimasi Laba</th>
                </tr>
            </thead>
            <tbody id="list-data"></tbody>
        </table>

        <button class="btn btn-fix" id="btn-fix" onclick="fixJurnalAkurat()">üî• 2. SINKRONKAN KE JURNAL SEKARANG</button>
    </div>
</div>

<script>
    let finalizedEntries = [];

    async function runAuditAkurat() {
        const btnScan = document.getElementById('btn-scan');
        const list = document.getElementById('list-data');
        btnScan.disabled = true;
        btnScan.innerHTML = "‚è≥ Menghitung HPP (Mohon Tunggu)...";
        
        finalizedEntries = [];
        let html = '';

        try {
            // 1. Ambil Penjualan
            const { data: sales, error: errS } = await db.from('penjualan').select('*').gte('created_at', '2026-01-01');
            if (errS) throw errS;

            for (let s of sales) {
                let totalHPPNota = 0;
                
                // 2. Ambil Detail Penjualan & Harga Beli Produk
                const { data: details } = await db.from('penjualan_detail').select('qty, produk_id').eq('penjualan_id', s.id);
                
                if (details) {
                    for (let d of details) {
                        const { data: prod } = await db.from('produk').select('harga_beli').eq('id', d.produk_id).single();
                        if (prod && prod.harga_beli) {
                            totalHPPNota += (parseFloat(prod.harga_beli) * d.qty);
                        }
                    }
                }

                const jual = parseFloat(s.grand_total || s.total || 0);
                const laba = jual - totalHPPNota;

                html += `<tr>
                    <td>${new Date(s.created_at).toLocaleDateString()}</td>
                    <td><b>${s.no_invoice}</b></td>
                    <td>Rp ${jual.toLocaleString()}</td>
                    <td style="color:var(--danger)">Rp ${totalHPPNota.toLocaleString()}</td>
                    <td style="color:var(--success)">Rp ${laba.toLocaleString()}</td>
                </tr>`;

                // Simpan data untuk proses sinkronisasi
                finalizedEntries.push({
                    header: s,
                    hpp: totalHPPNota,
                    jual: jual
                });
            }

            list.innerHTML = html;
            document.getElementById('count').innerText = sales.length;
            document.getElementById('result-area').style.display = 'block';
        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            btnScan.disabled = false;
            btnScan.innerHTML = "üîç 1. Scan & Hitung HPP Akurat";
        }
    }

   async function fixJurnalAkurat() {
    const btn = document.getElementById('btn-fix');
    btn.disabled = true;
    btn.innerText = "‚è≥ Sinkronisasi Ulang...";

    let batch = [];

    for (let item of finalizedEntries) {
        const s = item.header;
        const mtd = (s.metode_pembayaran || "TUNAI").toUpperCase();
        const akunUang = (mtd.includes('QRIS') || mtd.includes('BANK') || mtd.includes('TRANSFER')) ? '1102' : '1101';

        // --- JURNAL PENDAPATAN (Hanya Menambah Saldo) ---
        // Debit: Kas/Bank (Uang Masuk)
        batch.push({ tanggal: s.created_at, no_bukti: s.no_invoice, kode_akun: akunUang, keterangan: `Pendapatan Penjualan`, debit: item.jual, kredit: 0 });
        // Kredit: Pendapatan (Penjualan Diakui)
        batch.push({ tanggal: s.created_at, no_bukti: s.no_invoice, kode_akun: '4101', keterangan: `Pendapatan Penjualan`, debit: 0, kredit: item.jual });

        // --- JURNAL HPP (Hanya Memotong Stok 1103) ---
        if (item.hpp > 0) {
            // Debit: Beban HPP (Biaya bertambah)
            batch.push({ tanggal: s.created_at, no_bukti: s.no_invoice, kode_akun: '5101', keterangan: `Beban HPP`, debit: item.hpp, kredit: 0 });
            // Kredit: STOK/MODAL PRODUK (Bukan Bank!)
            batch.push({ tanggal: s.created_at, no_bukti: s.no_invoice, kode_akun: '1103', keterangan: `Potong Stok Modal`, debit: 0, kredit: item.hpp });
        }
    }

    // Sebelum Insert, Hapus semua jurnal invoice terkait agar tidak double/triple
    const allInvoices = finalizedEntries.map(x => x.header.no_invoice);
    await db.from('jurnal_umum').delete().in('no_bukti', allInvoices);

    // Masukkan data yang sudah bersih
    const { error } = await db.from('jurnal_umum').insert(batch);

    if (!error) {
        alert("‚úÖ REKONSILIASI BERHASIL!\n\nKas/Bank HANYA bertambah (Debit).\nStok 1103 HANYA berkurang (Kredit).");
        location.reload();
    }
}
</script>
</body>
</html>
