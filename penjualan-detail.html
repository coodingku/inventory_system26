<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finex Pos | Laporan Detail Per Kasir</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; }
        nav { width: 250px; background: var(--primary); color: white; height: 100vh; padding: 20px; position: fixed; }
        nav a { color: #bdc3c7; text-decoration: none; display: block; padding: 12px; border-radius: 8px; margin-bottom: 5px; }
        nav a.active { background: var(--accent); color: white; }
        
        main { flex: 1; margin-left: 250px; padding: 30px; width: calc(100% - 250px); }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; border-top: 4px solid var(--accent); text-align: center; }
        .stat-card h4 { margin: 0; font-size: 12px; color: #666; }
        .stat-card p { margin: 10px 0 0; font-size: 18px; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #eee; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }

        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .btn-search { background: var(--primary); }
        .btn-excel { background: var(--success); }
        .btn-print { background: #8e44ad; }

        @media print {
            nav, .filter-grid, .btn { display: none !important; }
            main { margin-left: 0; width: 100%; padding: 0; }
        }
    </style>
</head>
<body>

<nav>
    <h2>Finex Pos</h2>
    <a href="dashboard.html">üìä Dashboard</a>
    <a href="penjualan-detail.html" class="active">üí∞ Laba Rugi Detail</a>
    <a href="pos.html" style="background:var(--success); text-align:center; margin-top:20px;">üõí Kasir</a>
</nav>

<main>
    <h1>Laporan Penjualan & Laba</h1>

    <div class="card" style="margin-bottom: 20px;">
        <div class="filter-grid">
            <div class="filter-group">
                <label>Dari Tanggal</label>
                <input type="date" id="tgl-mulai">
            </div>
            <div class="filter-group">
                <label>Sampai Tanggal</label>
                <input type="date" id="tgl-akhir">
            </div>
            <div class="filter-group">
                <label>Pilih Kasir</label>
                <select id="select-kasir">
                    <option value="">Semua Kasir</option>
                </select>
            </div>
            <button class="btn btn-search" onclick="muatLaporan()">üîç Cari</button>
            <button class="btn btn-excel" onclick="exportExcel()">üì• Excel</button>
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Cetak</button>
        </div>
    </div>

    <div class="stat-grid">
        <div class="stat-card"><h4>Total Omzet</h4><p id="total-omzet" style="color:var(--accent)">Rp 0</p></div>
        <div class="stat-card" style="border-top-color: var(--danger);"><h4>Total Modal</h4><p id="total-hpp" style="color:var(--danger)">Rp 0</p></div>
        <div class="stat-card" style="border-top-color: var(--success);"><h4>Laba Kantin</h4><p id="total-laba" style="color:var(--success)">Rp 0</p></div>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>Kasir</th>
                    <th>Produk</th>
                    <th>Qty</th>
                    <th>Subtotal</th>
                    <th>Laba</th>
                </tr>
            </thead>
            <tbody id="tabel-body">
                <tr><td colspan="6" style="text-align:center;">Silakan filter data...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<script>
    const SB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    const FinexDB = window.supabase.createClient(SB_URL, SB_KEY);

    window.onload = async () => {
        // Set default tanggal hari ini
        const hariIni = new Date().toISOString().split('T')[0];
        document.getElementById('tgl-mulai').value = hariIni;
        document.getElementById('tgl-akhir').value = hariIni;
        
        await muatDaftarKasir();
        muatLaporan();
    };

    async function muatDaftarKasir() {
        // Ambil daftar unik nama kasir dari log shift
        const { data } = await FinexDB.from('kasir_log').select('kasir_nama');
        const listNama = [...new Set(data.map(k => k.kasir_nama))];
        const select = document.getElementById('select-kasir');
        listNama.forEach(nama => {
            select.innerHTML += `<option value="${nama}">${nama}</option>`;
        });
    }

    async function muatLaporan() {
        const tgl1 = document.getElementById('tgl-mulai').value;
        const tgl2 = document.getElementById('tgl-akhir').value;
        const kasirTerpilih = document.getElementById('select-kasir').value;

        // Ambil detail penjualan, join dengan master penjualan untuk dapat nama kasir, join produk untuk harga_beli
        let query = FinexDB
            .from('penjualan_detail')
            .select(`
                created_at, qty, harga_satuan, subtotal_item, nama_barang,
                penjualan!inner(kasir_id),
                kasir_log:penjualan(kasir_log(kasir_nama)),
                produk(harga_beli)
            `)
            .gte('created_at', `${tgl1}T00:00:00Z`)
            .lte('created_at', `${tgl2}T23:59:59Z`);

        // Filter jika kasir tertentu dipilih
        if (kasirTerpilih) {
            query = query.eq('penjualan.kasir_log.kasir_nama', kasirTerpilih);
        }

        const { data, error } = await query.order('created_at', { ascending: false });

        if (error) return alert("Gagal: " + error.message);

        let omzet = 0, hpp = 0;
        const tbody = document.getElementById('tabel-body');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Tidak ada data ditemukan.</td></tr>';
        } else {
            tbody.innerHTML = data.map(item => {
                const modal = item.produk?.harga_beli || 0;
                const subOmzet = item.subtotal_item || 0;
                const subHpp = modal * item.qty;
                const subLaba = subOmzet - subHpp;
                const namaKasir = item.penjualan?.kasir_log?.kasir_nama || "System";

                omzet += subOmzet;
                hpp += subHpp;

                return `
                    <tr>
                        <td>${new Date(item.created_at).toLocaleDateString('id-ID')}</td>
                        <td>${namaKasir}</td>
                        <td><b>${item.nama_barang}</b></td>
                        <td>${item.qty}</td>
                        <td>Rp ${subOmzet.toLocaleString()}</td>
                        <td style="color:var(--success); font-weight:bold;">Rp ${subLaba.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        document.getElementById('total-omzet').innerText = `Rp ${omzet.toLocaleString()}`;
        document.getElementById('total-hpp').innerText = `Rp ${hpp.toLocaleString()}`;
        document.getElementById('total-laba').innerText = `Rp ${(omzet - hpp).toLocaleString()}`;
    }

    function exportExcel() {
        const rows = document.querySelectorAll("table tr");
        let csv = [];
        rows.forEach(row => {
            let cols = row.querySelectorAll("td, th");
            let rowData = Array.from(cols).map(c => `"${c.innerText.replace(/Rp /g, '').replace(/\./g, '')}"`);
            csv.push(rowData.join(","));
        });
        const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Laporan_Detail_Penjualan.csv`;
        a.click();
    }
</script>
</body>
</html>
