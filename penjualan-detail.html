<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finex Pos | Laporan Detail Laba Rugi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="supabase-init.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; }
        nav { width: 250px; background: var(--primary); color: white; height: 100vh; padding: 20px; position: fixed; box-sizing: border-box; z-index: 100; }
        nav h2 { color: var(--accent); text-align: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        nav a { color: #bdc3c7; text-decoration: none; display: block; padding: 12px; border-radius: 8px; margin-bottom: 5px; font-size: 14px; }
        nav a.active { background: var(--accent); color: white; }
        
        main { flex: 1; margin-left: 250px; padding: 30px; width: calc(100% - 250px); box-sizing: border-box; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; border-top: 4px solid var(--accent); text-align: center; }
        .stat-card h4 { margin: 0; font-size: 12px; color: #666; }
        .stat-card p { margin: 10px 0 0; font-size: 18px; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; border-bottom: 2px solid #eee; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }

        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .btn-search { background: var(--primary); }
        .btn-excel { background: var(--success); }
        .btn-print { background: #8e44ad; }

        .user-info { margin-top: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 12px; color: #ddd; }

        @media print {
            nav, .filter-grid, .btn { display: none !important; }
            main { margin-left: 0; width: 100%; padding: 0; }
        }
    </style>
</head>
<body>

<nav>
    <h2 id="store-name-display">Finex Pos</h2>
    <a href="dashboard.html">üìä Dashboard</a>
    <a href="penjualan-detail.html" class="active">üí∞ Laba Rugi Detail</a>
    
    <div class="user-info" style="margin-top: 20px;">
        <small>ADMIN:</small> <b id="display-user-nav">...</b>
    </div>
    <a href="pos.html" style="background:var(--success); text-align:center; margin-top:10px; color: white; text-decoration: none; display: block; padding: 10px; border-radius: 8px;">üõí Kasir</a>
    <a href="#" onclick="logout()" style="color:var(--danger); font-size: 12px; margin-top: 10px; display: block; text-align: center;">üö™ Keluar</a>
</nav>

<main>
    <h1>Laporan Penjualan & Estimasi Laba</h1>

    <div class="card" style="margin-bottom: 20px;">
        <div class="filter-grid">
            <div class="filter-group">
                <label>Dari Tanggal</label>
                <input type="date" id="tgl-mulai">
            </div>
            <div class="filter-group">
                <label>Sampai Tanggal</label>
                <input type="date" id="tgl-akhir">
            </div>
            <div class="filter-group">
                <label>Filter Kasir</label>
                <select id="select-kasir">
                    <option value="">Semua Kasir</option>
                </select>
            </div>
            <button class="btn btn-search" onclick="muatLaporan()">üîç Cari</button>
            <button class="btn btn-excel" onclick="exportExcel()">üì• Excel</button>
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Cetak</button>
        </div>
    </div>

    <div class="stat-grid">
        <div class="stat-card"><h4>Total Omzet</h4><p id="total-omzet" style="color:var(--accent)">Rp 0</p></div>
        <div class="stat-card" style="border-top-color: var(--danger);"><h4>Total Modal (HPP)</h4><p id="total-hpp" style="color:var(--danger)">Rp 0</p></div>
        <div class="stat-card" style="border-top-color: var(--success);"><h4>Estimasi Laba</h4><p id="total-laba" style="color:var(--success)">Rp 0</p></div>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>Kasir</th>
                    <th>Produk</th>
                    <th>Qty</th>
                    <th>Subtotal</th>
                    <th>Laba Item</th>
                </tr>
            </thead>
            <tbody id="tabel-body">
                <tr><td colspan="6" style="text-align:center;">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<script>
    // Variabel 'db' disediakan secara dinamis oleh supabase-init.js
    const session = JSON.parse(localStorage.getItem('finex_session'));

    window.onload = async () => {
        const hariIni = new Date().toISOString().split('T')[0];
        document.getElementById('tgl-mulai').value = hariIni;
        document.getElementById('tgl-akhir').value = hariIni;
        
        await muatDaftarKasir();
        muatLaporan();
    };

    async function muatDaftarKasir() {
        // Ambil daftar nama kasir unik dari tabel penjualan di database pelanggan
        const { data } = await db.from('penjualan').select('kasir_nama');
        if (data) {
            const listNama = [...new Set(data.map(k => k.kasir_nama).filter(n => n))];
            const select = document.getElementById('select-kasir');
            listNama.forEach(nama => {
                const opt = document.createElement('option');
                opt.value = nama;
                opt.innerText = nama;
                select.appendChild(opt);
            });
        }
    }

    async function muatLaporan() {
        const tgl1 = document.getElementById('tgl-mulai').value;
        const tgl2 = document.getElementById('tgl-akhir').value;
        const kasirTerpilih = document.getElementById('select-kasir').value;

        const tbody = document.getElementById('tabel-body');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">‚è≥ Memuat data...</td></tr>';

        try {
            // Join ke tabel penjualan untuk ambil nama kasir & created_at
            // Join ke tabel produk untuk ambil harga_beli (HPP)
            let query = db
                .from('penjualan_detail')
                .select(`
                    qty, harga_satuan, subtotal_item, nama_barang,
                    penjualan!inner ( created_at, kasir_nama, no_invoice ),
                    produk ( harga_beli )
                `)
                .gte('penjualan.created_at', `${tgl1}T00:00:00`)
                .lte('penjualan.created_at', `${tgl2}T23:59:59`);

            if (kasirTerpilih) {
                query = query.eq('penjualan.kasir_nama', kasirTerpilih);
            }

            const { data, error } = await query.order('penjualan(created_at)', { ascending: false });

            if (error) throw error;

            let totalOmzet = 0, totalHpp = 0;

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Tidak ada transaksi ditemukan.</td></tr>';
            } else {
                tbody.innerHTML = data.map(item => {
                    const modalPerPcs = item.produk?.harga_beli || 0;
                    const subOmzet = parseFloat(item.subtotal_item || 0);
                    const subHpp = modalPerPcs * item.qty;
                    const subLaba = subOmzet - subHpp;
                    const namaKasir = item.penjualan?.kasir_nama || "System";
                    const tglTrx = new Date(item.penjualan?.created_at).toLocaleDateString('id-ID');

                    totalOmzet += subOmzet;
                    totalHpp += subHpp;

                    return `
                        <tr>
                            <td>${tglTrx}</td>
                            <td>${namaKasir}</td>
                            <td><b>${item.nama_barang || 'Item'}</b></td>
                            <td style="text-align:center;">${item.qty}</td>
                            <td>Rp ${subOmzet.toLocaleString('id-ID')}</td>
                            <td style="color:var(--success); font-weight:bold;">Rp ${subLaba.toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                }).join('');
            }

            document.getElementById('total-omzet').innerText = `Rp ${totalOmzet.toLocaleString('id-ID')}`;
            document.getElementById('total-hpp').innerText = `Rp ${totalHpp.toLocaleString('id-ID')}`;
            document.getElementById('total-laba').innerText = `Rp ${(totalOmzet - totalHpp).toLocaleString('id-ID')}`;

        } catch (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Gagal memuat: ${error.message}</td></tr>`;
        }
    }

    function exportExcel() {
        const table = document.querySelector("table");
        let csv = [];
        const rows = table.querySelectorAll("tr");
        
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length; j++) {
                let cleanText = cols[j].innerText.replace(/Rp /g, '').replace(/\./g, '');
                row.push('"' + cleanText + '"');
            }
            csv.push(row.join(","));
        }
        
        const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `Laporan_Laba_Rugi_${new Date().getTime()}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function logout() {
        if(confirm("Keluar dari sistem?")) {
            sessionStorage.clear();
            localStorage.clear();
            window.location.replace('login.html');
        }
    }
</script>
</body>
</html>
