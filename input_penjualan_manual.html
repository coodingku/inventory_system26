<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Harian BeautyBloom | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #4f46e5; 
            --success: #059669;
            --bg: #f1f5f9;
            --header-dark: #1e293b;
        }
        
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); max-width: 1500px; margin: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-left: 5px solid var(--accent); padding-left: 20px; }
        .header h2 { margin: 0; font-size: 26px; color: var(--primary); }
        
        .filter-box { display: flex; gap: 15px; margin-bottom: 25px; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        
        input, button { padding: 12px 18px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; }
        
        .btn-filter { background: var(--accent); color: white; border: none; font-weight: 600; cursor: pointer; }
        .btn-filter:hover { background: #4338ca; }
        .btn-export { background: var(--success); color: white; border: none; font-weight: 600; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; border: 1px solid #e2e8f0; margin-top: 10px; }
        th { background: var(--header-dark); color: white; padding: 12px 8px; font-size: 11px; text-transform: uppercase; border: 1px solid #334155; }
        .th-accent { background: #312e81; } 
        .th-final { background: #c2410c; }

        td { padding: 12px 8px; border: 1px solid #e2e8f0; font-size: 13px; text-align: right; }
        .text-left { text-align: left; }
        .font-bold { font-weight: 700; }
        .col-method { background: #f0f4ff; color: #1e40af; }
        .col-total { background: #fff7ed; color: #9a3412; font-weight: 800; }
        
        .footer-row { background: var(--primary) !important; color: white !important; font-weight: 700; }

        @media print {
            .filter-box, .btn-export, button { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h2>Laporan Harian BeautyBloom</h2>
            <div style="color: #64748b; font-size: 14px;">Finex Pos Management System</div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-export" onclick="exportToExcel()">Export Excel</button>
            <button onclick="window.print()" style="background: white; cursor: pointer; border: 1px solid #ccc;">Cetak Laporan</button>
        </div>
    </div>

    <div class="filter-box">
        <div class="filter-group">
            <label>Dari Tanggal</label>
            <input type="date" id="date-start">
        </div>
        <div class="filter-group">
            <label>Sampai Tanggal</label>
            <input type="date" id="date-end">
        </div>
        <button class="btn-filter" onclick="fetchData()">Tampilkan Laporan</button>
    </div>

    <div style="overflow-x: auto;">
        <table id="main-table">
            <thead>
                <tr>
                    <th rowspan="2">Tanggal</th>
                    <th rowspan="2">Gross Sales</th>
                    <th rowspan="2">Diskon</th>
                    <th rowspan="2">Net Sales</th>
                    <th rowspan="2">DPP Service</th>
                    <th rowspan="2">PB1 (10%)</th>
                    <th colspan="4" class="th-accent">Metode Pembayaran</th>
                    <th rowspan="2" class="th-final">Grand Total</th>
                </tr>
                <tr>
                    <th class="th-accent">Tunai</th>
                    <th class="th-accent">QRIS</th>
                    <th class="th-accent">BCA</th>
                    <th class="th-accent">Lainnya</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="11" style="text-align:center; padding: 40px; color: #94a3b8;">Data akan muncul setelah Anda menekan tombol Tampilkan.</td></tr>
            </tbody>
            <tfoot id="table-footer"></tfoot>
        </table>
    </div>
</div>

<script>
// Mencegah error "Identifier has already been declared"
if (typeof supabase === 'undefined') {
    const DB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const DB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    var supabaseClient = window.supabase.createClient(DB_URL, DB_KEY);
} else {
    var supabaseClient = supabase;
}

// Inisialisasi Tanggal Default
window.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
    const lastDay = today.toISOString().split('T')[0];
    document.getElementById('date-start').value = firstDay;
    document.getElementById('date-end').value = lastDay;
});

async function fetchData() {
    const start = document.getElementById('date-start').value;
    const end = document.getElementById('date-end').value;
    
    if(!start || !end) return alert("Pilih rentang tanggal!");

    const { data, error } = await supabaseClient
        .from('penjualan')
        .select('*')
        .gte('created_at', start + 'T00:00:00')
        .lte('created_at', end + 'T23:59:59')
        .order('created_at', { ascending: true });

    if (error) {
        console.error("Supabase Error:", error);
        return;
    }

    processData(data);
}

function processData(data) {
    const report = {};

    data.forEach(item => {
        const tgl = new Date(item.created_at).toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
        
        if (!report[tgl]) {
            report[tgl] = { gross: 0, disc: 0, tunai: 0, qris: 0, bca: 0, lainnya: 0 };
        }

        const sub = parseFloat(item.subtotal || 0);
        const disc = parseFloat(item.diskon || 0);
        const nett = sub - disc;
        const pay = (item.metode_pembayaran || '').toLowerCase();

        report[tgl].gross += sub;
        report[tgl].disc += disc;

        if (pay.includes('tunai')) report[tgl].tunai += nett;
        else if (pay.includes('qris')) report[tgl].qris += nett;
        else if (pay.includes('bca')) report[tgl].bca += nett;
        else report[tgl].lainnya += nett;
    });

    renderTable(report);
}

function renderTable(report) {
    let bodyHtml = '';
    const totals = { gross:0, disc:0, nett:0, dpp:0, pb1:0, tunai:0, qris:0, bca:0, lain:0, grand:0 };
    const f = (v) => Math.round(v).toLocaleString('id-ID');

    const keys = Object.keys(report);
    if (keys.length === 0) {
        document.getElementById('table-body').innerHTML = '<tr><td colspan="11" style="text-align:center">Tidak ada data untuk periode ini.</td></tr>';
        document.getElementById('table-footer').innerHTML = '';
        return;
    }

    keys.forEach(tgl => {
        const d = report[tgl];
        const netSales = d.gross - d.disc;
        
        const dpp = netSales / 1.155;
        const svc = dpp * 0.05;
        const pb1 = (dpp + svc) * 0.10;
        
        // Grand Total dihitung dari akumulasi kolom metode pembayaran
        const grandTotalRow = d.tunai + d.qris + d.bca + d.lainnya;

        totals.gross += d.gross;
        totals.disc += d.disc;
        totals.nett += netSales;
        totals.dpp += dpp;
        totals.pb1 += pb1;
        totals.tunai += d.tunai;
        totals.qris += d.qris;
        totals.bca += d.bca;
        totals.lain += d.lainnya;
        totals.grand += grandTotalRow;

        bodyHtml += `
            <tr>
                <td class="text-left font-bold" style="color:var(--accent)">${tgl}</td>
                <td>${f(d.gross)}</td>
                <td style="color:#dc2626">-${f(d.disc)}</td>
                <td class="font-bold">${f(netSales)}</td>
                <td>${f(dpp)}</td>
                <td>${f(pb1)}</td>
                <td class="col-method">${f(d.tunai)}</td>
                <td class="col-method">${f(d.qris)}</td>
                <td class="col-method">${f(d.bca)}</td>
                <td class="col-method">${f(d.lainnya)}</td>
                <td class="col-total">${f(grandTotalRow)}</td>
            </tr>
        `;
    });

    document.getElementById('table-body').innerHTML = bodyHtml;
    
    document.getElementById('table-footer').innerHTML = `
        <tr class="footer-row">
            <td class="text-left">TOTAL KESELURUHAN</td>
            <td>${f(totals.gross)}</td>
            <td>${f(totals.disc)}</td>
            <td>${f(totals.nett)}</td>
            <td>${f(totals.dpp)}</td>
            <td>${f(totals.pb1)}</td>
            <td>${f(totals.tunai)}</td>
            <td>${f(totals.qris)}</td>
            <td>${f(totals.bca)}</td>
            <td>${f(totals.lain)}</td>
            <td style="background:#ea580c">${f(totals.grand)}</td>
        </tr>
    `;
}

function exportToExcel() {
    const table = document.getElementById("main-table");
    const wb = XLSX.utils.table_to_book(table, { sheet: "Laporan" });
    XLSX.writeFile(wb, `Laporan_BeautyBloom_${new Date().toLocaleDateString()}.xlsx`);
}
</script>
</body>
</html>
