<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Penjualan | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        .filter-box { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        input, button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        button { cursor: pointer; font-weight: bold; }
        .btn-filter { background: var(--accent); color: white; border: none; }
        .btn-export { background: #27ae60; color: white; border: none; }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #f2f2f2; padding: 8px; border: 1px solid #ccc; text-align: center; sticky: top; }
        td { padding: 6px 8px; border: 1px solid #ddd; text-align: right; }
        .text-left { text-align: left; }
        .text-center { text-align: center; }

        /* Baris Pemisah Tanggal/Subtotal */
        .subtotal-date-row { background: #f9f9f9; font-weight: bold; color: #2c3e50; }
        .grandtotal-row { background: #2c3e50 !important; color: white !important; font-weight: bold; font-size: 12px; }
        
        .metode-pill { background: #ebf5fb; padding: 2px 5px; border-radius: 3px; border: 1px solid #aed6f1; color: #2e86c1; font-weight: bold; font-size: 9px; }

        @media print {
            .filter-box, .btn-export, .header button { display: none; }
            body { padding: 0; background: white; }
            .container { box-shadow: none; width: 100%; max-width: 100%; }
            table { font-size: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h2 style="margin:0; font-size: 18px;">Laporan Penjualan Detail BeautyBloom</h2>
            <small>Finex POS System</small>
        </div>
        <div>
            <button class="btn-export" onclick="exportToExcel()">üì• Export Excel</button>
            <button onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
    </div>

    <div class="filter-box">
        <div>
            <label style="display:block; font-size:10px;">Dari:</label>
            <input type="date" id="date-start">
        </div>
        <div>
            <label style="display:block; font-size:10px;">Sampai:</label>
            <input type="date" id="date-end">
        </div>
        <button class="btn-filter" onclick="loadDetailLaporan()">Tampilkan</button>
    </div>

    <div style="overflow-x: auto;">
        <table id="table-laporan">
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>No. Invoice</th>
                    <th>Metode</th>
                    <th>Gross</th>
                    <th>Disc</th>
                    <th>Net Sales</th>
                    <th>DPP (Net/1.155)</th>
                    <th>Svc (5%)</th>
                    <th>PB1 (10%)</th>
                    <th>Grand Total</th>
                </tr>
            </thead>
            <tbody id="report-body">
                <tr><td colspan="10" class="text-center">Tentukan tanggal lalu klik Tampilkan.</td></tr>
            </tbody>
            <tfoot id="report-footer"></tfoot>
        </table>
    </div>
</div>

<script>
const URL_DB = 'https://uojhjskgugghwxtdsfvm.supabase.co';
const KEY_DB = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
const FinexDB = window.supabase.createClient(URL_DB, KEY_DB);

window.onload = () => {
    const now = new Date();
    document.getElementById('date-start').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('date-end').value = now.toISOString().split('T')[0];
};

async function loadDetailLaporan() {
    const start = document.getElementById('date-start').value;
    const end = document.getElementById('date-end').value;
    
    const { data: trx, error } = await FinexDB.from('penjualan')
        .select('*')
        .gte('created_at', start + 'T00:00:00')
        .lte('created_at', end + 'T23:59:59')
        .order('created_at', { ascending: true });

    if (error) return alert("Error: " + error.message);

    let html = '';
    let grandTotals = { gross:0, disc:0, net:0, ddp:0, svc:0, pb1:0, grand:0 };
    let currentDate = null;
    let daySubtotal = { gross:0, disc:0, net:0, ddp:0, svc:0, pb1:0, grand:0 };

    function formatNum(n) { return Math.round(n).toLocaleString('id-ID'); }

    trx.forEach((row, index) => {
        const tglStr = new Date(row.created_at).toLocaleDateString('id-ID');
        
        // Cek jika ganti tanggal (untuk menyisipkan Subtotal)
        if (currentDate !== null && currentDate !== tglStr) {
            html += renderSubtotalRow(currentDate, daySubtotal);
            // Reset daily subtotal
            daySubtotal = { gross:0, disc:0, net:0, ddp:0, svc:0, pb1:0, grand:0 };
        }
        currentDate = tglStr;

        const gross = parseFloat(row.subtotal || 0);
        const disc = parseFloat(row.diskon || 0);
        const net = gross - disc;
        const mtd = row.metode_pembayaran || 'Tunai';

        const ddp = net / 1.155;
        const svc = ddp * 0.05;
        const pb1 = (ddp + svc) * 0.10;
        const grand = net;

        // Akumulasi
        daySubtotal.gross += gross; daySubtotal.disc += disc; daySubtotal.net += net;
        daySubtotal.ddp += ddp; daySubtotal.svc += svc; daySubtotal.pb1 += pb1; daySubtotal.grand += grand;

        grandTotals.gross += gross; grandTotals.disc += disc; grandTotals.net += net;
        grandTotals.ddp += ddp; grandTotals.svc += svc; grandTotals.pb1 += pb1; grandTotals.grand += grand;

        html += `
            <tr>
                <td class="text-left">${tglStr}</td>
                <td class="text-left">${row.no_invoice || row.id.substring(0,8)}</td>
                <td class="text-center"><span class="metode-pill">${mtd}</span></td>
                <td>${formatNum(gross)}</td>
                <td>${formatNum(disc)}</td>
                <td>${formatNum(net)}</td>
                <td>${formatNum(ddp)}</td>
                <td>${formatNum(svc)}</td>
                <td>${formatNum(pb1)}</td>
                <td style="font-weight:bold;">${formatNum(grand)}</td>
            </tr>
        `;

        // Jika data terakhir, cetak subtotal terakhir
        if (index === trx.length - 1) {
            html += renderSubtotalRow(currentDate, daySubtotal);
        }
    });

    document.getElementById('report-body').innerHTML = html;

    // Footer Grand Total
    document.getElementById('report-footer').innerHTML = `
        <tr class="grandtotal-row">
            <td colspan="3">GRAND TOTAL KESELURUHAN</td>
            <td>${formatNum(grandTotals.gross)}</td>
            <td>${formatNum(grandTotals.disc)}</td>
            <td>${formatNum(grandTotals.net)}</td>
            <td>${formatNum(grandTotals.ddp)}</td>
            <td>${formatNum(grandTotals.svc)}</td>
            <td>${formatNum(grandTotals.pb1)}</td>
            <td>${formatNum(grandTotals.grand)}</td>
        </tr>
    `;
}

function renderSubtotalRow(date, data) {
    function f(n) { return Math.round(n).toLocaleString('id-ID'); }
    return `
        <tr class="subtotal-date-row">
            <td colspan="3" class="text-left">SUBTOTAL ${date}</td>
            <td>${f(data.gross)}</td>
            <td>${f(data.disc)}</td>
            <td>${f(data.net)}</td>
            <td>${f(data.ddp)}</td>
            <td>${f(data.svc)}</td>
            <td>${f(data.pb1)}</td>
            <td>${f(data.grand)}</td>
        </tr>
    `;
}

function exportToExcel() {
    const table = document.getElementById("table-laporan");
    const wb = XLSX.utils.table_to_book(table, { sheet: "Detail Penjualan" });
    XLSX.writeFile(wb, "Laporan_Finex_BeautyBloom.xlsx");
}
</script>
</body>
</html>
