<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Penjualan | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        
        .filter-box { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; }
        input, button { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { cursor: pointer; font-weight: bold; }
        .btn-filter { background: var(--accent); color: white; border: none; }
        .btn-export { background: #27ae60; color: white; border: none; }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #f8f9fa; padding: 10px; border: 1px solid #ddd; text-align: center; }
        td { padding: 8px; border: 1px solid #ddd; text-align: right; }
        .text-left { text-align: left; }
        .grandtotal-row { background: #2c3e50; color: white; font-weight: bold; font-size: 13px; }
        .metode-pill { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 10px; color: #2c3e50; font-weight: bold; }
        .rekap-row { background: #fdfdfd; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Laporan Detail Penjualan (Pajak & Service)</h2>
        <div>
            <button class="btn-export" onclick="exportToExcel()">üì• Export Excel</button>
            <button onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
    </div>

    <div class="filter-box">
        <div>
            <label style="display:block; font-size:11px;">Mulai Tanggal:</label>
            <input type="date" id="date-start">
        </div>
        <div>
            <label style="display:block; font-size:11px;">Sampai Tanggal:</label>
            <input type="date" id="date-end">
        </div>
        <button class="btn-filter" onclick="loadDetailLaporan()">Tampilkan Laporan</button>
    </div>

    <div style="overflow-x: auto;">
        <table id="table-laporan">
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>No. Invoice</th>
                    <th>Gross (Kotor)</th>
                    <th>Diskon</th>
                    <th>Net Sales</th>
                    <th>DDP (Net/1.155)</th>
                    <th>Service (5%)</th>
                    <th>PB1 (10%)</th>
                    <th>Metode</th>
                    <th>Grand Total</th>
                </tr>
            </thead>
            <tbody id="report-body">
                <tr><td colspan="10" style="text-align:center;">Pilih tanggal dan klik tampilkan.</td></tr>
            </tbody>
            <tfoot id="report-footer"></tfoot>
        </table>
    </div>
</div>

<script>
const URL_DB = 'https://uojhjskgugghwxtdsfvm.supabase.co';
const KEY_DB = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
const FinexDB = window.supabase.createClient(URL_DB, KEY_DB);

window.onload = () => {
    const now = new Date();
    document.getElementById('date-start').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('date-end').value = now.toISOString().split('T')[0];
};

async function loadDetailLaporan() {
    const start = document.getElementById('date-start').value;
    const end = document.getElementById('date-end').value;
    
    const { data: trx, error } = await FinexDB.from('penjualan')
        .select('*')
        .gte('created_at', start + 'T00:00:00')
        .lte('created_at', end + 'T23:59:59')
        .order('created_at', { ascending: true });

    if (error) return alert("Gagal ambil data: " + error.message);

    let html = '';
    let totals = { gross:0, disc:0, net:0, ddp:0, svc:0, pb1:0, grand:0 };
    let rekapMetode = {};

    trx.forEach(row => {
        const tgl = new Date(row.created_at).toLocaleDateString('id-ID');
        const gross = parseFloat(row.subtotal || 0);
        const disc = parseFloat(row.diskon || 0);
        const net = gross - disc;
        
        // Penyesuaian nama kolom sesuai DB Anda: metode_pembayaran
        const mtd = row.metode_pembayaran || 'Tunai';

        const ddp = net / 1.155;
        const svc = ddp * 0.05;
        const pb1 = (ddp + svc) * 0.10;
        const grand = net;

        // Hitung Rekap per Metode
        if (!rekapMetode[mtd]) rekapMetode[mtd] = 0;
        rekapMetode[mtd] += grand;

        totals.gross += gross; totals.disc += disc; totals.net += net;
        totals.ddp += ddp; totals.svc += svc; totals.pb1 += pb1; totals.grand += grand;

        html += `
            <tr>
                <td class="text-left">${tgl}</td>
                <td class="text-left">${row.no_invoice || row.id}</td>
                <td>${gross.toLocaleString()}</td>
                <td>${disc.toLocaleString()}</td>
                <td>${net.toLocaleString()}</td>
                <td>${ddp.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                <td>${svc.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                <td>${pb1.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                <td style="text-align:center;"><span class="metode-pill">${mtd}</span></td>
                <td style="font-weight:bold;">${grand.toLocaleString()}</td>
            </tr>
        `;
    });

    document.getElementById('report-body').innerHTML = html;

    // Footer: Grand Total + Ringkasan Metode Pembayaran
    let footerHtml = `
        <tr class="grandtotal-row">
            <td colspan="2">GRAND TOTAL</td>
            <td>${totals.gross.toLocaleString()}</td>
            <td>${totals.disc.toLocaleString()}</td>
            <td>${totals.net.toLocaleString()}</td>
            <td>${totals.ddp.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
            <td>${totals.svc.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
            <td>${totals.pb1.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
            <td>-</td>
            <td>${totals.grand.toLocaleString()}</td>
        </tr>
        <tr style="height:20px;"></tr>
        <tr style="background:#eee;"><td colspan="10" style="text-align:left; font-weight:bold; padding-left:10px;">RINGKASAN METODE PEMBAYARAN</td></tr>
    `;

    for (const [namaMtd, nilai] of Object.entries(rekapMetode)) {
        footerHtml += `
            <tr class="rekap-row">
                <td colspan="9" style="text-align:right;">TOTAL ${namaMtd.toUpperCase()} :</td>
                <td>Rp ${nilai.toLocaleString()}</td>
            </tr>
        `;
    }

    document.getElementById('report-footer').innerHTML = footerHtml;
}

function exportToExcel() {
    const table = document.getElementById("table-laporan");
    const wb = XLSX.utils.table_to_book(table, { sheet: "Detail Penjualan" });
    XLSX.writeFile(wb, "Laporan_Detail_Penjualan_Finex.xlsx");
}
</script>
</body>
</html>
