<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Harian | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 1300px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        .filter-box { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        input, button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        button { cursor: pointer; font-weight: bold; }
        .btn-filter { background: var(--accent); color: white; border: none; }
        .btn-export { background: #27ae60; color: white; border: none; }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #f2f2f2; padding: 8px; border: 1px solid #ccc; text-align: center; }
        td { padding: 8px; border: 1px solid #ddd; text-align: right; }
        .text-left { text-align: left; }
        .text-center { text-align: center; }

        .bg-method { background: #fdfefe; }
        .font-bold { font-weight: bold; }
        .grandtotal-row { background: #2c3e50 !important; color: white !important; font-size: 12px; }

        @media print {
            .filter-box, .btn-export, .header button { display: none; }
            body { padding: 0; background: white; }
            .container { box-shadow: none; width: 100%; max-width: 100%; }
            table { font-size: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h2 style="margin:0; font-size: 18px;">Laporan Ringkasan Harian BeautyBloom</h2>
            <small>Finex POS System - Berdasarkan Metode Pembayaran</small>
        </div>
        <div>
            <button class="btn-export" onclick="exportToExcel()">üì• Export Excel</button>
            <button onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
    </div>

    <div class="filter-box">
        <div>
            <label style="display:block; font-size:10px;">Dari:</label>
            <input type="date" id="date-start">
        </div>
        <div>
            <label style="display:block; font-size:10px;">Sampai:</label>
            <input type="date" id="date-end">
        </div>
        <button class="btn-filter" onclick="loadHarian()">Tampilkan</button>
    </div>

    <div style="overflow-x: auto;">
        <table id="table-laporan">
            <thead>
                <tr>
                    <th rowspan="2">Tanggal</th>
                    <th rowspan="2">Gross Sales</th>
                    <th rowspan="2">Diskon</th>
                    <th colspan="4">Metode Pembayaran (Net)</th>
                    <th rowspan="2">Net Sales</th>
                    <th rowspan="2">DPP</th>
                    <th rowspan="2">Svc (5%)</th>
                    <th rowspan="2">PB1 (10%)</th>
                    <th rowspan="2">Grand Total</th>
                </tr>
                <tr>
                    <th class="bg-method">Tunai</th>
                    <th class="bg-method">QRIS</th>
                    <th class="bg-method">BCA</th>
                    <th class="bg-method">Lainnya</th>
                </tr>
            </thead>
            <tbody id="report-body">
                <tr><td colspan="12" class="text-center">Silahkan tentukan tanggal.</td></tr>
            </tbody>
            <tfoot id="report-footer"></tfoot>
        </table>
    </div>
</div>

<script>
const URL_DB = 'https://uojhjskgugghwxtdsfvm.supabase.co';
const KEY_DB = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
const FinexDB = window.supabase.createClient(URL_DB, KEY_DB);

window.onload = () => {
    const now = new Date();
    document.getElementById('date-start').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('date-end').value = now.toISOString().split('T')[0];
};

async function loadHarian() {
    const start = document.getElementById('date-start').value;
    const end = document.getElementById('date-end').value;
    
    const { data: trx, error } = await FinexDB.from('penjualan')
        .select('*')
        .gte('created_at', start + 'T00:00:00')
        .lte('created_at', end + 'T23:59:59')
        .order('created_at', { ascending: true });

    if (error) return alert("Error: " + error.message);

    // Grouping by Date
    const dailyData = {};

    trx.forEach(row => {
        const tglStr = new Date(row.created_at).toLocaleDateString('id-ID');
        if (!dailyData[tglStr]) {
            dailyData[tglStr] = {
                gross: 0, disc: 0, tunai: 0, qris: 0, bca: 0, lainnya: 0, net: 0
            };
        }

        const gross = parseFloat(row.subtotal || 0);
        const disc = parseFloat(row.diskon || 0);
        const net = gross - disc;
        const mtd = (row.metode_pembayaran || 'Tunai').toLowerCase();

        dailyData[tglStr].gross += gross;
        dailyData[tglStr].disc += disc;
        dailyData[tglStr].net += net;

        // Sort by Method
        if (mtd.includes('tunai')) dailyData[tglStr].tunai += net;
        else if (mtd.includes('qris')) dailyData[tglStr].qris += net;
        else if (mtd.includes('bca')) dailyData[tglStr].bca += net;
        else dailyData[tglStr].lainnya += net;
    });

    let html = '';
    let grand = { gross:0, disc:0, tunai:0, qris:0, bca:0, lainnya:0, net:0, dpp:0, svc:0, pb1:0, total:0 };

    function formatNum(n) { return Math.round(n).toLocaleString('id-ID'); }

    Object.keys(dailyData).forEach(tgl => {
        const d = dailyData[tgl];
        const dpp = d.net / 1.155;
        const svc = dpp * 0.05;
        const pb1 = (dpp + svc) * 0.10;
        const total = d.net;

        grand.gross += d.gross; grand.disc += d.disc; grand.net += d.net;
        grand.tunai += d.tunai; grand.qris += d.qris; grand.bca += d.bca; grand.lainnya += d.lainnya;
        grand.dpp += dpp; grand.svc += svc; grand.pb1 += pb1; grand.total += total;

        html += `
            <tr>
                <td class="text-left">${tgl}</td>
                <td>${formatNum(d.gross)}</td>
                <td>${formatNum(d.disc)}</td>
                <td class="bg-method">${formatNum(d.tunai)}</td>
                <td class="bg-method">${formatNum(d.qris)}</td>
                <td class="bg-method">${formatNum(d.bca)}</td>
                <td class="bg-method">${formatNum(d.lainnya)}</td>
                <td class="font-bold">${formatNum(d.net)}</td>
                <td>${formatNum(dpp)}</td>
                <td>${formatNum(svc)}</td>
                <td>${formatNum(pb1)}</td>
                <td class="font-bold">${formatNum(total)}</td>
            </tr>
        `;
    });

    document.getElementById('report-body').innerHTML = html;
    document.getElementById('report-footer').innerHTML = `
        <tr class="grandtotal-row">
            <td>TOTAL</td>
            <td>${formatNum(grand.gross)}</td>
            <td>${formatNum(grand.disc)}</td>
            <td>${formatNum(grand.tunai)}</td>
            <td>${formatNum(grand.qris)}</td>
            <td>${formatNum(grand.bca)}</td>
            <td>${formatNum(grand.lainnya)}</td>
            <td>${formatNum(grand.net)}</td>
            <td>${formatNum(grand.dpp)}</td>
            <td>${formatNum(grand.svc)}</td>
            <td>${formatNum(grand.pb1)}</td>
            <td>${formatNum(grand.total)}</td>
        </tr>
    `;
}

function exportToExcel() {
    const table = document.getElementById("table-laporan");
    const wb = XLSX.utils.table_to_book(table, { sheet: "Laporan Harian" });
    XLSX.writeFile(wb, "Laporan_Harian_Finex.xlsx");
}
</script>
</body>
</html>
