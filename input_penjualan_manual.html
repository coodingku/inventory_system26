<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Dinamis BeautyBloom | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #4f46e5; 
            --success: #059669;
            --bg: #f1f5f9;
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); max-width: 1200px; margin: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }
        .header h2 { margin: 0; color: var(--primary); }
        
        .filter-box { display: flex; gap: 15px; margin-bottom: 25px; background: #f8fafc; padding: 20px; border-radius: 12px; align-items: flex-end; border: 1px solid #e2e8f0; }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        
        input, button { padding: 10px 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; }
        .btn-filter { background: var(--accent); color: white; border: none; font-weight: 600; cursor: pointer; }
        .btn-export { background: var(--success); color: white; border: none; font-weight: 600; cursor: pointer; }
        
        .table-wrapper { overflow-x: auto; margin-top: 10px; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #1e293b; color: white; padding: 12px 10px; font-size: 11px; text-transform: uppercase; border: 1px solid #334155; }
        td { padding: 10px; border: 1px solid #e2e8f0; font-size: 13px; text-align: right; }
        
        .text-left { text-align: left; }
        .font-bold { font-weight: 700; }
        .bg-payment { background: #fdf2f8; color: #9d174d; }
        .bg-total { background: #fff7ed; font-weight: 800; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .summary-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; }
        .summary-card h3 { margin-top: 0; font-size: 14px; color: #64748b; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }
        
        .summary-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #cbd5e1; }
        .summary-item:last-child { border-bottom: none; font-weight: bold; font-size: 16px; color: var(--primary); }

        .footer-row { background: #f1f5f9; font-weight: 800; }
        .loading { text-align: center; padding: 50px; color: #64748b; }

        @media print {
            .filter-box, .btn-export, button { display: none; }
            body { padding: 0; background: white; }
            .container { box-shadow: none; border: none; max-width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h2>Laporan Penjualan BeautyBloom</h2>
            <div style="color: #64748b; font-size: 14px;">Sistem Finex Pos - Laporan Rincian Pembayaran Dinamis</div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-export" onclick="exportToExcel()">Export Excel</button>
            <button onclick="window.print()">Cetak</button>
        </div>
    </div>

    <div class="filter-box">
        <div class="filter-group">
            <label>Mulai Tanggal</label>
            <input type="date" id="date-start">
        </div>
        <div class="filter-group">
            <label>Sampai Tanggal</label>
            <input type="date" id="date-end">
        </div>
        <button class="btn-filter" onclick="fetchData()">Proses Data</button>
    </div>

    <div id="content-area">
        <div class="loading">Silahkan pilih rentang tanggal untuk memproses laporan.</div>
    </div>

    <div id="summary-area" class="summary-grid">
        <!-- Rincian Bawah Akan Muncul Di Sini -->
    </div>
</div>

<script>
const SUPA_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';

const client = supabase.createClient(SUPA_URL, SUPA_KEY);

window.onload = () => {
    const now = new Date();
    document.getElementById('date-start').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('date-end').value = now.toISOString().split('T')[0];
};

async function fetchData() {
    const start = document.getElementById('date-start').value;
    const end = document.getElementById('date-end').value;
    
    document.getElementById('content-area').innerHTML = '<div class="loading">Memproses data dari POS...</div>';
    document.getElementById('summary-area').innerHTML = '';

    try {
        const { data, error } = await client
            .from('penjualan')
            .select('*')
            .gte('created_at', start + 'T00:00:00')
            .lte('created_at', end + 'T23:59:59')
            .order('created_at', { ascending: true });

        if (error) throw error;
        if (!data || data.length === 0) {
            document.getElementById('content-area').innerHTML = '<div class="loading">Tidak ada transaksi ditemukan.</div>';
            return;
        }

        processAndRender(data);
    } catch (err) {
        document.getElementById('content-area').innerHTML = `<div class="loading" style="color:red">Error: ${err.message}</div>`;
    }
}

function processAndRender(data) {
    const dailyData = {};
    const paymentMethods = new Set();
    
    // Inisialisasi Grand Totals
    const totals = {
        gross: 0,
        disc: 0,
        nett: 0,
        dpp: 0,
        svc: 0,
        pb1: 0,
        methods: {},
        grandTotal: 0
    };

    data.forEach(item => {
        let method = (item.metode_pembayaran || 'TUNAI').trim().toUpperCase();
        paymentMethods.add(method);

        const dateKey = new Date(item.created_at).toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
        
        if (!dailyData[dateKey]) {
            dailyData[dateKey] = { gross: 0, disc: 0, payments: {} };
        }

        const sub = parseFloat(item.subtotal || 0);
        const disc = parseFloat(item.diskon || 0);
        const nett = sub - disc;

        dailyData[dateKey].gross += sub;
        dailyData[dateKey].disc += disc;
        dailyData[dateKey].payments[method] = (dailyData[dateKey].payments[method] || 0) + nett;
        
        // Akumulasi Global
        totals.gross += sub;
        totals.disc += disc;
        totals.methods[method] = (totals.methods[method] || 0) + nett;
    });

    const sortedMethods = Array.from(paymentMethods).sort();
    
    // Hitung Pajak Global
    totals.nett = totals.gross - totals.disc;
    totals.dpp = totals.nett / 1.155;
    totals.svc = totals.dpp * 0.05;
    totals.pb1 = (totals.dpp + totals.svc) * 0.10;
    totals.grandTotal = Object.values(totals.methods).reduce((a, b) => a + b, 0);

    renderTable(dailyData, sortedMethods, totals);
    renderSummary(totals, sortedMethods);
}

function renderTable(dailyData, methods, grandTotals) {
    const f = (v) => "Rp " + Math.round(v).toLocaleString('id-ID');
    
    let html = `
        <div class="table-wrapper">
            <table id="report-table">
                <thead>
                    <tr>
                        <th rowspan="2">Tanggal</th>
                        <th rowspan="2">Gross Sales</th>
                        <th rowspan="2">Diskon</th>
                        <th rowspan="2">Net Sales</th>
                        <th colspan="3">Pajak & Service (Est)</th>
                        <th colspan="${methods.length}" style="background:#831843">Metode Pembayaran (POS)</th>
                        <th rowspan="2" style="background:#c2410c">Total Harian</th>
                    </tr>
                    <tr>
                        <th>DPP</th>
                        <th>Svc (5%)</th>
                        <th>PB1 (10%)</th>
                        ${methods.map(m => `<th class="bg-payment">${m}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
    `;

    Object.keys(dailyData).forEach(tgl => {
        const d = dailyData[tgl];
        const nett = d.gross - d.disc;
        const dpp = nett / 1.155;
        const svc = dpp * 0.05;
        const pb1 = (dpp + svc) * 0.10;
        let rowPaymentSum = 0;

        html += `
            <tr>
                <td class="text-left font-bold">${tgl}</td>
                <td>${f(d.gross)}</td>
                <td style="color:red">-${f(d.disc)}</td>
                <td class="font-bold">${f(nett)}</td>
                <td>${f(dpp)}</td>
                <td>${f(svc)}</td>
                <td>${f(pb1)}</td>
        `;

        methods.forEach(m => {
            const val = d.payments[m] || 0;
            rowPaymentSum += val;
            html += `<td class="bg-payment">${val > 0 ? f(val) : '-'}</td>`;
        });

        html += `<td class="bg-total">${f(rowPaymentSum)}</td></tr>`;
    });

    // Footer Table
    html += `
                </tbody>
                <tfoot>
                    <tr class="footer-row">
                        <td class="text-left">TOTAL</td>
                        <td>${f(grandTotals.gross)}</td>
                        <td>-${f(grandTotals.disc)}</td>
                        <td>${f(grandTotals.nett)}</td>
                        <td>${f(grandTotals.dpp)}</td>
                        <td>${f(grandTotals.svc)}</td>
                        <td>${f(grandTotals.pb1)}</td>
                        ${methods.map(m => `<td>${f(grandTotals.methods[m])}</td>`).join('')}
                        <td style="background:#fbbf24">${f(grandTotals.grandTotal)}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;

    document.getElementById('content-area').innerHTML = html;
}

function renderSummary(totals, methods) {
    const f = (v) => "Rp " + Math.round(v).toLocaleString('id-ID');
    
    let methodHtml = methods.map(m => `
        <div class="summary-item">
            <span>${m}</span>
            <span>${f(totals.methods[m])}</span>
        </div>
    `).join('');

    let summaryHtml = `
        <div class="summary-card">
            <h3>Rincian Pendapatan & Pajak</h3>
            <div class="summary-item"><span>Total Gross Sales</span><span>${f(totals.gross)}</span></div>
            <div class="summary-item"><span style="color:red">Total Diskon</span><span style="color:red">-${f(totals.disc)}</span></div>
            <div class="summary-item"><span>Total Net Sales</span><span>${f(totals.nett)}</span></div>
            <div style="margin: 10px 0; border-top: 1px solid #e2e8f0;"></div>
            <div class="summary-item"><span>Dasar Pengenaan Pajak (DPP)</span><span>${f(totals.dpp)}</span></div>
            <div class="summary-item"><span>Service Charge (5%)</span><span>${f(totals.svc)}</span></div>
            <div class="summary-item"><span>PB1 / Pajak (10%)</span><span>${f(totals.pb1)}</span></div>
        </div>

        <div class="summary-card">
            <h3>Rincian Pembayaran (POS)</h3>
            ${methodHtml}
            <div style="margin: 10px 0; border-top: 2px solid #1e293b;"></div>
            <div class="summary-item">
                <span style="color:var(--accent)">GRAND TOTAL</span>
                <span style="color:var(--accent)">${f(totals.grandTotal)}</span>
            </div>
        </div>
    `;

    document.getElementById('summary-area').innerHTML = summaryHtml;
}

function exportToExcel() {
    const table = document.getElementById("report-table");
    if(!table) return;
    const wb = XLSX.utils.table_to_book(table, { sheet: "Laporan BeautyBloom" });
    XLSX.writeFile(wb, `Laporan_Rincian_POS_${new Date().getTime()}.xlsx`);
}
</script>

</body>
</html>
