<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Penjualan | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); max-width: 1100px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        
        .filter-box { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; }
        input, button { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-filter { background: var(--accent); color: white; border: none; }
        .btn-filter:hover { background: #2980b9; }
        .btn-export { background: #27ae60; color: white; border: none; }

        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 30px; }
        th { background: #f8f9fa; padding: 12px 8px; border: 1px solid #ddd; text-align: center; color: #333; }
        td { padding: 10px 8px; border: 1px solid #ddd; text-align: right; }
        
        .date-header { background: #2c3e50; color: white; text-align: left; font-weight: bold; padding: 10px; font-size: 14px; }
        .method-name { text-align: left; font-weight: bold; color: var(--accent); }
        .subtotal-row { background: #fdfdfd; font-weight: bold; }
        .grand-total-section { background: #e67e22; color: white; font-size: 14px; font-weight: bold; }
        
        @media print {
            .filter-box, .btn-export, button { display: none; }
            body { padding: 0; background: white; }
            .container { box-shadow: none; border: none; width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h2 style="margin:0;">Laporan Detail Penjualan BeautyBloom</h2>
            <p style="margin:5px 0 0; color: #666; font-size: 12px;">Dikelompokkan per Tanggal & Metode Pembayaran</p>
        </div>
        <div>
            <button class="btn-export" onclick="exportToExcel()">üì• Export Excel</button>
            <button onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
    </div>

    <div class="filter-box">
        <div>
            <label style="display:block; font-size:11px;">Mulai Tanggal:</label>
            <input type="date" id="date-start">
        </div>
        <div>
            <label style="display:block; font-size:11px;">Sampai Tanggal:</label>
            <input type="date" id="date-end">
        </div>
        <button class="btn-filter" onclick="loadDetailLaporan()">Tampilkan Laporan</button>
    </div>

    <div id="report-content">
        <p style="text-align:center; color:#999; margin-top:50px;">Silakan pilih tanggal dan klik tampilkan.</p>
    </div>
</div>

<script>
const URL_DB = 'https://uojhjskgugghwxtdsfvm.supabase.co';
const KEY_DB = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
const FinexDB = window.supabase.createClient(URL_DB, KEY_DB);

window.onload = () => {
    const now = new Date();
    document.getElementById('date-start').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('date-end').value = now.toISOString().split('T')[0];
};

async function loadDetailLaporan() {
    const start = document.getElementById('date-start').value;
    const end = document.getElementById('date-end').value;
    const container = document.getElementById('report-content');
    
    container.innerHTML = '<p style="text-align:center;">Mengambil data...</p>';

    const { data: trx, error } = await FinexDB.from('penjualan')
        .select('*')
        .gte('created_at', start + 'T00:00:00')
        .lte('created_at', end + 'T23:59:59')
        .order('created_at', { ascending: true });

    if (error) return alert("Gagal ambil data: " + error.message);
    if (!trx || trx.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:red;">Tidak ada data pada periode ini.</p>';
        return;
    }

    // --- PROSES GROUPING ---
    const groupedData = {};
    let overallTotal = 0;

    trx.forEach(row => {
        const tgl = new Date(row.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
        const mtd = row.metode_pembayaran || 'Tunai';

        if (!groupedData[tgl]) groupedData[tgl] = {};
        if (!groupedData[tgl][mtd]) {
            groupedData[tgl][mtd] = { gross: 0, disc: 0, net: 0, count: 0 };
        }

        const gross = parseFloat(row.subtotal || 0);
        const disc = parseFloat(row.diskon || 0);
        const net = gross - disc;

        groupedData[tgl][mtd].gross += gross;
        groupedData[tgl][mtd].disc += disc;
        groupedData[tgl][mtd].net += net;
        groupedData[tgl][mtd].count += 1;
        overallTotal += net;
    });

    // --- RENDER HTML ---
    let html = '';

    for (const [tanggal, metodes] of Object.entries(groupedData)) {
        html += `
            <table class="table-data">
                <thead>
                    <tr><th colspan="7" class="date-header">üìÖ TANGGAL: ${tanggal}</th></tr>
                    <tr>
                        <th style="width: 20%;">Metode Pembayaran</th>
                        <th>Gross (Kotor)</th>
                        <th>Potongan/Disc</th>
                        <th style="background:#e8f4fd;">DPP (Net/1.15)</th>
                        <th>Svc (5%)</th>
                        <th>PB1 (10%)</th>
                        <th style="background:#fef5e7;">Total Terbayar</th>
                    </tr>
                </thead>
                <tbody>
        `;

        let dailyTotal = 0;

        for (const [namaMtd, val] of Object.entries(metodes)) {
            // Kalkulasi inklusif 1.15
            const dpp = val.net / 1.15;
            const svc = dpp * 0.05;
            const pb1 = dpp * 0.10;
            dailyTotal += val.net;

            html += `
                <tr>
                    <td class="method-name">${namaMtd.toUpperCase()} <span style="font-weight:normal; font-size:10px;">(${val.count} Trx)</span></td>
                    <td>${val.gross.toLocaleString()}</td>
                    <td style="color:red;">-${val.disc.toLocaleString()}</td>
                    <td style="font-family:monospace;">${Math.round(dpp).toLocaleString()}</td>
                    <td style="font-family:monospace;">${Math.round(svc).toLocaleString()}</td>
                    <td style="font-family:monospace;">${Math.round(pb1).toLocaleString()}</td>
                    <td style="font-weight:bold; background:#fffcf9;">${val.net.toLocaleString()}</td>
                </tr>
            `;
        }

        html += `
                </tbody>
                <tfoot>
                    <tr class="subtotal-row">
                        <td colspan="6" style="text-align:right;">TOTAL HARIAN (${tanggal}) :</td>
                        <td style="border-top: 2px solid #333;">Rp ${dailyTotal.toLocaleString()}</td>
                    </tr>
                </tfoot>
            </table>
        `;
    }

    html += `
        <div style="margin-top:20px; padding:15px; background:#2c3e50; color:white; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:16px;">GRAND TOTAL KESELURUHAN</span>
            <span style="font-size:20px; font-weight:bold;">Rp ${overallTotal.toLocaleString()}</span>
        </div>
    `;

    container.innerHTML = html;
}

function exportToExcel() {
    const tableWrap = document.getElementById("report-content");
    const wb = XLSX.utils.book_new();
    
    // Kita ambil semua table di dalam report-content
    const tables = tableWrap.querySelectorAll("table");
    
    // Gabungkan data untuk excel sederhana
    let dataForExcel = [
        ["LAPORAN DETAIL PENJUALAN BEAUTYBLOOM"],
        ["Periode:", document.getElementById('date-start').value, "s/d", document.getElementById('date-end').value],
        [],
        ["Tanggal", "Metode", "Gross", "Diskon", "DPP", "Service", "PB1", "Total Net"]
    ];

    // Iterasi manual untuk struktur Excel yang rapi
    const start = document.getElementById('date-start').value;
    const end = document.getElementById('date-end').value;

    // Logic export ini mengambil data dari tabel yang ter-render
    tables.forEach(table => {
        const tgl = table.querySelector(".date-header").innerText.replace("üìÖ TANGGAL: ", "");
        const rows = table.querySelectorAll("tbody tr");
        
        rows.forEach(row => {
            const cells = row.querySelectorAll("td");
            dataForExcel.push([
                tgl,
                cells[0].innerText,
                cells[1].innerText.replace(/,/g, ''),
                cells[2].innerText.replace(/,/g, '').replace('-', ''),
                cells[3].innerText.replace(/,/g, ''),
                cells[4].innerText.replace(/,/g, ''),
                cells[5].innerText.replace(/,/g, ''),
                cells[6].innerText.replace(/,/g, '')
            ]);
        });
    });

    const ws = XLSX.utils.aoa_to_sheet(dataForExcel);
    XLSX.utils.book_append_sheet(wb, ws, "Laporan Detail");
    XLSX.writeFile(wb, `Laporan_BeautyBloom_${new Date().getTime()}.xlsx`);
}
</script>
</body>
</html>
