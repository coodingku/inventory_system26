<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finex Pos | Restock Kasir BeautyBloom</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e91e63; --bg: #fdf2f8; --white: #ffffff; --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; background: var(--bg); color: var(--primary); }
        
        /* Sidebar */
        nav { width: 220px; background: var(--primary); color: white; min-height: 100vh; padding: 20px; position: fixed; z-index: 10; }
        nav h2 { border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 20px; font-size: 20px; color: #ff85a2; text-align: center; }
        nav a { color: #bdc3c7; text-decoration: none; display: block; padding: 12px; border-radius: 5px; margin-bottom: 5px; font-size: 14px; transition: 0.3s; }
        nav a:hover, nav a.active { background: var(--accent); color: white; }

        /* Main Content */
        main { flex: 1; margin-left: 260px; padding: 30px; }
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .action-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .search-box { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; min-width: 250px; }
        
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 13px; }
        .btn:active { transform: scale(0.98); }
        .btn-restock { background: var(--warning); color: white; }

        /* Table Card */
        .card-table { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #fff1f2; border-bottom: 2px solid #eee; font-size: 14px; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }

        .badge-stock { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; display: inline-block; }
        .stock-low { background: #fee2e2; color: #991b1b; }
        .stock-ok { background: #e0f2fe; color: #0369a1; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }

        .loading-overlay { display: none; position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); justify-content: center; align-items: center; border-radius: 15px; z-index: 5; }

        /* Print Area */
        #print-area { display: none; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                display: block !important; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                font-family: 'Courier New', monospace;
                padding: 20px;
            }
            .no-print { display: none; }
        }
    </style>
</head>
<body>

<nav class="no-print">
    <h2>Finex Pos</h2>
    <div style="font-size: 10px; color: #888; margin-left: 12px; margin-bottom: 5px; margin-top: 20px;">MENU KASIR</div>
    <a href="pos.html">ðŸ›’ Transaksi Baru</a>
    <a href="produk_kasir.html" class="active">ðŸ“¦ Stok & Restock</a>
    <hr style="border: 0.5px solid #555; margin: 10px 0;">
    <a href="index.html" style="background: #444; color: white; text-align:center;">ðŸšª Keluar</a>
</nav>

<main class="no-print">
    <div class="header-section">
        <h1>ðŸ“¦ Management Stok Toko</h1>
        <div style="text-align: right">
            <span style="font-size: 12px; color: #666;">Unit: BeautyBloom</span>
        </div>
    </div>

    <div class="action-bar">
        <input type="text" id="searchBar" class="search-box" placeholder="Cari nama produk..." onkeyup="filterProduk()">
    </div>

    <div class="card-table">
        <table>
            <thead>
                <tr>
                    <th>Nama Produk</th>
                    <th>Stok Toko</th>
                    <th>Stok Gudang</th>
                    <th style="text-align: center;">Aksi</th>
                </tr>
            </thead>
            <tbody id="product-list"></tbody>
        </table>
    </div>
</main>

<!-- Modal Restock -->
<div id="restockModal" class="modal no-print">
    <div class="modal-content">
        <div id="modalLoading" class="loading-overlay">Memproses...</div>
        <h3 style="margin-top:0; color:var(--primary);">Restock Barang</h3>
        <p id="target-name" style="font-weight:bold; color:var(--accent); margin-bottom:5px;"></p>
        <p id="target-info" style="font-size:12px; color:#666; margin-bottom:20px;"></p>
        
        <div class="form-group">
            <label>Jumlah Masuk ke Toko</label>
            <input type="number" id="input-qty" placeholder="0" min="1">
        </div>

        <div style="display: flex; gap: 10px;">
            <button class="btn" style="background:#eee; flex:1" onclick="closeModal()">Batal</button>
            <button class="btn btn-restock" style="flex:2; justify-content:center;" onclick="handleSaveRestock()">Simpan & Print</button>
        </div>
    </div>
</div>

<!-- Print Out Template -->
<div id="print-area">
    <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
        <h3 style="margin:0;">FINEX POS</h3>
        <p style="margin:0; font-size: 12px;">BeautyBloom Store</p>
        <p style="margin:0; font-size: 10px;" id="print-date"></p>
    </div>
    <div style="text-align: center; margin-bottom: 10px;">
        <h4 style="margin:5px 0;">BUKTI RESTOCK BARANG</h4>
    </div>
    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
        <tr>
            <td style="padding: 5px 0;">Produk:</td>
            <td style="text-align: right; font-weight: bold;" id="print-prod-name"></td>
        </tr>
        <tr>
            <td style="padding: 5px 0;">Jumlah Restock:</td>
            <td style="text-align: right; font-weight: bold;" id="print-qty"></td>
        </tr>
        <tr>
            <td style="padding: 5px 0;">Stok Akhir Toko:</td>
            <td style="text-align: right;" id="print-final-toko"></td>
        </tr>
    </table>
    <div style="margin-top: 20px; border-top: 1px dashed #000; padding-top: 10px; text-align: center; font-size: 10px;">
        <p>Barang telah dipindahkan dari Gudang ke Toko.</p>
        <p>Petugas Kasir: BeautyBloom Staff</p>
    </div>
</div>

<script>
    const SB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    const FinexDB = window.supabase.createClient(SB_URL, SB_KEY);

    let masterData = [];
    let selectedProduct = null;

    window.onload = () => fetchProduk();

    async function fetchProduk() {
        const { data } = await FinexDB.from('produk').select('*').order('nama_barang');
        masterData = data || [];
        renderTable(masterData);
    }

    function renderTable(data) {
        const tbody = document.getElementById('product-list');
        tbody.innerHTML = data.map(p => `
            <tr>
                <td><b>${p.nama_barang}</b></td>
                <td><span class="badge-stock ${p.stok_sekarang <= 5 ? 'stock-low' : 'stock-ok'}">${p.stok_sekarang}</span></td>
                <td><span class="badge-stock" style="background:#f3f4f6">${p.stok_gudang || 0}</span></td>
                <td style="text-align: center;">
                    <button class="btn btn-restock" style="padding: 6px 12px; font-size: 11px;" onclick="openRestockModal('${p.id}')">ðŸ“¦ Restock</button>
                </td>
            </tr>
        `).join('');
    }

    function openRestockModal(id) {
        selectedProduct = masterData.find(x => x.id === id);
        document.getElementById('target-name').innerText = selectedProduct.nama_barang;
        document.getElementById('target-info').innerText = `Toko: ${selectedProduct.stok_sekarang} | Gudang: ${selectedProduct.stok_gudang}`;
        document.getElementById('input-qty').value = '';
        document.getElementById('restockModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('restockModal').style.display = 'none';
        selectedProduct = null;
    }

    async function handleSaveRestock() {
        const qty = parseInt(document.getElementById('input-qty').value);
        
        if (!qty || qty <= 0) return alert("Masukkan jumlah yang valid");
        if (qty > selectedProduct.stok_gudang) return alert("Stok gudang tidak mencukupi!");

        document.getElementById('modalLoading').style.display = 'flex';

        const newStokToko = selectedProduct.stok_sekarang + qty;
        const newStokGudang = (selectedProduct.stok_gudang || 0) - qty;

        try {
            // 1. Update ke Tabel Produk
            const { error: errProd } = await FinexDB.from('produk').update({
                stok_sekarang: newStokToko,
                stok_gudang: newStokGudang
            }).eq('id', selectedProduct.id);

            if (errProd) throw errProd;

            // 2. Catat ke Tabel Riwayat Restock
            const { error: errHist } = await FinexDB.from('riwayat_restock').insert([
                {
                    nama_produk: selectedProduct.nama_barang,
                    jumlah: qty,
                    role: 'Kasir',
                    catatan: 'Pindah Gudang ke Toko'
                }
            ]);

            if (errHist) throw errHist;

            // Persiapan Data Print
            document.getElementById('print-date').innerText = new Date().toLocaleString('id-ID');
            document.getElementById('print-prod-name').innerText = selectedProduct.nama_barang;
            document.getElementById('print-qty').innerText = qty;
            document.getElementById('print-final-toko').innerText = newStokToko;

            // Trigger Print
            window.print();

            // Refresh Data & Close
            closeModal();
            fetchProduk();

        } catch (err) {
            console.error(err);
            alert("Terjadi kesalahan saat menyimpan data.");
        } finally {
            document.getElementById('modalLoading').style.display = 'none';
        }
    }

    function filterProduk() {
        const q = document.getElementById('searchBar').value.toLowerCase();
        renderTable(masterData.filter(p => p.nama_barang.toLowerCase().includes(q)));
    }
</script>
</body>
</html>
