<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Pengaturan Sistem</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="supabase-init.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        nav { width: 240px; background: var(--primary); color: white; height: 100vh; padding: 20px; position: fixed; box-sizing: border-box; }
        nav h2 { color: var(--accent); text-align: center; font-size: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        nav a { color: #bdc3c7; text-decoration: none; display: block; padding: 12px; border-radius: 8px; margin-bottom: 5px; font-size: 14px; }
        nav a:hover { background: rgba(255,255,255,0.1); color: white; }
        nav a.active { background: var(--accent); color: white; }

        main { flex: 1; margin-left: 240px; padding: 30px; }
        .header { margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .card h3 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { color: #7f8c8d; font-size: 13px; text-transform: uppercase; }
        
        .input-group { display: flex; gap: 10px; margin-top: 15px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--accent); }
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-save { background: var(--success); color: white; }
        .btn-save:hover { background: #219150; }
        .btn-del { background: #fee; color: var(--danger); font-size: 12px; padding: 8px 12px; }
        .btn-del:hover { background: var(--danger); color: white; }
    </style>
</head>
<body>

    <nav>
        <h2 id="store-name-display">Finex Pos</h2>
        <a href="dashboard.html">üìä Dashboard</a>
        <a href="pos.html">üõí Masuk Kasir</a>
        <hr style="border:0; border-top:1px solid #444; margin:15px 0;">
        <a href="akun_jurnal.html">üìñ Daftar Akun</a>
        <a href="laporan_neraca.html">‚öñÔ∏è Laporan Neraca</a>
        <a href="laba_rugi.html">üìà Laba Rugi</a>
        <a href="pengaturan.html" class="active">‚öôÔ∏è Pengaturan</a>
    </nav>

    <main>
        <div class="header">
            <h1>Pengaturan Sistem</h1>
            <p style="color: #7f8c8d;">Kelola konfigurasi pajak dan promo toko</p>
        </div>

        <div class="card">
            <h3>Tarif Pajak Global (PPN/PB1)</h3>
            <p style="font-size: 14px; color: #666;">Besaran pajak ini akan otomatis diterapkan pada setiap transaksi di kasir.</p>
            <div class="input-group">
                <input type="number" id="input-ppn" placeholder="Contoh: 11" style="width: 150px;">
                <button class="btn btn-save" onclick="updatePPN()">Perbarui Pajak</button>
            </div>
        </div>

        <div class="card">
            <h3>Manajemen Diskon & Promo</h3>
            <p style="font-size: 14px; color: #666;">Tambahkan pilihan potongan harga untuk pelanggan.</p>
            <div class="input-group">
                <input type="text" id="nama-diskon" placeholder="Nama Promo (ex: Promo Member)" style="flex: 2;">
                <input type="number" id="persen-diskon" placeholder="Persen (%)" style="flex: 1;">
                <button class="btn btn-save" onclick="tambahDiskon()">+ Tambah</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Nama Diskon</th>
                        <th>Besaran</th>
                        <th style="text-align: right;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="list-diskon">
                    </tbody>
            </table>
        </div>
    </main>

    <script>
        // Variabel 'db' disediakan secara dinamis oleh supabase-init.js

        window.onload = loadData;

        async function loadData() {
            try {
                // 1. Load PPN (ID 1) dari database pelanggan
                const { data: ppn, error: errPpn } = await db.from('ppn').select('*').eq('id', 1).maybeSingle();
                if(ppn) {
                    document.getElementById('input-ppn').value = ppn.nilai;
                } else {
                    console.warn("Data PPN id=1 tidak ditemukan di database pelanggan.");
                }

                // 2. Load Diskon dari database pelanggan
                const { data: diskon, error: errDisk } = await db.from('diskon').select('*').order('persen', {ascending: true});
                const tbody = document.getElementById('list-diskon');
                tbody.innerHTML = '';
                
                if (diskon) {
                    diskon.forEach(d => {
                        tbody.innerHTML += `
                            <tr>
                                <td><strong>${d.nama_diskon}</strong></td>
                                <td>${d.persen}%</td>
                                <td style="text-align: right;">
                                    <button class="btn btn-del" onclick="hapusDiskon('${d.id}')">Hapus</button>
                                </td>
                            </tr>`;
                    });
                }
            } catch (error) {
                console.error("Gagal memuat data pengaturan:", error);
            }
        }

        async function updatePPN() {
            const n = document.getElementById('input-ppn').value;
            if(!n) return alert("Masukkan nilai pajak!");
            
            // Update tabel 'ppn' milik pelanggan
            const { error } = await db.from('ppn').update({ nilai: parseFloat(n) }).eq('id', 1);
            if(error) {
                alert("Gagal update pajak: " + error.message);
            } else {
                alert("Pajak Berhasil diperbarui ke " + n + "%");
                loadData();
            }
        }

        async function tambahDiskon() {
            const nama = document.getElementById('nama-diskon').value.trim();
            const persen = document.getElementById('persen-diskon').value;
            
            if(!nama || !persen) return alert("Isi semua data promo!");

            // Insert ke tabel 'diskon' milik pelanggan
            const { error } = await db.from('diskon').insert([{ nama_diskon: nama, persen: parseFloat(persen) }]);
            if(error) {
                alert("Gagal menambah diskon: " + error.message);
            } else {
                document.getElementById('nama-diskon').value = '';
                document.getElementById('persen-diskon').value = '';
                loadData();
            }
        }

        async function hapusDiskon(id) {
            if(confirm("Hapus pilihan promo ini secara permanen?")) {
                const { error } = await db.from('diskon').delete().eq('id', id);
                if(error) {
                    alert("Gagal menghapus: " + error.message);
                } else {
                    loadData();
                }
            }
        }
    </script>
</body>
</html>
