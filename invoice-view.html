<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Receipt | Finex Pos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Courier New', Courier, monospace; background: #eee; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .receipt-card { background: white; width: 100%; max-width: 350px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 4px; }
        .header { text-align: center; border-bottom: 1px dashed #ccc; padding-bottom: 15px; margin-bottom: 15px; }
        .header h2 { margin: 0; color: #333; }
        .info { font-size: 13px; line-height: 1.6; margin-bottom: 15px; }
        .items-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .items-table th { border-bottom: 1px dashed #ccc; text-align: left; padding-bottom: 5px; }
        .items-table td { padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        .summary { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 14px; }
        .flex { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .bold { font-weight: bold; font-size: 16px; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #888; border-top: 1px dashed #ccc; padding-top: 15px; }
        .loading { text-align: center; padding: 50px; color: #666; }
        @media print { body { background: white; padding: 0; } .receipt-card { box-shadow: none; width: 100%; } }
    </style>
</head>
<body>

    <div id="loader" class="loading">Memuat Nota...</div>
    
    <div id="receipt" class="receipt-card" style="display: none;">
        <div class="header">
            <h2>Finex Pos</h2>
            <p style="font-size: 12px; margin: 5px 0;">Kantin Kejujuran & Terpercaya</p>
        </div>

        <div class="info">
            <div class="flex"><span>No. Invoice:</span><span id="inv-no"></span></div>
            <div class="flex"><span>Tanggal:</span><span id="inv-date"></span></div>
            <div class="flex"><span>Kasir:</span><span id="inv-kasir"></span></div>
            <div class="flex"><span>Metode:</span><span id="inv-method"></span></div>
        </div>

        <table class="items-table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th style="text-align: right;">Total</th>
                </tr>
            </thead>
            <tbody id="inv-items">
                </tbody>
        </table>

        <div class="summary">
            <div class="flex"><span>Subtotal</span><span id="inv-subtotal"></span></div>
            <div id="row-diskon" class="flex" style="color: red; display: none;">
                <span>Diskon</span><span id="inv-diskon"></span>
            </div>
            <div class="flex bold"><span>TOTAL</span><span id="inv-total"></span></div>
            <div class="flex" style="margin-top: 10px;"><span>Bayar</span><span id="inv-bayar"></span></div>
            <div class="flex"><span>Kembali</span><span id="inv-kembali"></span></div>
        </div>

        <div class="footer">
            <p>Terima kasih atas kunjungan Anda!</p>
            <p>Simpan nota ini sebagai bukti pembayaran sah.</p>
        </div>
        
        <button onclick="window.print()" style="width: 100%; margin-top: 20px; padding: 10px; border: none; background: #2c3e50; color: white; border-radius: 4px; cursor: pointer;" class="no-print">Cetak / Simpan PDF</button>
    </div>

<script>
    const URL_DB = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const KEY_DB = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    const supabase = window.supabase.createClient(URL_DB, KEY_DB);

    async function loadInvoice() {
        const urlParams = new URLSearchParams(window.location.search);
        const invoiceId = urlParams.get('id');

        if (!invoiceId) {
            document.getElementById('loader').innerText = "ID Nota tidak ditemukan.";
            return;
        }

        try {
            // 1. Ambil data Header Penjualan
            const { data: trx, error: errTrx } = await supabase
                .from('penjualan')
                .select('*, kasir_log(kasir_nama)')
                .eq('id', invoiceId)
                .single();

            if (errTrx || !trx) throw new Error("Nota tidak ditemukan di database.");

            // 2. Ambil data Detail Barang
            const { data: items, error: errItems } = await supabase
                .from('penjualan_detail')
                .select('*')
                .eq('penjualan_id', invoiceId);

            // Tampilkan ke HTML
            document.getElementById('inv-no').innerText = trx.no_invoice;
            document.getElementById('inv-date').innerText = new Date(trx.created_at).toLocaleString('id-ID');
            document.getElementById('inv-kasir').innerText = trx.kasir_log?.kasir_nama || '-';
            document.getElementById('inv-method').innerText = trx.metode_pembayaran;
            
            document.getElementById('inv-subtotal').innerText = "Rp " + trx.subtotal.toLocaleString();
            if (trx.diskon > 0) {
                document.getElementById('row-diskon').style.display = 'flex';
                document.getElementById('inv-diskon').innerText = "-Rp " + trx.diskon.toLocaleString();
            }
            document.getElementById('inv-total').innerText = "Rp " + trx.grand_total.toLocaleString();
            document.getElementById('inv-bayar').innerText = "Rp " + (trx.bayar || 0).toLocaleString();
            document.getElementById('inv-kembali').innerText = "Rp " + ((trx.bayar || 0) - trx.grand_total).toLocaleString();

            const itemsHtml = items.map(item => `
                <tr>
                    <td>${item.nama_barang}<br><small>${item.qty} x ${item.harga_satuan.toLocaleString()}</small></td>
                    <td style="text-align: right; vertical-align: bottom;">${item.subtotal_item.toLocaleString()}</td>
                </tr>
            `).join('');
            document.getElementById('inv-items').innerHTML = itemsHtml;

            // Sembunyikan loader, tampilkan nota
            document.getElementById('loader').style.display = 'none';
            document.getElementById('receipt').style.display = 'block';

        } catch (e) {
            document.getElementById('loader').innerText = e.message;
        }
    }

    loadInvoice();
</script>
</body>
</html>
