<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeautyBloom | Jurnal Umum</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e91e63; --bg: #f4f7f6; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        nav { width: 240px; background: var(--primary); color: white; padding: 20px; height: 100vh; position: fixed; }
        nav h2 { color: var(--accent); text-align: center; font-size: 20px; margin-bottom: 30px; }
        nav h2 span { color: white; font-size: 12px; display: block; opacity: 0.7; }
        nav a { color: #bdc3c7; text-decoration: none; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: block; font-size: 14px; }
        nav a:hover { background: rgba(255,255,255,0.1); color: white; }
        nav a.active { background: var(--accent); color: white; }

        main { flex: 1; margin-left: 240px; padding: 40px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .container-report { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .toolbar { display: flex; gap: 10px; margin-bottom: 25px; align-items: end; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        input[type="date"], select, .search-input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; font-size: 13px; }
        
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; font-size: 14px; transition: 0.2s; }
        .btn-filter { background: var(--accent); color: white; }
        .btn-export { background: #27ae60; color: white; }

        .badge-closing { background: #fff3e0; color: #e65100; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; border: 1px solid #ffe0b2; }
        .badge-invoice { background: #e8f5e9; color: #2e7d32; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; border: 1px solid #c8e6c9; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background: #f8f9fa; color: #7f8c8d; padding: 12px; text-align: left; border-bottom: 2px solid #eee; text-transform: uppercase; font-size: 11px; }
        td { padding: 12px; border-bottom: 1px solid #eee; color: var(--primary); vertical-align: top; }
        
        .debit-val { text-align: right; color: var(--success); font-weight: bold; }
        .kredit-val { text-align: right; color: var(--danger); font-weight: bold; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .stat-card label { display: block; font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .stat-card span { font-size: 18px; font-weight: bold; }

        .warning-box { background: #fff9db; border: 1px solid #fab005; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; display: flex; align-items: center; gap: 10px; }

        @media print {
            nav, .toolbar, .no-print { display: none !important; }
            main { margin-left: 0; padding: 0; }
            .container-report { box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body>

<nav class="no-print">
    <h2>BeautyBloom <span>Finex POS</span></h2>
    <a href="dashboard.html">üìä Dashboard</a>
    <a href="pos.html">üõí Masuk Kasir</a>
    <a href="akun_jurnal.html">üè¶ Daftar Akun</a>
    <a href="catat_jurnal.html" class="active">üìñ Jurnal Umum</a>
    <a href="laporan_laba_rugi.html">üìà Laba Rugi</a>
</nav>

<main>
    <div class="header">
        <div>
            <h2 style="margin:0;">Buku Jurnal Umum</h2>
            <p style="color: #666; font-size: 13px;">Audit Transaksi Keuangan BeautyBloom</p>
        </div>
        <div style="display: flex; gap: 10px;" class="no-print">
            <button class="btn btn-export" onclick="exportToExcel()">üì• Excel</button>
            <button class="btn" style="background:#eee" onclick="window.print()">üñ®Ô∏è Cetak</button>
        </div>
    </div>

    <div class="warning-box no-print">
        <span>‚ö†Ô∏è</span>
        <div><b>Info Duplikasi:</b> Jika total terlihat ganda, gunakan filter <b>"Sembunyikan Closing"</b> untuk hanya melihat riwayat invoice pelanggan, atau sebaliknya.</div>
    </div>

    <div class="container-report">
        <div class="toolbar no-print">
            <div class="filter-group">
                <label>DARI TANGGAL</label>
                <input type="date" id="date-from">
            </div>
            <div class="filter-group">
                <label>SAMPAI TANGGAL</label>
                <input type="date" id="date-to">
            </div>
            <div class="filter-group">
                <label>TIPE DATA</label>
                <select id="filter-type" onchange="fetchJurnal()">
                    <option value="all">Semua Transaksi</option>
                    <option value="no-closing">Hanya Invoice (Tanpa Closing)</option>
                    <option value="only-closing">Hanya Closing Shift</option>
                </select>
            </div>
            <div class="filter-group">
                <label>CARI</label>
                <input type="text" id="search-box" class="search-input" placeholder="No. Bukti..." onkeyup="filterTable()">
            </div>
            <button class="btn btn-filter" onclick="fetchJurnal()">Refresh üîÑ</button>
        </div>

        <table id="table-jurnal">
            <thead>
                <tr>
                    <th>Waktu</th>
                    <th>No. Bukti</th>
                    <th>Keterangan</th>
                    <th>Ref</th>
                    <th style="text-align: right;">Debit</th>
                    <th style="text-align: right;">Kredit</th>
                </tr>
            </thead>
            <tbody id="body-jurnal">
                <tr><td colspan="6" style="text-align:center; padding:20px;">Memuat data...</td></tr>
            </tbody>
        </table>

        <div class="summary-grid">
            <div class="stat-card">
                <label>Total Debit</label>
                <span id="total-debit" style="color:var(--success)">Rp 0</span>
            </div>
            <div class="stat-card">
                <label>Total Kredit</label>
                <span id="total-kredit" style="color:var(--danger)">Rp 0</span>
            </div>
            <div class="stat-card" style="border-left: 4px solid var(--accent)">
                <label>Saldo (D - K)</label>
                <span id="total-netto">Rp 0</span>
            </div>
        </div>
    </div>
</main>

<script>
    const SB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-from').value = today;
        document.getElementById('date-to').value = today;
        fetchJurnal();
    };

    async function fetchJurnal() {
        const from = document.getElementById('date-from').value;
        const to = document.getElementById('date-to').value;
        const filterType = document.getElementById('filter-type').value;
        
        try {
            // Ambil Nama Akun
            const { data: akunData } = await supabaseClient.from('akun').select('kode_akun, nama_akun');
            const akunMap = {};
            akunData?.forEach(a => akunMap[String(a.kode_akun)] = a.nama_akun);

            // Ambil Jurnal
            let query = supabaseClient.from('jurnal_umum').select('*')
                .gte('tanggal', from + 'T00:00:00')
                .lte('tanggal', to + 'T23:59:59')
                .order('tanggal', { ascending: true });

            const { data, error } = await query;
            if (error) throw error;

            let filteredData = data;
            
            // Logika Filtering untuk menghindari double counting
            if (filterType === 'no-closing') {
                filteredData = data.filter(item => !item.keterangan.toLowerCase().includes('closing'));
            } else if (filterType === 'only-closing') {
                filteredData = data.filter(item => item.keterangan.toLowerCase().includes('closing'));
            }

            renderTable(filteredData, akunMap);

        } catch (err) {
            console.error(err);
            document.getElementById('body-jurnal').innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Gagal memuat data.</td></tr>`;
        }
    }

    function renderTable(data, akunMap) {
        let html = '';
        let sDeb = 0, sKre = 0;

        if (data.length === 0) {
            html = '<tr><td colspan="6" style="text-align:center; padding:30px;">Data kosong.</td></tr>';
        } else {
            data.forEach(j => {
                const d = parseFloat(j.debit || 0);
                const k = parseFloat(j.kredit || 0);
                sDeb += d; sKre += k;

                const isClosing = j.keterangan.toLowerCase().includes('closing');
                const badge = isClosing ? '<span class="badge-closing">CLOSING</span>' : '<span class="badge-invoice">INVOICE</span>';

                html += `
                    <tr>
                        <td style="font-size:11px;">${new Date(j.tanggal).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}<br>${new Date(j.tanggal).toLocaleDateString('id-ID')}</td>
                        <td><code style="font-size:11px;">${j.no_bukti || '-'}</code></td>
                        <td>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <b>${j.keterangan}</b> ${badge}
                            </div>
                            <small style="color:#888">${akunMap[j.kode_akun] || 'N/A'}</small>
                        </td>
                        <td><b style="color:var(--accent)">${j.kode_akun}</b></td>
                        <td class="debit-val">${d > 0 ? d.toLocaleString() : '-'}</td>
                        <td class="kredit-val">${k > 0 ? k.toLocaleString() : '-'}</td>
                    </tr>
                `;
            });
        }

        document.getElementById('body-jurnal').innerHTML = html;
        document.getElementById('total-debit').innerText = "Rp " + sDeb.toLocaleString();
        document.getElementById('total-kredit').innerText = "Rp " + sKre.toLocaleString();
        document.getElementById('total-netto').innerText = "Rp " + (sDeb - sKre).toLocaleString();
    }

    function filterTable() {
        const q = document.getElementById('search-box').value.toLowerCase();
        const rows = document.querySelectorAll('#body-jurnal tr');
        rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none');
    }

    function exportToExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById("table-jurnal"));
        XLSX.writeFile(wb, `Jurnal_BeautyBloom.xlsx`);
    }
</script>
</body>
</html>
