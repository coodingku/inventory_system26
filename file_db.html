<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup Database Full - Finex Pos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-6">

    <div class="max-w-md w-full bg-white rounded-[2.5rem] p-8 shadow-xl text-center space-y-6 border border-slate-100">
        <div class="bg-indigo-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto">
            <i data-lucide="database-zap" class="text-indigo-600 w-10 h-10"></i>
        </div>
        
        <div>
            <h2 class="text-2xl font-black text-slate-900">Backup Real-Time</h2>
            <p class="text-slate-500 text-sm mt-2">Mengambil data langsung dari database Supabase Anda untuk dicadangkan.</p>
        </div>

        <div id="status-container" class="hidden">
            <div class="w-full bg-slate-100 rounded-full h-2 mb-2">
                <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Menyiapkan...</p>
        </div>

        <div class="space-y-3" id="button-container">
            <button onclick="startFullBackup()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all flex items-center justify-center gap-3">
                <i data-lucide="refresh-ccw" class="w-5 h-5" id="btn-icon"></i>
                Backup Data Asli
            </button>
            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest tracking-widest">Mencakup 21 Tabel & Data Riil</p>
        </div>
        
        <div class="text-left bg-slate-50 p-4 rounded-2xl border border-slate-100">
            <p class="text-[9px] font-black text-slate-400 uppercase mb-2 leading-relaxed">Penting: Pastikan koneksi internet stabil saat proses pengambilan data.</p>
        </div>
    </div>

    <script>
        // 1. KONFIGURASI SUPABASE
        // Ganti dengan URL dan Anon Key proyek Supabase Anda
        const SUPABASE_URL = 'https://your-project-url.supabase.co';
        const SUPABASE_KEY = 'your-anon-key';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const tableList = [
            'users', 'kategori', 'gudang', 'produk', 'inventory', 
            'riwayat_stok', 'riwayat_restock', 'penjualan', 
            'penjualan_detail', 'transaksi', 'detail_transaksi', 
            'pembelian', 'pengeluaran', 'kategori_akun', 'akun', 
            'jurnal', 'jurnal_umum', 'employee_staff', 'presensi', 
            'kasir_log', 'pengaturan_toko'
        ];

        async function startFullBackup() {
            const btn = document.querySelector('button');
            const statusContainer = document.getElementById('status-container');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');
            
            statusContainer.classList.remove('hidden');
            btn.disabled = true;
            btn.classList.add('opacity-50');

            let fullSql = `-- BACKUP DATA REAL-TIME FINEX POS\n`;
            fullSql += `-- Tanggal: ${new Date().toLocaleString('id-ID')}\n\n`;

            try {
                for (let i = 0; i < tableList.length; i++) {
                    const tableName = tableList[i];
                    statusText.innerText = `Mengambil Data: ${tableName}...`;
                    const percent = Math.round(((i + 1) / tableList.length) * 100);
                    progressBar.style.width = `${percent}%`;

                    // Fetch data dari Supabase
                    const { data, error } = await supabase.from(tableName).select('*');
                    
                    if (!error && data && data.length > 0) {
                        fullSql += `-- Data untuk Tabel: ${tableName}\n`;
                        
                        data.forEach(row => {
                            const keys = Object.keys(row).join(', ');
                            const values = Object.values(row).map(val => {
                                if (val === null) return 'NULL';
                                if (typeof val === 'string') return `'${val.replace(/'/g, "''")}'`;
                                if (typeof val === 'object') return `'${JSON.stringify(val)}'`;
                                return val;
                            }).join(', ');
                            
                            fullSql += `INSERT INTO ${tableName} (${keys}) VALUES (${values}) ON CONFLICT DO NOTHING;\n`;
                        });
                        fullSql += `\n`;
                    }
                }

                downloadFile(fullSql);
                alert("Backup Selesai!");
            } catch (err) {
                console.error(err);
                alert("Gagal mengambil data. Periksa konfigurasi Supabase Anda.");
            } finally {
                statusContainer.classList.add('hidden');
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        function downloadFile(content) {
            const blob = new Blob([content], { type: 'text/sql' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `FinexPos_FullBackup_${new Date().getTime()}.sql`;
            a.click();
        }

        lucide.createIcons();
    </script>
</body>
</html>
