<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finex Pos | Laporan Penjualan Detail</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e91e63; --bg: #f4f7f6; --white: #ffffff; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; background: var(--bg); }
        
        nav { width: 220px; background: var(--primary); color: white; min-height: 100vh; padding: 20px; position: fixed; z-index: 100; }
        nav h2 { border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 20px; font-size: 20px; color: var(--accent); text-align: center; }
        nav a { color: #bdc3c7; text-decoration: none; display: block; padding: 12px; border-radius: 5px; margin-bottom: 5px; font-size: 14px; transition: 0.3s; }
        nav a:hover, nav a.active { background: var(--accent); color: white; }

        main { flex: 1; margin-left: 240px; padding: 30px; width: calc(100% - 240px); }
        .filter-card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .btn-filter { background: var(--accent); color: white; }
        .btn-export { background: var(--success); color: white; }
        .btn-void { background: var(--danger); color: white; padding: 4px 8px; font-size: 11px; }

        .table-container { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #f8f9fa; padding: 10px; text-align: left; border-bottom: 2px solid #eee; color: var(--primary); white-space: nowrap; }
        td { padding: 10px; border-bottom: 1px solid #f1f1f1; vertical-align: top; }
        
        .row-main { background-color: #fff; }
        .row-item-extra { background-color: #fafafa; }
        .row-item-extra td { color: #666; padding-top: 2px; padding-bottom: 2px; border-top: none; }

        .status-void { color: #95a5a6 !important; font-style: italic; text-decoration: line-through; opacity: 0.6; }
        .method-badge { background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; text-transform: uppercase; }

        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; align-items: center; justify-content: center; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">Memproses Data...</div>

<nav>
    <h2>Finex Pos</h2>
    <a href="dashboard.html">üìä Dashboard</a>
    <a href="produk.html">üì¶ Produk</a>
    <a href="metode-pembayaran.html">üí≥ Metode Bayar</a>
    <a href="laporan-penjualan.html" class="active">üìë Laporan Penjualan</a>
    <a href="pos.html" style="background: #27ae60; color: white; text-align: center; margin-top: 20px;">üõí Masuk Kasir</a>
</nav>

<main>
    <h1>üìë Laporan Penjualan Detail - BeautyBloom</h1>
    
    <div class="filter-card">
        <div class="input-group">
            <label>Dari Tanggal</label>
            <input type="date" id="date-from">
        </div>
        <div class="input-group">
            <label>Sampai Tanggal</label>
            <input type="date" id="date-to">
        </div>
        <button class="btn-filter" onclick="fetchLaporan()">üîç Tampilkan</button>
        <button class="btn-export" onclick="exportKeExcel()">Export Excel üì•</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Tanggal/Waktu</th>
                    <th>No Bill</th>
                    <th>Metode Bayar</th>
                    <th>Detail Item</th>
                    <th>Total Kotor</th>
                    <th>Diskon</th>
                    <th>Grand Total</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="report-body"></tbody>
        </table>
    </div>
</main>

<script>
    const SB_URL = 'https://uojhjskgugghwxtdsfvm.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvamhqc2tndWdnaHd4dGRzZnZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MTQ3OTQsImV4cCI6MjA4NDE5MDc5NH0.DZ5KfYYxy8yU2k1kgb8itJ7knefgX1k5NrUOdpgN0QM';
    const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

    let activeRelationalCol = 'penjualan_id'; // Default berdasarkan info terbaru

    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-from').value = today;
        document.getElementById('date-to').value = today;
        fetchLaporan();
    };

    async function fetchLaporan() {
        const loading = document.getElementById('loading');
        loading.style.display = 'flex';

        const from = document.getElementById('date-from').value + "T00:00:00";
        const to = document.getElementById('date-to').value + "T23:59:59";

        try {
            // 1. Ambil data penjualan (Induk)
            const { data: sales, error: sErr } = await supabaseClient
                .from('penjualan')
                .select('*')
                .gte('created_at', from)
                .lte('created_at', to)
                .order('created_at', { ascending: false });

            if (sErr) throw sErr;

            // 2. Deteksi Struktur Kolom di penjualan_detail secara dinamis
            const { data: sample, error: probeErr } = await supabaseClient
                .from('penjualan_detail')
                .select('*')
                .limit(1);
            
            if (!probeErr && sample && sample.length > 0) {
                const keys = Object.keys(sample[0]);
                // Prioritas deteksi kolom relasi
                if (keys.includes('penjualan_id')) activeRelationalCol = 'penjualan_id';
                else if (keys.includes('no_invoice')) activeRelationalCol = 'no_invoice';
                else if (keys.includes('no_bukti')) activeRelationalCol = 'no_bukti';
                console.log("Relasi tabel menggunakan kolom:", activeRelationalCol);
            }

            // 3. Ambil semua detail penjualan
            const { data: details, error: dErr } = await supabaseClient
                .from('penjualan_detail')
                .select(`id, ${activeRelationalCol}, nama_barang, qty, harga_satuan, subtotal, produk_id`);
            
            if (dErr) throw dErr;

            // 4. Ambil data jurnal untuk keterangan metode pembayaran
            const { data: journals, error: jErr } = await supabaseClient
                .from('jurnal_umum')
                .select('no_bukti, keterangan')
                .gte('created_at', from)
                .lte('created_at', to);

            renderTable(sales, details, journals || []);
        } catch (err) {
            console.error(err);
            alert("Terjadi kesalahan: " + err.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    function renderTable(sales, allDetails, journals) {
        const body = document.getElementById('report-body');
        body.innerHTML = '';

        if (sales.length === 0) {
            body.innerHTML = '<tr><td colspan="9" style="text-align:center">Data tidak ditemukan untuk periode ini.</td></tr>';
            return;
        }

        sales.forEach(sale => {
            const isVoid = sale.status === 'Void';
            
            // Cocokkan no_invoice (Penjualan) dengan penjualan_id/no_invoice (Detail)
            const details = allDetails.filter(d => 
                String(d[activeRelationalCol]) === String(sale.no_invoice) || 
                String(d[activeRelationalCol]) === String(sale.id)
            );
            
            const journalMatch = journals.find(j => j.no_bukti === sale.no_invoice);
            let metode = journalMatch ? journalMatch.keterangan : 'Tunai';
            metode = metode.replace(/^Terima\s+/i, '').replace(/\s*-\s*INV-\d+/gi, '').trim();

            const firstItem = details.length > 0 ? details[0] : { nama_barang: 'Item tidak ditemukan', qty: 0 };

            let mainRow = `
                <tr class="row-main ${isVoid ? 'status-void' : ''}">
                    <td>${new Date(sale.created_at).toLocaleString('id-ID')}</td>
                    <td><b>${sale.no_invoice}</b></td>
                    <td><span class="method-badge">${metode}</span></td>
                    <td>${firstItem.nama_barang} (x${firstItem.qty})</td>
                    <td>Rp ${parseFloat(sale.subtotal || 0).toLocaleString()}</td>
                    <td style="color:red">Rp ${parseFloat(sale.diskon || 0).toLocaleString()}</td>
                    <td style="font-weight:bold">Rp ${parseFloat(sale.grand_total || 0).toLocaleString()}</td>
                    <td>${sale.status || 'Success'}</td>
                    <td>
                        ${!isVoid ? `<button class="btn-void" onclick="processVoid('${sale.no_invoice}')">Void</button>` : '-'}
                    </td>
                </tr>
            `;
            body.innerHTML += mainRow;

            // Tampilkan baris tambahan jika item lebih dari 1
            if (details.length > 1) {
                for (let i = 1; i < details.length; i++) {
                    const extra = details[i];
                    body.innerHTML += `
                        <tr class="row-item-extra ${isVoid ? 'status-void' : ''}">
                            <td></td><td></td><td></td>
                            <td>${extra.nama_barang} (x${extra.qty})</td>
                            <td></td><td></td><td></td><td></td><td></td>
                        </tr>
                    `;
                }
            }
        });
    }

    async function processVoid(inv) {
        if(!confirm(`Yakin ingin membatalkan (Void) transaksi ${inv}?`)) return;
        
        const loading = document.getElementById('loading');
        loading.style.display = 'flex';

        try {
            // Ambil detail item untuk koreksi stok
            const { data: details } = await supabaseClient
                .from('penjualan_detail')
                .select('produk_id, qty')
                .eq(activeRelationalCol, inv);
            
            if(details) {
                for (const item of details) {
                    if (item.produk_id) {
                        const { data: p } = await supabaseClient.from('produk').select('stok').eq('id', item.produk_id).single();
                        if(p) {
                            await supabaseClient.from('produk').update({ stok: parseFloat(p.stok) + parseFloat(item.qty) }).eq('id', item.produk_id);
                        }
                    }
                }
            }

            // Update status transaksi
            await supabaseClient.from('penjualan').update({ status: 'Void' }).eq('no_invoice', inv);
            await supabaseClient.from('jurnal_umum').update({ keterangan: 'VOID - ' + inv }).eq('no_bukti', inv);

            alert("Transaksi berhasil dibatalkan.");
            fetchLaporan();
        } catch (e) {
            alert("Error Void: " + e.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    function exportKeExcel() {
        const table = document.querySelector("table");
        const wb = XLSX.utils.table_to_book(table, { sheet: "Detail Penjualan" });
        XLSX.writeFile(wb, "Laporan_Detail_BeautyBloom.xlsx");
    }
</script>
</body>
</html>
