<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Finex Pos | Pengaturan Lokasi Presisi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="supabase-init.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 20px; max-width: 450px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        h2 { color: var(--primary); margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        .geo-btn { 
            background: #ebf5ff; color: var(--accent); border: 2px dashed var(--accent); 
            padding: 15px; width: 100%; border-radius: 12px; cursor: pointer; 
            font-weight: bold; margin-bottom: 20px; transition: 0.3s;
        }
        .geo-btn:hover { background: var(--accent); color: white; border-style: solid; }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: bold; color: #666; margin-bottom: 5px; }
        input { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
            box-sizing: border-box; font-size: 15px; background: #fafafa;
        }
        
        .btn-save { 
            background: var(--success); color: white; border: none; padding: 15px; 
            width: 100%; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px;
            margin-top: 10px; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        .btn-save:active { transform: scale(0.98); }

        #status-gps { font-size: 12px; text-align: center; margin-top: -10px; margin-bottom: 15px; color: #888; }
        .divider { height: 1px; background: #eee; margin: 20px 0; position: relative; }
        .divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; font-size: 12px; color: #aaa; }
    </style>
</head>
<body>

<div class="card">
    <h2>üìç Titik Pusat Absensi</h2>
    <p style="font-size: 14px; color: #7f8c8d; margin-bottom: 25px;">Tentukan koordinat utama agar staff hanya bisa absen di area ini.</p>
    
    <button class="geo-btn" onclick="getCurrentLocation()">
        üéØ Gunakan Lokasi Saya Sekarang
    </button>
    <div id="status-gps">Pastikan GPS perangkat Anda aktif</div>

    <div class="divider"><span>ATAU MASUKKAN MANUAL</span></div>

    <div class="input-group">
        <label>Latitude</label>
        <input type="number" id="lat" step="any" placeholder="-6.xxxxxx">
    </div>
    
    <div class="input-group">
        <label>Longitude</label>
        <input type="number" id="lon" step="any" placeholder="106.xxxxxx">
    </div>
    
    <div class="input-group">
        <label>Radius Keamanan (Meter)</label>
        <input type="number" id="radius" placeholder="Contoh: 50">
        <small style="color: #999; font-size: 11px;">Jarak toleransi maksimal dari titik pusat.</small>
    </div>
    
    <button class="btn-save" onclick="simpanLokasi()">üíæ SIMPAN PENGATURAN</button>
    <p id="msg" style="text-align:center; font-size: 14px; margin-top: 15px;"></p>
    
    <center>
        <a href="dashboard.html" style="text-decoration:none; font-size:12px; color:#999;">‚Üê Kembali ke Dashboard</a>
    </center>
</div>

<script>
    // Variabel 'db' disediakan secara dinamis oleh supabase-init.js

    // Muat data saat ini dari database pelanggan
    window.onload = async () => {
        const { data, error } = await db.from('pengaturan_toko').select('*').eq('id', 1).maybeSingle();
        if (data) {
            document.getElementById('lat').value = data.latitude || "";
            document.getElementById('lon').value = data.longitude || "";
            document.getElementById('radius').value = data.radius_meter || 50;
        }
    };

    // Fungsi Ambil Lokasi Saat Ini
    function getCurrentLocation() {
        const status = document.getElementById('status-gps');
        const btn = document.querySelector('.geo-btn');

        if (!navigator.geolocation) {
            alert("Geolocation tidak didukung oleh browser Anda");
            return;
        }

        btn.innerText = "‚è≥ Mendeteksi...";
        status.innerText = "Mohon tunggu, sedang mengunci GPS...";

        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            document.getElementById('lat').value = lat;
            document.getElementById('lon').value = lon;
            
            btn.innerText = "üéØ Lokasi Terdeteksi!";
            status.innerHTML = `<span style="color:var(--success)">Akurasi: ¬±${Math.round(accuracy)} meter</span>`;
            
            setTimeout(() => {
                btn.innerText = "üéØ Gunakan Lokasi Saya Sekarang";
            }, 3000);

        }, (error) => {
            alert("Gagal mengambil lokasi: " + error.message);
            btn.innerText = "üéØ Gunakan Lokasi Saya Sekarang";
            status.innerText = "Pastikan izin lokasi diberikan.";
        }, { enableHighAccuracy: true });
    }

    async function simpanLokasi() {
        const msg = document.getElementById('msg');
        const payload = {
            latitude: parseFloat(document.getElementById('lat').value),
            longitude: parseFloat(document.getElementById('lon').value),
            radius_meter: parseInt(document.getElementById('radius').value) || 50
        };

        // Update ke database pelanggan yang aktif
        const { error } = await db.from('pengaturan_toko').update(payload).eq('id', 1);

        if (!error) {
            msg.innerText = "‚úÖ Pengaturan Berhasil Disimpan!";
            msg.style.color = "green";
            setTimeout(() => { msg.innerText = ""; }, 3000);
        } else {
            msg.innerText = "‚ùå Gagal: " + error.message;
            msg.style.color = "red";
        }
    }
</script>
</body>
</html>
